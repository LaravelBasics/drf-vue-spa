# ã‚³ãƒ¼ãƒ‰è§£æã‚¬ã‚¤ãƒ‰ï¼ˆè«–ç†å‰Šé™¤ãƒ»èªè¨¼ãƒ»ãƒ†ã‚¹ãƒˆï¼‰

> **å¯¾è±¡è€…**: å®Ÿéš›ã®ã‚³ãƒ¼ãƒ‰ã‚’èª­ã‚“ã§ç†è§£ã‚’æ·±ã‚ãŸã„æ–¹  
> **ã‚¢ãƒ—ãƒ­ãƒ¼ãƒ**: ã‚³ãƒ¼ãƒ‰ã®è¦‹æ–¹ã¨æ¥­ç•Œæ¨™æº–ã®å®Ÿè£…ãƒ‘ã‚¿ãƒ¼ãƒ³

---

## ğŸ“– ç›®æ¬¡

1. [è«–ç†å‰Šé™¤ãƒ‘ã‚¿ãƒ¼ãƒ³](#è«–ç†å‰Šé™¤ãƒ‘ã‚¿ãƒ¼ãƒ³)
2. [Model ã®è¦‹æ–¹](#model-ã®è¦‹æ–¹)
3. [Serializer ã®è¦‹æ–¹](#serializer-ã®è¦‹æ–¹)
4. [ViewSet vs APIView ã®ä½¿ã„åˆ†ã‘](#viewset-vs-apiview-ã®ä½¿ã„åˆ†ã‘)
5. [Service ã‚¯ãƒ©ã‚¹ã®è¦‹æ–¹](#service-ã‚¯ãƒ©ã‚¹ã®è¦‹æ–¹)
6. [ã‚»ãƒƒã‚·ãƒ§ãƒ³èªè¨¼ã®ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ç¢ºèª](#ã‚»ãƒƒã‚·ãƒ§ãƒ³èªè¨¼ã®ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ç¢ºèª)
7. [ãƒ†ã‚¹ãƒˆã‚³ãƒ¼ãƒ‰ã®æ›¸ãæ–¹](#ãƒ†ã‚¹ãƒˆã‚³ãƒ¼ãƒ‰ã®æ›¸ãæ–¹)

---

## è«–ç†å‰Šé™¤ãƒ‘ã‚¿ãƒ¼ãƒ³

### ğŸ¯ è«–ç†å‰Šé™¤ã¨ã¯ï¼Ÿ

ã‚½ãƒ•ãƒˆãƒ‡ãƒªãƒ¼ã‚·ãƒ§ãƒ³ã¯ã€ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‹ã‚‰å®Ÿéš›ã«ãƒ¬ã‚³ãƒ¼ãƒ‰ã‚’å‰Šé™¤ã™ã‚‹ã®ã§ã¯ãªãã€å˜ç´”ã«ã€Œå‰Šé™¤æ¸ˆã¿ã€ã¨ã—ã¦ãƒãƒ¼ã‚¯ã™ã‚‹å¼·åŠ›ãªã‚½ãƒ•ãƒˆã‚¦ã‚§ã‚¢ãƒ‘ã‚¿ãƒ¼ãƒ³ã§ã€ãƒ‡ãƒ¼ã‚¿ä¿å­˜ã¨å¾©å…ƒã€å±¥æ­´è¿½è·¡ã€éšœå®³ã‹ã‚‰ã®é«˜é€Ÿå¾©æ—§ãªã©ã®ãƒ¡ãƒªãƒƒãƒˆãŒã‚ã‚‹

```
ã€ç‰©ç†å‰Šé™¤ï¼ˆHard Deleteï¼‰ã€‘
DELETE FROM users WHERE id = 1
â†’ ãƒ‡ãƒ¼ã‚¿ãŒå®Œå…¨ã«æ¶ˆãˆã‚‹ï¼ˆå¾©æ—§ä¸å¯èƒ½ï¼‰

ã€è«–ç†å‰Šé™¤ï¼ˆSoft Deleteï¼‰ã€‘
UPDATE users SET deleted_at = NOW() WHERE id = 1
â†’ ãƒ‡ãƒ¼ã‚¿ã¯æ®‹ã‚‹ï¼ˆå¾©æ—§å¯èƒ½ï¼‰
```

**æ¥­ç•Œæ¨™æº–ã®ãƒ‘ã‚¿ãƒ¼ãƒ³:**

| ãƒ‘ã‚¿ãƒ¼ãƒ³ | å®Ÿè£…æ–¹æ³• | ãƒ¡ãƒªãƒƒãƒˆ | ãƒ‡ãƒ¡ãƒªãƒƒãƒˆ |
|---------|---------|---------|----------|
| **deleted_at** | ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ— | å‰Šé™¤æ—¥æ™‚ãŒã‚ã‹ã‚‹ | ã‚¯ã‚¨ãƒªã«æ¡ä»¶è¿½åŠ ãŒå¿…è¦ |
| **is_deleted** | ãƒ–ãƒ¼ãƒ«ãƒ•ãƒ©ã‚° | ã‚·ãƒ³ãƒ—ãƒ« | å‰Šé™¤æ—¥æ™‚ãŒä¸æ˜ |
| **ä¸¡æ–¹** | deleted_at + is_deleted | é«˜é€Ÿãªã‚¯ã‚¨ãƒª | ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰æ•°ãŒå¢—ãˆã‚‹ |

ã“ã®ã‚·ã‚¹ãƒ†ãƒ ã§ã¯ **deleted_at ã®ã¿** ã‚’æ¡ç”¨

### ğŸ“Š ã‚ãªãŸã®ã‚³ãƒ¼ãƒ‰ã®å®Ÿè£…

**models.py ã®è¨­è¨ˆ:**

```python
class User(AbstractBaseUser, PermissionsMixin):
    # å‰Šé™¤æ—¥æ™‚ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰
    deleted_at = models.DateTimeField(
        "å‰Šé™¤æ—¥æ™‚", 
        blank=True, 
        null=True  # NULL = ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã€å€¤ã‚ã‚Š = å‰Šé™¤æ¸ˆã¿
    )
    
    # æ¡ä»¶ä»˜ããƒ¦ãƒ‹ãƒ¼ã‚¯åˆ¶ç´„
    class Meta:
        constraints = [
            models.UniqueConstraint(
                fields=["employee_id"],
                condition=models.Q(deleted_at__isnull=True),
                name="unique_active_employee_id",
            )
        ]
```

**å›³è§£:**

```
ã€ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®çŠ¶æ…‹ã€‘

â”Œâ”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ id â”‚employeeâ”‚username â”‚ deleted_at â”‚ çŠ¶æ…‹
â”œâ”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 1  â”‚ 9999   â”‚ ç®¡ç†è€…  â”‚ NULL       â”‚ ã‚¢ã‚¯ãƒ†ã‚£ãƒ–
â”‚ 2  â”‚ 1234   â”‚ å¤ªéƒ    â”‚ NULL       â”‚ ã‚¢ã‚¯ãƒ†ã‚£ãƒ–
â”‚ 3  â”‚ 5678   â”‚ èŠ±å­    â”‚ 2025-11-18 â”‚ å‰Šé™¤æ¸ˆã¿ â†
â””â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ã€æ¡ä»¶ä»˜ããƒ¦ãƒ‹ãƒ¼ã‚¯åˆ¶ç´„ã®å‹•ä½œã€‘

employee_id = "1234" ã‹ã¤ deleted_at IS NULL
â†’ ä¸€æ„åˆ¶ç´„ãŒåƒãï¼ˆé‡è¤‡ä¸å¯ï¼‰

employee_id = "1234" ã‹ã¤ deleted_at IS NOT NULL
â†’ ä¸€æ„åˆ¶ç´„ã®å¯¾è±¡å¤–ï¼ˆé‡è¤‡å¯èƒ½ï¼‰

â†’ é€€è·ã—ãŸç¤¾å“¡ã®ç•ªå·ã‚’æ–°å…¥ç¤¾å“¡ã«å†åˆ©ç”¨ã§ãã‚‹ï¼
```

### ğŸ”§ ã‚«ã‚¹ã‚¿ãƒ ãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼

Djangoã§ã¯ã€`deleted_at`ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’è¿½åŠ ã—ã€ã‚«ã‚¹ã‚¿ãƒ ãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼ã§ã‚¯ã‚¨ãƒªã‚»ãƒƒãƒˆã‚’ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ã™ã‚‹ã“ã¨ã§ã€è«–ç†å‰Šé™¤ã‚’å®Ÿè£…ã§ãã‚‹

```python
class CustomUserManager(BaseUserManager):
    """è«–ç†å‰Šé™¤å¯¾å¿œãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼(å‰Šé™¤æ¸ˆã¿é™¤å¤–)"""
    
    def get_queryset(self):
        # å¸¸ã« deleted_at IS NULL ã®æ¡ä»¶ã‚’è¿½åŠ 
        return super().get_queryset().filter(deleted_at__isnull=True)

class AllObjectsManager(BaseUserManager):
    """å…¨ãƒ¬ã‚³ãƒ¼ãƒ‰å–å¾—ãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼(å‰Šé™¤æ¸ˆã¿å«ã‚€)"""
    
    def get_queryset(self):
        # æ¡ä»¶ãªã—ï¼ˆã™ã¹ã¦å–å¾—ï¼‰
        return super().get_queryset()
```

**ä½¿ã„åˆ†ã‘:**

```python
# é€šå¸¸ã®æ“ä½œï¼ˆå‰Šé™¤æ¸ˆã¿é™¤å¤–ï¼‰
User.objects.all()
â†’ SELECT * FROM users WHERE deleted_at IS NULL

# å‰Šé™¤æ¸ˆã¿ã‚‚å«ã‚ã‚‹
User.all_objects.all()
â†’ SELECT * FROM users

# å‰Šé™¤æ¸ˆã¿ã®ã¿
User.all_objects.filter(deleted_at__isnull=False)
â†’ SELECT * FROM users WHERE deleted_at IS NOT NULL
```

### âš ï¸ é‡è¦ãªæ³¨æ„ç‚¹

ã‚«ã‚¹ã‚¿ãƒ ãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼ã‚’ã‚ªãƒ¼ãƒãƒ¼ãƒ©ã‚¤ãƒ‰ã™ã‚‹éš›ã¯ã€QuerySetãƒ¬ãƒ™ãƒ«ã§ä¸€æ‹¬å‰Šé™¤ã®å‹•ä½œã‚’æ­£ã—ãå®Ÿè£…ã—ãªã„ã¨ã€ãƒ¢ãƒ‡ãƒ«ã®delete()ãƒ¡ã‚½ãƒƒãƒ‰ãŒãƒã‚¤ãƒ‘ã‚¹ã•ã‚Œã‚‹å ´åˆãŒã‚ã‚‹

```python
# âŒ å±é™º: ä¸€æ‹¬å‰Šé™¤ã§ãƒ¢ãƒ‡ãƒ«ã®delete()ãŒãƒã‚¤ãƒ‘ã‚¹ã•ã‚Œã‚‹
User.objects.filter(is_admin=False).delete()
â†’ ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ã¯ç‰©ç†å‰Šé™¤ã•ã‚Œã‚‹ï¼

# âœ… å®‰å…¨: ã‚«ã‚¹ã‚¿ãƒ QuerySetã§å¯¾å¿œ
class SoftDeleteQuerySet(models.QuerySet):
    def delete(self):
        # ä¸€æ‹¬æ›´æ–°ã«å¤‰æ›´
        return self.update(deleted_at=timezone.now())
    
    def hard_delete(self):
        # ç‰©ç†å‰Šé™¤ç”¨ã®ãƒ¡ã‚½ãƒƒãƒ‰ã‚’åˆ¥é€”ç”¨æ„
        return super().delete()
```

**ã‚ãªãŸã®ã‚³ãƒ¼ãƒ‰ã§ã®å¯¾å¿œ:**

```python
def soft_delete(self):
    """è«–ç†å‰Šé™¤(1å›ã®SQLã§å®Œçµ)"""
    self.deleted_at = timezone.now()
    self.is_active = False
    self.save(update_fields=["deleted_at", "is_active"])
```

â†’ **å€‹åˆ¥å‰Šé™¤ã®ã¿å¯¾å¿œ**ï¼ˆä¸€æ‹¬å‰Šé™¤ã¯ ViewSet ã§åˆ¶å¾¡ï¼‰

---

## Model ã®è¦‹æ–¹

### ğŸ¯ Model ã®å½¹å‰²

**ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒ†ãƒ¼ãƒ–ãƒ«ã®è¨­è¨ˆå›³**

### ğŸ“Š ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®èª­ã¿æ–¹

```python
employee_id = models.CharField(
    "ç¤¾å“¡ç•ªå·",           # ç®¡ç†ç”»é¢ã§ã®è¡¨ç¤ºå
    max_length=50,       # æœ€å¤§æ–‡å­—æ•°
    unique=False,        # ãƒ¦ãƒ‹ãƒ¼ã‚¯åˆ¶ç´„ãªã—ï¼ˆæ¡ä»¶ä»˜ãåˆ¶ç´„ã‚’ä½¿ç”¨ï¼‰
    db_index=True,       # ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ä½œæˆï¼ˆæ¤œç´¢é«˜é€ŸåŒ–ï¼‰
)
```

**é‡è¦ãªãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚ªãƒ—ã‚·ãƒ§ãƒ³:**

| ã‚ªãƒ—ã‚·ãƒ§ãƒ³ | æ„å‘³ | ä½¿ã„ã©ã“ã‚ |
|-----------|------|-----------|
| `null=True` | ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã§NULLè¨±å¯ | å‰Šé™¤æ—¥æ™‚ãªã© |
| `blank=True` | ãƒ•ã‚©ãƒ¼ãƒ ã§ç©ºæ¬„è¨±å¯ | å¿…é ˆã§ãªã„é …ç›® |
| `default=` | ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ | is_active=True |
| `db_index=True` | ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ä½œæˆ | æ¤œç´¢ãŒå¤šã„ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ |
| `unique=True` | ä¸€æ„åˆ¶ç´„ | ç¤¾å“¡ç•ªå·ãªã© |

### ğŸ”— Meta ã‚¯ãƒ©ã‚¹ã®èª­ã¿æ–¹

```python
class Meta:
    db_table = "users"  # ãƒ†ãƒ¼ãƒ–ãƒ«åã‚’æ˜ç¤º
    ordering = ["-created_at"]  # ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®ä¸¦ã³é †
    
    # æ¡ä»¶ä»˜ããƒ¦ãƒ‹ãƒ¼ã‚¯åˆ¶ç´„
    constraints = [
        models.UniqueConstraint(
            fields=["employee_id"],
            condition=models.Q(deleted_at__isnull=True),
            name="unique_active_employee_id",
        )
    ]
    
    # ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹è¨­è¨ˆ
    indexes = [
        models.Index(fields=["employee_id"]),
        models.Index(fields=["is_active"]),
        models.Index(fields=["deleted_at"]),
        # è¤‡åˆã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ï¼ˆç®¡ç†è€…ã‚«ã‚¦ãƒ³ãƒˆã‚¯ã‚¨ãƒªç”¨ï¼‰
        models.Index(
            fields=["deleted_at", "is_admin", "is_active"],
            name="users_admin_count_idx",
        ),
    ]
```

**ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹è¨­è¨ˆã®è€ƒãˆæ–¹:**

```
ã€å˜ä¸€ã‚«ãƒ©ãƒ ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã€‘
WHERE employee_id = '9999'
â†’ Index(fields=["employee_id"])

ã€è¤‡åˆã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã€‘
WHERE deleted_at IS NULL 
  AND is_admin = TRUE 
  AND is_active = TRUE
â†’ Index(fields=["deleted_at", "is_admin", "is_active"])

ã€é‡è¦ã€‘
ãƒ»æœ€ã‚‚é¸æŠæ€§ã®é«˜ã„ã‚«ãƒ©ãƒ ã‚’å…ˆé ­ã«
ãƒ»WHEREå¥ã§ã®ä½¿ç”¨é »åº¦ãŒé«˜ã„çµ„ã¿åˆã‚ã›
```

### ğŸ¨ ãƒ¡ã‚½ãƒƒãƒ‰ã®èª­ã¿æ–¹

```python
def soft_delete(self):
    """è«–ç†å‰Šé™¤(1å›ã®SQLã§å®Œçµ)"""
    self.deleted_at = timezone.now()
    self.is_active = False
    # update_fields ã§æ›´æ–°ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’æ˜ç¤º
    self.save(update_fields=["deleted_at", "is_active"])
```

**update_fields ã®åŠ¹æœ:**

```sql
# update_fields ãªã—
UPDATE users SET 
    employee_id = '9999',
    username = 'ç®¡ç†è€…',
    email = 'admin@example.com',
    is_admin = true,
    is_active = false,  â† ã“ã“ã ã‘å¤‰ãˆãŸã„ã®ã«
    deleted_at = '2025-11-18 10:00:00',
    updated_at = '2025-11-18 10:00:00'
WHERE id = 1;

# update_fields ã‚ã‚Š
UPDATE users SET 
    is_active = false,
    deleted_at = '2025-11-18 10:00:00'
WHERE id = 1;
â†’ å¿…è¦æœ€å°é™ã®ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®ã¿æ›´æ–°ï¼ˆé«˜é€Ÿï¼†å®‰å…¨ï¼‰
```

---

## Serializer ã®è¦‹æ–¹

### ğŸ¯ Serializer ã®å½¹å‰²

**Python ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ â‡” JSON ã®å¤‰æ› + ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³**

### ğŸ“Š ã‚ãªãŸã®ã‚³ãƒ¼ãƒ‰ã®æ§‹é€ 

```python
class UserSerializer(serializers.ModelSerializer):
    """ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±å–å¾—ç”¨ï¼ˆèª­ã¿å–ã‚Šå°‚ç”¨ï¼‰"""
    
    display_name = serializers.CharField(read_only=True)
    
    class Meta:
        model = User
        fields = [
            "id",
            "employee_id",
            "username",
            "email",
            "display_name",
            "is_admin",
            "is_active",
            "created_at",
            "updated_at",
        ]
        read_only_fields = ["id", "created_at", "updated_at"]
```

**å›³è§£:**

```
ã€ãƒ¬ã‚¹ãƒãƒ³ã‚¹æ™‚ã€‘
User ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ
   â†“ UserSerializer
{
  "id": 1,
  "employee_id": "9999",
  "username": "ç®¡ç†è€…",
  "email": "admin@example.com",
  "display_name": "ç®¡ç†è€…",  â† @property ã‹ã‚‰å–å¾—
  "is_admin": true,
  "is_active": true,
  "created_at": "2025-11-18T10:00:00Z",
  "updated_at": "2025-11-18T10:00:00Z"
}
```

### ğŸ” BaseUserSerializer ãƒ‘ã‚¿ãƒ¼ãƒ³

```python
class BaseUserSerializer(serializers.ModelSerializer):
    """å…±é€šãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ç”¨ãƒ™ãƒ¼ã‚¹ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚¶ãƒ¼"""
    
    def validate_employee_id(self, value):
        """ç¤¾å“¡ç•ªå·ã®æ­£è¦åŒ–ï¼ˆç©ºç™½å‰Šé™¤ï¼‰"""
        return value.strip() if value else value
    
    def validate_email(self, value):
        """ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹æ­£è¦åŒ–ï¼ˆå°æ–‡å­—å¤‰æ›ï¼‰"""
        return value.strip().lower() if value else None
```

**DRFã®ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³å®Ÿè¡Œé †åº:**

DRFã®ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚¶ã¯ã€is_valid()ã‚’å‘¼ã³å‡ºã™ã¨ã€ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’Pythonã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã«å¤‰æ›ã—ã€validate_<field_name>ã‚’å®Ÿè¡Œã—ã€ãã®å¾Œvalidatorså±æ€§ã®ãƒãƒªãƒ‡ãƒ¼ã‚¿ã‚’å®Ÿè¡Œã—ã€æœ€å¾Œã«validate()ãƒ¡ã‚½ãƒƒãƒ‰ã‚’å®Ÿè¡Œã™ã‚‹

```
is_valid() å‘¼ã³å‡ºã—
   â†“
â‘  ãƒ‡ãƒ¼ã‚¿å‹å¤‰æ›ï¼ˆæ–‡å­—åˆ— â†’ æ•´æ•°ãªã©ï¼‰
   â†“
â‘¡ validate_<field_name>() å®Ÿè¡Œ
   ä¾‹: validate_employee_id()
   â†“
â‘¢ validators=[] ã®é–¢æ•°ã‚’å®Ÿè¡Œ
   ä¾‹: UniqueValidator
   â†“
â‘£ validate() ãƒ¡ã‚½ãƒƒãƒ‰å®Ÿè¡Œ
   å…¨ä½“ã®ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
   â†“
ã™ã¹ã¦æˆåŠŸ â†’ validated_data ã«ä¿å­˜
1ã¤ã§ã‚‚å¤±æ•— â†’ ValidationError
```

### ğŸ¨ ä½œæˆç”¨ã¨æ›´æ–°ç”¨ã®åˆ†é›¢

```python
class UserCreateSerializer(BaseUserSerializer):
    """ãƒ¦ãƒ¼ã‚¶ãƒ¼ä½œæˆç”¨"""
    
    password = serializers.CharField(
        write_only=True,      # ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã«å«ã‚ãªã„
        required=True,        # å¿…é ˆ
        min_length=8,         # 8æ–‡å­—ä»¥ä¸Š
        max_length=128,
    )
    
    employee_id = serializers.CharField(
        required=True,
        validators=[EMPLOYEE_ID_UNIQUE_VALIDATOR],  # ä¸€æ„æ€§ãƒã‚§ãƒƒã‚¯
    )

class UserUpdateSerializer(BaseUserSerializer):
    """ãƒ¦ãƒ¼ã‚¶ãƒ¼æ›´æ–°ç”¨"""
    
    password = serializers.CharField(
        write_only=True,
        required=False,       # ä»»æ„ï¼ˆå¤‰æ›´æ™‚ã®ã¿ï¼‰
        allow_blank=True,     # ç©ºæ¬„è¨±å¯
        min_length=8,
    )
    
    def validate_password(self, value):
        """ç©ºç™½ã®ã¿ã¯å¤‰æ›´ãªã—"""
        return value.strip() if value and value.strip() else None
```

**ãªãœåˆ†ã‘ã‚‹ï¼Ÿ**

```
ã€ä½œæˆæ™‚ã€‘
ãƒ»password ã¯å¿…é ˆ
ãƒ»employee_id ã®ä¸€æ„æ€§ãƒã‚§ãƒƒã‚¯
ãƒ»ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã®è¨­å®š

ã€æ›´æ–°æ™‚ã€‘
ãƒ»password ã¯ä»»æ„ï¼ˆå¤‰æ›´æ™‚ã®ã¿ï¼‰
ãƒ»employee_id ã®ä¸€æ„æ€§ãƒã‚§ãƒƒã‚¯ï¼ˆè‡ªåˆ†ä»¥å¤–ï¼‰
ãƒ»æ—¢å­˜å€¤ã®ä¿æŒ
```

---

## ViewSet vs APIView ã®ä½¿ã„åˆ†ã‘

### ğŸ¯ ã‚ãªãŸã®ã‚³ãƒ¼ãƒ‰ã§ã®ä½¿ã„åˆ†ã‘

```
ã€ViewSet ã‚’ä½¿ç”¨ã€‘
users/views.py - UserViewSet
â†’ æ¨™æº–çš„ãªCRUDæ“ä½œ

ã€APIView ã‚’ä½¿ç”¨ã€‘
accounts/views.py - LoginAPIView, LogoutAPIView
â†’ ã‚«ã‚¹ã‚¿ãƒ ãªãƒ“ã‚¸ãƒã‚¹ãƒ­ã‚¸ãƒƒã‚¯
```

### ğŸ“Š å®Ÿè£…ã®é•ã„

**ViewSetï¼ˆCRUDè‡ªå‹•ç”Ÿæˆï¼‰:**

```python
class UserViewSet(viewsets.ModelViewSet):
    queryset = User.objects.all()
    serializer_class = UserSerializer
    
    # ã“ã‚Œã ã‘ã§ä»¥ä¸‹ãŒè‡ªå‹•ç”Ÿæˆ:
    # - list()    GET /api/users/
    # - create()  POST /api/users/
    # - retrieve() GET /api/users/1/
    # - update()  PUT /api/users/1/
    # - destroy() DELETE /api/users/1/
```

**APIViewï¼ˆã‚«ã‚¹ã‚¿ãƒ ãƒ­ã‚¸ãƒƒã‚¯ï¼‰:**

```python
class LoginAPIView(APIView):
    permission_classes = [AllowAny]
    
    def post(self, request):
        # ã‚«ã‚¹ã‚¿ãƒ ãªãƒ­ã‚°ã‚¤ãƒ³å‡¦ç†
        # ãƒ»ãƒ–ãƒ«ãƒ¼ãƒˆãƒ•ã‚©ãƒ¼ã‚¹æ”»æ’ƒå¯¾ç­–
        # ãƒ»å¤±æ•—å›æ•°ã®ã‚«ã‚¦ãƒ³ãƒˆ
        # ãƒ»ã‚¢ã‚«ã‚¦ãƒ³ãƒˆãƒ­ãƒƒã‚¯
        ...
```

### ğŸ” ã‚ãªãŸã®ã‚³ãƒ¼ãƒ‰ã®è©³ç´°åˆ†æ

**UserViewSet ã®å·¥å¤«:**

```python
def get_queryset(self):
    """ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã«å¿œã˜ã¦ã‚¯ã‚¨ãƒªã‚»ãƒƒãƒˆã‚’å‹•çš„ã«å¤‰æ›´"""
    
    if self.action == "retrieve":
        # è©³ç´°å–å¾—æ™‚ã¯å‰Šé™¤æ¸ˆã¿ã‚‚å«ã‚ã‚‹
        return User.all_objects.all()
    
    # ä¸€è¦§å–å¾—æ™‚ã¯å‰Šé™¤æ¸ˆã¿ã‚’é™¤å¤–
    return super().get_queryset()
```

**ãªãœ retrieve ã§å‰Šé™¤æ¸ˆã¿ã‚‚å–å¾—ï¼Ÿ**

```
ã€ã‚·ãƒŠãƒªã‚ªã€‘
â‘  ãƒ¦ãƒ¼ã‚¶ãƒ¼AãŒãƒ–ãƒ©ã‚¦ã‚¶Aã§ãƒ¦ãƒ¼ã‚¶ãƒ¼è©³ç´°ç”»é¢ã‚’é–‹ã
â‘¡ ãƒ¦ãƒ¼ã‚¶ãƒ¼BãŒãƒ–ãƒ©ã‚¦ã‚¶Bã§åŒã˜ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’å‰Šé™¤
â‘¢ ãƒ¦ãƒ¼ã‚¶ãƒ¼AãŒãƒ–ãƒ©ã‚¦ã‚¶Aã§ã€Œç·¨é›†ã€ãƒœã‚¿ãƒ³ã‚’æŠ¼ã™

ã€retrieve ã§å‰Šé™¤æ¸ˆã¿ã‚’é™¤å¤–ã™ã‚‹ã¨ã€‘
â†’ 404 Not Foundï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ï¼‰
â†’ ãƒ¦ãƒ¼ã‚¶ãƒ¼Aã¯æ··ä¹±...

ã€retrieve ã§å‰Šé™¤æ¸ˆã¿ã‚‚å–å¾—ã™ã‚‹ã¨ã€‘
â†’ 200 OK â†’ å‰Šé™¤æ¸ˆã¿ãƒã‚§ãƒƒã‚¯
â†’ æ˜ç¢ºãªã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
  ã€Œã“ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯å‰Šé™¤ã•ã‚Œã¦ã„ã¾ã™ã€
```

**åŒæ™‚æ“ä½œå¯¾ç­–:**

```python
def update(self, request, *args, **kwargs):
    # all_objectsã§å–å¾—ï¼ˆå‰Šé™¤æ¸ˆã¿ã‚‚å«ã‚ã‚‹ï¼‰
    try:
        instance = User.all_objects.get(pk=self.kwargs["pk"])
    except User.DoesNotExist:
        raise UserNotFoundError()
    
    # å‰Šé™¤æ¸ˆã¿ãƒã‚§ãƒƒã‚¯
    if instance.deleted_at:
        raise DeletedUserAccessError()
    
    # æ›´æ–°å‡¦ç†
    ...
```

### ğŸ¨ ã‚«ã‚¹ã‚¿ãƒ ã‚¢ã‚¯ã‚·ãƒ§ãƒ³

```python
@action(detail=False, methods=["get"], url_path="admin-count")
def admin_count(self, request):
    """ç®¡ç†è€…æ•°å–å¾—"""
    count = User.objects.filter(is_admin=True, is_active=True).count()
    return Response({"count": count, "can_delete": count > 1})
```

**Router ãŒè‡ªå‹•ç”Ÿæˆã™ã‚‹URL:**

```
GET /api/users/admin-count/
```

**detail=False vs detail=True:**

```
detail=Falseï¼ˆã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ï¼‰:
/api/users/admin-count/
â†‘ ãƒ¦ãƒ¼ã‚¶ãƒ¼å…¨ä½“ã«å¯¾ã™ã‚‹æ“ä½œ

detail=Trueï¼ˆå€‹åˆ¥ãƒªã‚½ãƒ¼ã‚¹ï¼‰:
/api/users/1/set_password/
â†‘ ç‰¹å®šã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«å¯¾ã™ã‚‹æ“ä½œ
```

---

## Service ã‚¯ãƒ©ã‚¹ã®è¦‹æ–¹

### ğŸ¯ Serviceå±¤ã®å½¹å‰²

**ãƒ“ã‚¸ãƒã‚¹ãƒ­ã‚¸ãƒƒã‚¯ã‚’Viewã‹ã‚‰åˆ†é›¢**

### ğŸ“Š ã‚ãªãŸã®ã‚³ãƒ¼ãƒ‰ã®æ§‹é€ 

```python
class UserService:
    """ãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç†ã‚µãƒ¼ãƒ“ã‚¹"""
    
    @staticmethod
    def _get_active_admin_count(exclude_user_id=None):
        """ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãªç®¡ç†è€…æ•°ã‚’å–å¾—ï¼ˆãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆãƒ¡ã‚½ãƒƒãƒ‰ï¼‰"""
        ...
    
    @staticmethod
    def _check_last_admin_for_delete(user_id):
        """å‰Šé™¤æ™‚ã®æœ€å¾Œã®ç®¡ç†è€…ãƒã‚§ãƒƒã‚¯ï¼ˆãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆãƒ¡ã‚½ãƒƒãƒ‰ï¼‰"""
        ...
    
    @staticmethod
    @transaction.atomic
    def delete_user(user_instance, request_user_id=None):
        """ãƒ¦ãƒ¼ã‚¶ãƒ¼å‰Šé™¤ï¼ˆãƒ‘ãƒ–ãƒªãƒƒã‚¯ãƒ¡ã‚½ãƒƒãƒ‰ï¼‰"""
        ...
```

**å›³è§£:**

```
ã€ãƒ¬ã‚¤ãƒ¤ãƒ¼ãƒ‰ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã€‘

View Layer:
ãƒ»HTTP ãƒªã‚¯ã‚¨ã‚¹ãƒˆ/ãƒ¬ã‚¹ãƒãƒ³ã‚¹
ãƒ»æ¨©é™ãƒã‚§ãƒƒã‚¯
ãƒ»Serializer ã®å‘¼ã³å‡ºã—

        â†“

Service Layer:  â† ãƒ“ã‚¸ãƒã‚¹ãƒ­ã‚¸ãƒƒã‚¯
ãƒ»æœ€å¾Œã®ç®¡ç†è€…ãƒã‚§ãƒƒã‚¯
ãƒ»è‡ªå·±å‰Šé™¤é˜²æ­¢
ãƒ»ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ç®¡ç†

        â†“

Model Layer:
ãƒ»ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ“ä½œ
ãƒ»soft_delete() ã®å®Ÿè¡Œ
```

### ğŸ” ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ç®¡ç†

```python
@staticmethod
@transaction.atomic
def delete_user(user_instance, request_user_id=None):
    """ãƒ¦ãƒ¼ã‚¶ãƒ¼å‰Šé™¤ï¼ˆè«–ç†å‰Šé™¤ï¼‰"""
    
    # â‘  è‡ªå·±å‰Šé™¤ãƒã‚§ãƒƒã‚¯
    if request_user_id and user_instance.id == request_user_id:
        raise CannotDeleteSelfError()
    
    # â‘¡ æœ€å¾Œã®ç®¡ç†è€…ãƒã‚§ãƒƒã‚¯
    if user_instance.is_admin:
        UserService._check_last_admin_for_delete(user_id=user_instance.id)
    
    # â‘¢ è«–ç†å‰Šé™¤å®Ÿè¡Œ
    user_instance.soft_delete()
```

**@transaction.atomic ã®åŠ¹æœ:**

```
ã€transaction.atomic ãªã—ã€‘
â‘  è‡ªå·±å‰Šé™¤ãƒã‚§ãƒƒã‚¯ â†’ OK
â‘¡ æœ€å¾Œã®ç®¡ç†è€…ãƒã‚§ãƒƒã‚¯ â†’ OK
â‘¢ soft_delete() â†’ ã‚¨ãƒ©ãƒ¼ï¼
â†’ â‘ â‘¡ã®å‡¦ç†ã¯æ®‹ã‚‹ï¼ˆä¸­é€”åŠç«¯ãªçŠ¶æ…‹ï¼‰

ã€transaction.atomic ã‚ã‚Šã€‘
â‘  è‡ªå·±å‰Šé™¤ãƒã‚§ãƒƒã‚¯ â†’ OK
â‘¡ æœ€å¾Œã®ç®¡ç†è€…ãƒã‚§ãƒƒã‚¯ â†’ OK
â‘¢ soft_delete() â†’ ã‚¨ãƒ©ãƒ¼ï¼
â†’ ã™ã¹ã¦ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼ˆå…ƒã®çŠ¶æ…‹ã«æˆ»ã‚‹ï¼‰
```

### ğŸ¨ ã‚«ã‚¹ã‚¿ãƒ ä¾‹å¤–ã®æ´»ç”¨

```python
class LastAdminError(UserServiceException):
    """æœ€å¾Œã®ç®¡ç†è€…å‰Šé™¤ã‚¨ãƒ©ãƒ¼"""
    
    def __init__(self, action="delete"):
        messages = {
            "delete": "æœ€å¾Œã®ç®¡ç†è€…ã‚’å‰Šé™¤ã™ã‚‹ã“ã¨ã¯ã§ãã¾ã›ã‚“ã€‚",
            "demote": "æœ€å¾Œã®ç®¡ç†è€…ã‹ã‚‰ç®¡ç†è€…æ¨©é™ã‚’å¤–ã™ã“ã¨ã¯ã§ãã¾ã›ã‚“ã€‚",
            "deactivate": "æœ€å¾Œã®ç®¡ç†è€…ã‚’ç„¡åŠ¹åŒ–ã™ã‚‹ã“ã¨ã¯ã§ãã¾ã›ã‚“ã€‚",
        }
        message = messages.get(action, messages["delete"])
        super().__init__(detail=str(message))
```

**View ã§ã®ä½¿ç”¨:**

```python
try:
    UserService.delete_user(instance, request_user_id=request.user.id)
    return Response(status=status.HTTP_204_NO_CONTENT)
except UserServiceException as e:
    # ã‚«ã‚¹ã‚¿ãƒ ä¾‹å¤–ã‚’æ•æ‰
    return Response({"detail": e.detail}, status=e.status_code)
```

---

## ã‚»ãƒƒã‚·ãƒ§ãƒ³èªè¨¼ã®ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ç¢ºèª

### ğŸ¯ ã‚»ãƒƒã‚·ãƒ§ãƒ³èªè¨¼ã®ä»•çµ„ã¿

**Cookie ãƒ™ãƒ¼ã‚¹ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ç®¡ç†**

### ğŸ“Š ãƒ‡ãƒ™ãƒ­ãƒƒãƒ‘ãƒ¼ãƒ„ãƒ¼ãƒ«ã§ã®ç¢ºèªæ–¹æ³•

**1. Chrome DevTools ã‚’é–‹ã**

```
F12 ã‚­ãƒ¼
ã¾ãŸã¯
å³ã‚¯ãƒªãƒƒã‚¯ â†’ æ¤œè¨¼
```

**2. Application ã‚¿ãƒ–ã‚’é–‹ã**

```
Application
  â”œâ”€ Storage
  â”‚   â””â”€ Cookies
  â”‚       â””â”€ http://localhost:5173
  â”‚           â”œâ”€ sessionid  â† ã‚»ãƒƒã‚·ãƒ§ãƒ³ID
  â”‚           â””â”€ csrftoken  â† CSRFãƒˆãƒ¼ã‚¯ãƒ³
```

**3. Cookie ã®ç¢ºèª**

```
ã€sessionidã€‘
åå‰: sessionid
å€¤: i27k7ailip3prew051urb1szes3tlzg5
ãƒ‰ãƒ¡ã‚¤ãƒ³: localhost
ãƒ‘ã‚¹: /
æœ‰åŠ¹æœŸé™: 2025-11-19 10:54:24  â† SESSION_COOKIE_AGE
HttpOnly: âœ“  â† JavaScript ã‹ã‚‰ã‚¢ã‚¯ã‚»ã‚¹ä¸å¯ï¼ˆXSSå¯¾ç­–ï¼‰
Secure: ï¼ˆæœ¬ç•ªã§ã¯âœ“ï¼‰  â† HTTPS ã®ã¿
SameSite: Lax  â† CSRFå¯¾ç­–

ã€csrftokenã€‘
åå‰: csrftoken
å€¤: xyz789abc...
ãƒ‰ãƒ¡ã‚¤ãƒ³: localhost
ãƒ‘ã‚¹: /
æœ‰åŠ¹æœŸé™: 1å¹´å¾Œ
HttpOnly: âœ—  â† JavaScript ã‹ã‚‰èª­ã¿å–ã‚‹å¿…è¦ãŒã‚ã‚‹
Secure: ï¼ˆæœ¬ç•ªã§ã¯âœ“ï¼‰
SameSite: Lax
```

### ğŸ” ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¿ãƒ–ã§ã®ç¢ºèª

**1. Network ã‚¿ãƒ–ã‚’é–‹ã**

```
Network â†’ Preserve log ã«ãƒã‚§ãƒƒã‚¯
```

**2. ãƒ­ã‚°ã‚¤ãƒ³ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’ç¢ºèª**

```
POST /api/auth/login/ HTTP/1.1

ã€ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒ˜ãƒƒãƒ€ãƒ¼ã€‘
Content-Type: application/json
X-CSRFToken: xyz789abc...  â† CSRF ãƒˆãƒ¼ã‚¯ãƒ³é€ä¿¡

ã€ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒœãƒ‡ã‚£ã€‘
{
  "employee_id": "9999",
  "password": "test1234"
}

ã€ãƒ¬ã‚¹ãƒãƒ³ã‚¹ãƒ˜ãƒƒãƒ€ãƒ¼ã€‘
Set-Cookie: sessionid=i27k7ailip...; HttpOnly; Path=/; SameSite=Lax
Set-Cookie: csrftoken=xyz789abc...; Path=/; SameSite=Lax

ã€ãƒ¬ã‚¹ãƒãƒ³ã‚¹ãƒœãƒ‡ã‚£ã€‘
{
  "detail": "logged_in",
  "user": {
    "id": 1,
    "employee_id": "9999",
    ...
  }
}
```

**3. æ¬¡å›ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’ç¢ºèª**

```
GET /api/users/ HTTP/1.1

ã€ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒ˜ãƒƒãƒ€ãƒ¼ã€‘
Cookie: sessionid=i27k7ailip...; csrftoken=xyz789abc...
â†‘ ãƒ–ãƒ©ã‚¦ã‚¶ãŒè‡ªå‹•çš„ã«é€ä¿¡

ã€Djangoå´ã®å‡¦ç†ã€‘
â‘   SessionMiddleware ãŒ Cookie ã‹ã‚‰ sessionid ã‚’å–å¾—
â‘¡ ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‹ã‚‰ session_data ã‚’å–å¾—
â‘¢ ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‹ã‚‰ user_id ã‚’å–å¾—
â‘£ User ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’å–å¾—
â‘¤ request.user ã«è¨­å®š
```

### ğŸ›¡ï¸ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è¨­å®šã®ç¢ºèª

**settings.py ã®ç¢ºèª:**

```python
# é–‹ç™ºç’°å¢ƒï¼ˆç¾åœ¨ã®è¨­å®šï¼‰
SESSION_COOKIE_HTTPONLY = True  # ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼ˆæ˜ç¤ºçš„ã«è¨­å®šæ¨å¥¨ï¼‰
SESSION_COOKIE_SECURE = False   # HTTPã§ã‚‚å‹•ä½œ
CSRF_COOKIE_HTTPONLY = False    # JavaScript ã‹ã‚‰èª­ã¿å–ã‚Šå¯èƒ½
CSRF_COOKIE_SECURE = False      # HTTPã§ã‚‚å‹•ä½œ

# æœ¬ç•ªç’°å¢ƒï¼ˆå¿…é ˆè¨­å®šï¼‰
SESSION_COOKIE_HTTPONLY = True  # âœ… JavaScript ã‹ã‚‰ã‚¢ã‚¯ã‚»ã‚¹ä¸å¯
SESSION_COOKIE_SECURE = True    # âœ… HTTPS ã®ã¿
SESSION_COOKIE_SAMESITE = "Lax" # âœ… CSRFå¯¾ç­–
CSRF_COOKIE_HTTPONLY = False    # âœ… JavaScript ã‹ã‚‰èª­ã¿å–ã‚Šå¿…è¦
CSRF_COOKIE_SECURE = True       # âœ… HTTPS ã®ã¿
CSRF_COOKIE_SAMESITE = "Lax"    # âœ… CSRFå¯¾ç­–
```

**å„è¨­å®šã®æ„å‘³:**

| è¨­å®š | åŠ¹æœ | æ”»æ’ƒå¯¾ç­– |
|------|------|---------|
| **HttpOnly** | JavaScript ã‹ã‚‰ã‚¢ã‚¯ã‚»ã‚¹ä¸å¯ | XSSæ”»æ’ƒå¯¾ç­– |
| **Secure** | HTTPS ã®ã¿é€ä¿¡ | ç›—è´å¯¾ç­– |
| **SameSite=Lax** | ã‚¯ãƒ­ã‚¹ã‚µã‚¤ãƒˆãƒªã‚¯ã‚¨ã‚¹ãƒˆã§é€ä¿¡åˆ¶é™ | CSRFæ”»æ’ƒå¯¾ç­– |

### ğŸ”’ CSRF ãƒˆãƒ¼ã‚¯ãƒ³ã®æµã‚Œ

```
ã€åˆå›ã‚¢ã‚¯ã‚»ã‚¹ã€‘
â‘  ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰: GET /api/auth/csrf/
   â†“
â‘¡ Django: CSRFView.get() å®Ÿè¡Œ
   @ensure_csrf_cookie ãƒ‡ã‚³ãƒ¬ãƒ¼ã‚¿
   â†“
â‘¢ ãƒ¬ã‚¹ãƒãƒ³ã‚¹ãƒ˜ãƒƒãƒ€ãƒ¼:
   Set-Cookie: csrftoken=xyz789abc...
   â†“
â‘£ ãƒ–ãƒ©ã‚¦ã‚¶: Cookie ã«ä¿å­˜

ã€POST/PUT/DELETE ãƒªã‚¯ã‚¨ã‚¹ãƒˆã€‘
â‘  Axios ã‚¤ãƒ³ã‚¿ãƒ¼ã‚»ãƒ—ã‚¿ãƒ¼:
   Cookie ã‹ã‚‰ csrftoken ã‚’å–å¾—
   â†“
â‘¡ ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒ˜ãƒƒãƒ€ãƒ¼ã«è¿½åŠ :
   X-CSRFToken: xyz789abc...
   â†“
â‘¢ Django CsrfViewMiddleware:
   Cookie ã® csrftoken ã¨
   ãƒ˜ãƒƒãƒ€ãƒ¼ã® X-CSRFToken ã‚’æ¯”è¼ƒ
   â†“
â‘£ ä¸€è‡´ â†’ å‡¦ç†ç¶šè¡Œ
   ä¸ä¸€è‡´ â†’ 403 Forbidden
```

### ğŸ” ã‚ãªãŸã®ã‚³ãƒ¼ãƒ‰ã§ã®å®Ÿè£…

**CSRFãƒˆãƒ¼ã‚¯ãƒ³å–å¾—:**

```python
# accounts/views.py
class CSRFView(APIView):
    permission_classes = [AllowAny]
    
    @method_decorator(ensure_csrf_cookie)
    def get(self, request):
        # CSRFãƒˆãƒ¼ã‚¯ãƒ³ã‚’Cookieã«ã‚»ãƒƒãƒˆ
        return Response(status=status.HTTP_204_NO_CONTENT)
```

**Axios ã§ã®è‡ªå‹•é€ä¿¡:**

```javascript
// plugins/axios.js
api.interceptors.request.use(async (config) => {
    const method = (config.method || '').toLowerCase();
    
    if (['post', 'put', 'patch', 'delete'].includes(method)) {
        // CSRFãƒˆãƒ¼ã‚¯ãƒ³ã‚’å–å¾—
        await csrfManager.ensureToken();
        const csrfToken = Cookies.get('csrftoken');
        
        if (csrfToken) {
            config.headers['X-CSRFToken'] = csrfToken;
        }
    }
    
    return config;
});
```

---

## ãƒ†ã‚¹ãƒˆã‚³ãƒ¼ãƒ‰ã®æ›¸ãæ–¹

### ğŸ¯ ãƒ†ã‚¹ãƒˆã®ç¨®é¡

```
ã€ãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆã€‘
ãƒ»å€‹åˆ¥ã®é–¢æ•°/ãƒ¡ã‚½ãƒƒãƒ‰ã‚’ãƒ†ã‚¹ãƒˆ
ãƒ»ãƒ¢ãƒ‡ãƒ«ã®ãƒ¡ã‚½ãƒƒãƒ‰
ãƒ»ã‚µãƒ¼ãƒ“ã‚¹å±¤ã®ãƒ­ã‚¸ãƒƒã‚¯

ã€çµ±åˆãƒ†ã‚¹ãƒˆã€‘
ãƒ»è¤‡æ•°ã®ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã®é€£æºã‚’ãƒ†ã‚¹ãƒˆ
ãƒ»API ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ
ãƒ»ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ“ä½œ

ã€E2Eãƒ†ã‚¹ãƒˆã€‘
ãƒ»å®Ÿéš›ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼æ“ä½œã‚’ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ãƒˆ
ãƒ»ãƒ–ãƒ©ã‚¦ã‚¶æ“ä½œ
ãƒ»ç”»é¢é·ç§»
```

### ğŸ“Š Django ã®ãƒ†ã‚¹ãƒˆãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯

**åŸºæœ¬æ§‹é€ :**

```python
from django.test import TestCase
from django.contrib.auth import get_user_model

User = get_user_model()

class UserModelTest(TestCase):
    """Userãƒ¢ãƒ‡ãƒ«ã®ãƒ†ã‚¹ãƒˆ"""
    
    def setUp(self):
        """å„ãƒ†ã‚¹ãƒˆã®å‰ã«å®Ÿè¡Œ"""
        self.user = User.objects.create_user(
            employee_id='1234',
            username='ãƒ†ã‚¹ãƒˆãƒ¦ãƒ¼ã‚¶ãƒ¼',
            password='test1234'
        )
    
    def tearDown(self):
        """å„ãƒ†ã‚¹ãƒˆã®å¾Œã«å®Ÿè¡Œï¼ˆè‡ªå‹•ã§ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼‰"""
        pass
    
    def test_soft_delete(self):
        """è«–ç†å‰Šé™¤ã®ãƒ†ã‚¹ãƒˆ"""
        # å®Ÿè¡Œ
        self.user.soft_delete()
        
        # æ¤œè¨¼
        self.assertIsNotNone(self.user.deleted_at)
        self.assertFalse(self.user.is_active)
        
        # objects ã§ã¯å–å¾—ã§ããªã„
        self.assertFalse(
            User.objects.filter(id=self.user.id).exists()
        )
        
        # all_objects ã§ã¯å–å¾—ã§ãã‚‹
        self.assertTrue(
            User.all_objects.filter(id=self.user.id).exists()
        )
```

### ğŸ§ª è«–ç†å‰Šé™¤ã®ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹

```python
class SoftDeleteTest(TestCase):
    """è«–ç†å‰Šé™¤æ©Ÿèƒ½ã®ãƒ†ã‚¹ãƒˆ"""
    
    def setUp(self):
        self.user = User.objects.create_user(
            employee_id='1234',
            username='ãƒ†ã‚¹ãƒˆ',
            password='test1234'
        )
    
    def test_soft_delete_sets_deleted_at(self):
        """deleted_at ãŒã‚»ãƒƒãƒˆã•ã‚Œã‚‹"""
        self.user.soft_delete()
        self.assertIsNotNone(self.user.deleted_at)
    
    def test_soft_delete_sets_is_active_false(self):
        """is_active ãŒ False ã«ãªã‚‹"""
        self.user.soft_delete()
        self.assertFalse(self.user.is_active)
    
    def test_soft_deleted_user_not_in_objects(self):
        """objects ãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼ã§å–å¾—ã§ããªã„"""
        self.user.soft_delete()
        count = User.objects.filter(id=self.user.id).count()
        self.assertEqual(count, 0)
    
    def test_soft_deleted_user_in_all_objects(self):
        """all_objects ãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼ã§å–å¾—ã§ãã‚‹"""
        self.user.soft_delete()
        count = User.all_objects.filter(id=self.user.id).count()
        self.assertEqual(count, 1)
    
    def test_employee_id_can_be_reused_after_soft_delete(self):
        """å‰Šé™¤å¾Œã€ç¤¾å“¡ç•ªå·ã‚’å†åˆ©ç”¨ã§ãã‚‹"""
        # ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’å‰Šé™¤
        self.user.soft_delete()
        
        # åŒã˜ç¤¾å“¡ç•ªå·ã§æ–°è¦ä½œæˆï¼ˆã‚¨ãƒ©ãƒ¼ãŒå‡ºãªã„ã“ã¨ã‚’ç¢ºèªï¼‰
        new_user = User.objects.create_user(
            employee_id='1234',  # åŒã˜ç¤¾å“¡ç•ªå·
            username='æ–°ãƒ¦ãƒ¼ã‚¶ãƒ¼',
            password='test1234'
        )
        
        self.assertEqual(new_user.employee_id, '1234')
        
    def test_restore(self):
        """å¾©å…ƒæ©Ÿèƒ½ã®ãƒ†ã‚¹ãƒˆ"""
        self.user.soft_delete()
        self.user.restore()
        
        self.assertIsNone(self.user.deleted_at)
        self.assertTrue(self.user.is_active)
```

### ğŸ” èªè¨¼ã®ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹

```python
from django.test import TestCase, Client
from django.urls import reverse

class AuthenticationTest(TestCase):
    """èªè¨¼æ©Ÿèƒ½ã®ãƒ†ã‚¹ãƒˆ"""
    
    def setUp(self):
        self.client = Client()
        self.user = User.objects.create_user(
            employee_id='9999',
            username='ç®¡ç†è€…',
            password='test1234',
            is_admin=True
        )
    
    def test_login_success(self):
        """ãƒ­ã‚°ã‚¤ãƒ³æˆåŠŸ"""
        response = self.client.post(
            reverse('accounts:login'),
            {
                'employee_id': '9999',
                'password': 'test1234'
            },
            content_type='application/json'
        )
        
        self.assertEqual(response.status_code, 200)
        self.assertEqual(response.json()['detail'], 'logged_in')
        self.assertIn('user', response.json())
    
    def test_login_failure_wrong_password(self):
        """ãƒ­ã‚°ã‚¤ãƒ³å¤±æ•—ï¼ˆãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰é–“é•ã„ï¼‰"""
        response = self.client.post(
            reverse('accounts:login'),
            {
                'employee_id': '9999',
                'password': 'wrong_password'
            },
            content_type='application/json'
        )
        
        self.assertEqual(response.status_code, 401)
    
    def test_login_lockout_after_max_attempts(self):
        """æœ€å¤§è©¦è¡Œå›æ•°å¾Œã«ãƒ­ãƒƒã‚¯ã•ã‚Œã‚‹"""
        # 10å›å¤±æ•—
        for _ in range(10):
            self.client.post(
                reverse('accounts:login'),
                {
                    'employee_id': '9999',
                    'password': 'wrong'
                },
                content_type='application/json'
            )
        
        # 11å›ç›®ã¯ãƒ­ãƒƒã‚¯
        response = self.client.post(
            reverse('accounts:login'),
            {
                'employee_id': '9999',
                'password': 'test1234'  # æ­£ã—ã„ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã§ã‚‚
            },
            content_type='application/json'
        )
        
        self.assertEqual(response.status_code, 429)
```

### ğŸ¨ API ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹

```python
from rest_framework.test import APITestCase, APIClient
from rest_framework import status

class UserAPITest(APITestCase):
    """ãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç†APIã®ãƒ†ã‚¹ãƒˆ"""
    
    def setUp(self):
        self.client = APIClient()
        
        # ç®¡ç†è€…ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’ä½œæˆ
        self.admin = User.objects.create_user(
            employee_id='9999',
            username='ç®¡ç†è€…',
            password='test1234',
            is_admin=True
        )
        
        # ä¸€èˆ¬ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’ä½œæˆ
        self.user = User.objects.create_user(
            employee_id='1234',
            username='ä¸€èˆ¬',
            password='test1234',
            is_admin=False
        )
        
        # ãƒ­ã‚°ã‚¤ãƒ³
        self.client.force_authenticate(user=self.admin)
    
    def test_list_users(self):
        """ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§å–å¾—"""
        response = self.client.get('/api/users/')
        
        self.assertEqual(response.status_code, status.HTTP_200_OK)
        self.assertIn('results', response.json())
    
    def test_create_user(self):
        """ãƒ¦ãƒ¼ã‚¶ãƒ¼ä½œæˆ"""
        response = self.client.post('/api/users/', {
            'employee_id': '5678',
            'username': 'æ–°è¦ãƒ¦ãƒ¼ã‚¶ãƒ¼',
            'password': 'test1234',
            'email': 'new@example.com',
            'is_admin': False
        })
        
        self.assertEqual(response.status_code, status.HTTP_201_CREATED)
        
        # ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«ä¿å­˜ã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª
        self.assertTrue(
            User.objects.filter(employee_id='5678').exists()
        )
    
    def test_delete_user(self):
        """ãƒ¦ãƒ¼ã‚¶ãƒ¼å‰Šé™¤ï¼ˆè«–ç†å‰Šé™¤ï¼‰"""
        response = self.client.delete(f'/api/users/{self.user.id}/')
        
        self.assertEqual(response.status_code, status.HTTP_204_NO_CONTENT)
        
        # objects ã§ã¯å–å¾—ã§ããªã„
        self.assertFalse(
            User.objects.filter(id=self.user.id).exists()
        )
        
        # all_objects ã§ã¯å–å¾—ã§ãã‚‹
        deleted_user = User.all_objects.get(id=self.user.id)
        self.assertIsNotNone(deleted_user.deleted_at)
    
    def test_cannot_delete_last_admin(self):
        """æœ€å¾Œã®ç®¡ç†è€…ã¯å‰Šé™¤ã§ããªã„"""
        response = self.client.delete(f'/api/users/{self.admin.id}/')
        
        self.assertEqual(response.status_code, status.HTTP_400_BAD_REQUEST)
        self.assertIn('æœ€å¾Œã®ç®¡ç†è€…', response.json()['detail'])
    
    def test_cannot_delete_self(self):
        """è‡ªåˆ†è‡ªèº«ã¯å‰Šé™¤ã§ããªã„"""
        response = self.client.delete(f'/api/users/{self.admin.id}/')
        
        self.assertEqual(response.status_code, status.HTTP_400_BAD_REQUEST)
```

### ğŸ” ã‚µãƒ¼ãƒ“ã‚¹å±¤ã®ãƒ†ã‚¹ãƒˆ

```python
from django.test import TestCase
from users.services.user_service import UserService
from users.exceptions import (
    LastAdminError,
    CannotDeleteSelfError
)

class UserServiceTest(TestCase):
    """UserServiceã®ãƒ†ã‚¹ãƒˆ"""
    
    def setUp(self):
        self.admin = User.objects.create_user(
            employee_id='9999',
            username='ç®¡ç†è€…',
            password='test1234',
            is_admin=True
        )
        
        self.user = User.objects.create_user(
            employee_id='1234',
            username='ä¸€èˆ¬',
            password='test1234',
            is_admin=False
        )
    
    def test_delete_user_success(self):
        """å‰Šé™¤æˆåŠŸ"""
        UserService.delete_user(self.user)
        
        # è«–ç†å‰Šé™¤ã•ã‚Œã¦ã„ã‚‹
        self.user.refresh_from_db()
        self.assertIsNotNone(self.user.deleted_at)
    
    def test_delete_last_admin_raises_error(self):
        """æœ€å¾Œã®ç®¡ç†è€…å‰Šé™¤ã¯ã‚¨ãƒ©ãƒ¼"""
        with self.assertRaises(LastAdminError):
            UserService.delete_user(self.admin)
    
    def test_delete_self_raises_error(self):
        """è‡ªå·±å‰Šé™¤ã¯ã‚¨ãƒ©ãƒ¼"""
        with self.assertRaises(CannotDeleteSelfError):
            UserService.delete_user(
                self.admin,
                request_user_id=self.admin.id
            )
    
    def test_update_last_admin_to_non_admin_raises_error(self):
        """æœ€å¾Œã®ç®¡ç†è€…ã®æ¨©é™å‰¥å¥ªã¯ã‚¨ãƒ©ãƒ¼"""
        with self.assertRaises(LastAdminError):
            UserService.update_user(
                self.admin,
                {'is_admin': False}
            )
```

### ğŸ“Š ãƒ†ã‚¹ãƒˆã®å®Ÿè¡Œ

**ã‚³ãƒãƒ³ãƒ‰:**

```bash
# ã™ã¹ã¦ã®ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œ
python manage.py test

# ç‰¹å®šã®ã‚¢ãƒ—ãƒªã®ã¿
python manage.py test users

# ç‰¹å®šã®ãƒ†ã‚¹ãƒˆã‚¯ãƒ©ã‚¹ã®ã¿
python manage.py test users.tests.UserModelTest

# ç‰¹å®šã®ãƒ†ã‚¹ãƒˆãƒ¡ã‚½ãƒƒãƒ‰ã®ã¿
python manage.py test users.tests.UserModelTest.test_soft_delete

# è©³ç´°ãªå‡ºåŠ›
python manage.py test --verbosity=2

# å¤±æ•—ã—ãŸãƒ†ã‚¹ãƒˆã§åœæ­¢
python manage.py test --failfast
```

**å‡ºåŠ›ä¾‹:**

```
Creating test database for alias 'default'...
System check identified no issues (0 silenced).
..........
----------------------------------------------------------------------
Ran 10 tests in 0.234s

OK
Destroying test database for alias 'default'...
```

### ğŸ¯ ã‚«ãƒãƒ¬ãƒƒã‚¸ã®æ¸¬å®š

**ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«:**

```bash
pip install coverage
```

**å®Ÿè¡Œ:**

```bash
# ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ + ã‚«ãƒãƒ¬ãƒƒã‚¸æ¸¬å®š
coverage run --source='.' manage.py test users

# ãƒ¬ãƒãƒ¼ãƒˆè¡¨ç¤ºï¼ˆã‚¿ãƒ¼ãƒŸãƒŠãƒ«ï¼‰
coverage report

# HTML ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆ
coverage html

# ãƒ–ãƒ©ã‚¦ã‚¶ã§ç¢ºèª
open htmlcov/index.html
```

**ãƒ¬ãƒãƒ¼ãƒˆä¾‹:**

```
Name                      Stmts   Miss  Cover
---------------------------------------------
users/models.py             45      2    96%
users/serializers.py        32      0   100%
users/services.py           28      1    96%
users/views.py              78      5    94%
---------------------------------------------
TOTAL                      183      8    96%
```

### ğŸ”§ ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ã®ä½œæˆ

**Factory ãƒ‘ã‚¿ãƒ¼ãƒ³ï¼ˆæ¨å¥¨ï¼‰:**

```bash
pip install factory-boy
```

```python
# users/factories.py
import factory
from django.contrib.auth import get_user_model

User = get_user_model()

class UserFactory(factory.django.DjangoModelFactory):
    """ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒ•ã‚¡ã‚¯ãƒˆãƒªãƒ¼"""
    
    class Meta:
        model = User
    
    employee_id = factory.Sequence(lambda n: f'{n:04d}')
    username = factory.Faker('name', locale='ja_JP')
    email = factory.Faker('email')
    password = factory.PostGenerationMethodCall('set_password', 'test1234')
    is_admin = False
    is_active = True

class AdminUserFactory(UserFactory):
    """ç®¡ç†è€…ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒ•ã‚¡ã‚¯ãƒˆãƒªãƒ¼"""
    is_admin = True
```

**ä½¿ç”¨ä¾‹:**

```python
class UserTestWithFactory(TestCase):
    def test_with_factory(self):
        # ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’ç°¡å˜ã«ä½œæˆ
        user = UserFactory()
        admin = AdminUserFactory()
        
        # è¤‡æ•°ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’ä½œæˆ
        users = UserFactory.create_batch(10)
        
        # ç‰¹å®šã®å€¤ã‚’æŒ‡å®š
        specific_user = UserFactory(
            employee_id='9999',
            username='ç‰¹å®šãƒ¦ãƒ¼ã‚¶ãƒ¼'
        )
```

### ğŸ¨ ãƒ¢ãƒƒã‚¯ã®ä½¿ç”¨

```python
from unittest.mock import patch, Mock
from django.test import TestCase

class ExternalAPITest(TestCase):
    """å¤–éƒ¨APIã‚’ä½¿ã†æ©Ÿèƒ½ã®ãƒ†ã‚¹ãƒˆ"""
    
    @patch('users.services.send_email')
    def test_create_user_sends_email(self, mock_send_email):
        """ãƒ¦ãƒ¼ã‚¶ãƒ¼ä½œæˆæ™‚ã«ãƒ¡ãƒ¼ãƒ«é€ä¿¡ã•ã‚Œã‚‹"""
        
        # ã‚µãƒ¼ãƒ“ã‚¹ã‚’å®Ÿè¡Œ
        UserService.create_user({
            'employee_id': '1234',
            'username': 'ãƒ†ã‚¹ãƒˆ',
            'email': 'test@example.com'
        })
        
        # ãƒ¡ãƒ¼ãƒ«é€ä¿¡ãŒå‘¼ã°ã‚ŒãŸã‹ç¢ºèª
        mock_send_email.assert_called_once()
        
        # å¼•æ•°ã®ç¢ºèª
        args, kwargs = mock_send_email.call_args
        self.assertEqual(kwargs['to'], 'test@example.com')
```

---

## ã¾ã¨ã‚

### ğŸ¯ è«–ç†å‰Šé™¤ã®å®Ÿè£…ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ

```
âœ… deleted_at ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®è¿½åŠ 
âœ… ã‚«ã‚¹ã‚¿ãƒ ãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼ã®å®Ÿè£…
âœ… æ¡ä»¶ä»˜ããƒ¦ãƒ‹ãƒ¼ã‚¯åˆ¶ç´„
âœ… soft_delete() ãƒ¡ã‚½ãƒƒãƒ‰
âœ… ViewSet ã§ã®å‰Šé™¤æ¸ˆã¿ãƒã‚§ãƒƒã‚¯
âœ… åŒæ™‚æ“ä½œå¯¾ç­–ï¼ˆall_objectsä½¿ç”¨ï¼‰
âœ… ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã®æœ€é©åŒ–
```

### ğŸ” ã‚»ãƒƒã‚·ãƒ§ãƒ³èªè¨¼ã®ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ

```
âœ… SESSION_COOKIE_HTTPONLY = True
âœ… SESSION_COOKIE_SECURE = Trueï¼ˆæœ¬ç•ªï¼‰
âœ… SESSION_COOKIE_SAMESITE = "Lax"
âœ… CSRF_COOKIE_HTTPONLY = False
âœ… CSRF_COOKIE_SECURE = Trueï¼ˆæœ¬ç•ªï¼‰
âœ… CORS_ALLOW_CREDENTIALS = True
âœ… withCredentials: trueï¼ˆAxiosï¼‰
âœ… CSRFãƒˆãƒ¼ã‚¯ãƒ³ã®è‡ªå‹•é€ä¿¡
```

### ğŸ§ª ãƒ†ã‚¹ãƒˆã®ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ

```
âœ… ãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆï¼ˆãƒ¢ãƒ‡ãƒ«ãƒ»ã‚µãƒ¼ãƒ“ã‚¹ï¼‰
âœ… çµ±åˆãƒ†ã‚¹ãƒˆï¼ˆAPI ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆï¼‰
âœ… èªè¨¼ãƒ†ã‚¹ãƒˆ
âœ… æ¨©é™ãƒ†ã‚¹ãƒˆ
âœ… ã‚¨ãƒƒã‚¸ã‚±ãƒ¼ã‚¹ã®ãƒ†ã‚¹ãƒˆ
âœ… ã‚«ãƒãƒ¬ãƒƒã‚¸ 80% ä»¥ä¸Š
```

---

## å®Ÿè·µ: ãƒ‡ãƒãƒƒã‚°ã®æµã‚Œ

### ğŸ” å•é¡Œç™ºç”Ÿæ™‚ã®ç¢ºèªæ‰‹é †

**1. ãƒ­ã‚°ã‚’ç¢ºèª**

```bash
# Django ã®ãƒ­ã‚°
tail -f logs/audit.log

# é–‹ç™ºã‚µãƒ¼ãƒãƒ¼ã®ãƒ­ã‚°
python manage.py runserver
```

**2. ãƒ‡ãƒ™ãƒ­ãƒƒãƒ‘ãƒ¼ãƒ„ãƒ¼ãƒ«ã§ç¢ºèª**

```
ã€Network ã‚¿ãƒ–ã€‘
ãƒ»ãƒªã‚¯ã‚¨ã‚¹ãƒˆ/ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã®ç¢ºèª
ãƒ»ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚³ãƒ¼ãƒ‰
ãƒ»Cookie ã®é€å—ä¿¡

ã€Application ã‚¿ãƒ–ã€‘
ãƒ»Cookie ã®ç¢ºèª
ãƒ»localStorage ã®ç¢ºèª

ã€Console ã‚¿ãƒ–ã€‘
ãƒ»JavaScript ã‚¨ãƒ©ãƒ¼
```

**3. Django Debug Toolbar**

```
http://localhost:8000/__debug__/

ã€ç¢ºèªã§ãã‚‹ã“ã¨ã€‘
ãƒ»å®Ÿè¡Œã•ã‚ŒãŸ SQL
ãƒ»SQL ã®å®Ÿè¡Œæ™‚é–“
ãƒ»N+1 å•é¡Œã®æ¤œå‡º
ãƒ»ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã®çŠ¶æ…‹
```

**4. ãƒ†ã‚¹ãƒˆã‚’æ›¸ã„ã¦å†ç¾**

```python
def test_reproduce_bug(self):
    """ãƒã‚°ã‚’å†ç¾ã™ã‚‹ãƒ†ã‚¹ãƒˆ"""
    # ãƒã‚°ãŒç™ºç”Ÿã™ã‚‹æ‰‹é †ã‚’å†ç¾
    user = UserFactory()
    user.soft_delete()
    
    # æœŸå¾…ã•ã‚Œã‚‹å‹•ä½œ
    self.assertIsNotNone(user.deleted_at)
```

---

## å‚è€ƒãƒªãƒ³ã‚¯

**Django å…¬å¼:**
- [Testing in Django](https://docs.djangoproject.com/en/stable/topics/testing/)
- [Django Managers](https://docs.djangoproject.com/en/stable/topics/db/managers/)
- [Django Sessions](https://docs.djangoproject.com/en/stable/topics/http/sessions/)

**DRF å…¬å¼:**
- [Testing](https://www.django-rest-framework.org/api-guide/testing/)
- [Serializers](https://www.django-rest-framework.org/api-guide/serializers/)
- [ViewSets](https://www.django-rest-framework.org/api-guide/viewsets/)

**ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£:**
- [OWASP Session Management](https://cheatsheetseries.owasp.org/cheatsheets/Session_Management_Cheat_Sheet.html)
- [Django Security](https://docs.djangoproject.com/en/stable/topics/security/)

**ãƒ†ã‚¹ãƒˆ:**
- [Coverage.py](https://coverage.readthedocs.io/)
- [Factory Boy](https://factoryboy.readthedocs.io/)

---

**ã“ã®ã‚¬ã‚¤ãƒ‰ãŒã€ã‚³ãƒ¼ãƒ‰ã®ç†è§£ã¨ãƒ†ã‚¹ãƒˆã®ä½œæˆã«å½¹ç«‹ã¦ã°å¹¸ã„ã§ã™ï¼** ğŸ“šâœ¨

**ã‚ã‹ã‚‰ãªã„ã“ã¨ãŒã‚ã‚Œã°ã€ã„ã¤ã§ã‚‚è³ªå•ã—ã¦ãã ã•ã„ï¼** ğŸ’ªğŸ˜Š