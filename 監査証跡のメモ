ç›£æŸ»è¨¼è·¡

DRFï¼‹Vuejsã§ãƒ•ã‚¡ã‚¤ãƒ«ã«ç›£æŸ»è¨¼è·¡ã®ãƒ­ã‚°ã‚’å‡ºåŠ›ã—ãŸã„ã£ã¦æ™‚ã¯ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢ï¼‹ã‚·ã‚°ãƒŠãƒ«ï¼‹settingsã«logç³»è¿½åŠ ï¼Ÿã—ãŸã‚‰ã€æ—¢å­˜ã®ç’°å¢ƒå£Šã•ãšã«ã„ã‘ã‚‹ã‚“ã‹ãªï¼Ÿ(Â´ãƒ»Ï‰ãƒ»ï½€)


ğŸ” ç›£æŸ»è¨¼è·¡ãƒ­ã‚°ã®å®Ÿè£…æ–¹æ³•ï¼
æ—¢å­˜ç’°å¢ƒã‚’å£Šã•ãšã«å®Ÿè£…ã§ãã‚‹ã‚ˆï¼(ã€€ï½¥Ï‰ï½¥)b

ğŸ¯ æ¨å¥¨ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  DRF (Backend)                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â‘  Middleware (ãƒªã‚¯ã‚¨ã‚¹ãƒˆ/ãƒ¬ã‚¹ãƒãƒ³ã‚¹) â”‚  â† å…¨APIã®å‡ºå…¥ã‚Šå£
â”‚  â‘¡ Signal (ãƒ¢ãƒ‡ãƒ«æ“ä½œ)               â”‚  â† CRUDæ“ä½œ
â”‚  â‘¢ Custom Logging (æ¥­å‹™ãƒ­ã‚¸ãƒƒã‚¯)     â”‚  â† é‡è¦å‡¦ç†
â”‚  â‘£ settings.py (ãƒ­ã‚°è¨­å®š)            â”‚  â† å‡ºåŠ›å…ˆãƒ»ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â†“ JSONå½¢å¼ã§ãƒ­ã‚°å‡ºåŠ›
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  logs/audit.log                     â”‚  â† ãƒ•ã‚¡ã‚¤ãƒ«å‡ºåŠ›
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“ å®Ÿè£…ãƒ•ã‚¡ã‚¤ãƒ«æ§‹æˆ
```
backend/
â”œâ”€â”€ config/
â”‚   â”œâ”€â”€ settings.py              # â­ ãƒ­ã‚°è¨­å®šè¿½åŠ 
â”‚   â””â”€â”€ middleware.py            # â­ æ–°è¦ä½œæˆ
â”œâ”€â”€ common/
â”‚   â”œâ”€â”€ audit.py                 # â­ æ–°è¦ä½œæˆï¼ˆç›£æŸ»ãƒ­ã‚°ç”¨ãƒ˜ãƒ«ãƒ‘ãƒ¼ï¼‰
â”‚   â””â”€â”€ signals.py               # â­ æ–°è¦ä½œæˆï¼ˆãƒ¢ãƒ‡ãƒ«ç›£æŸ»ï¼‰
â”œâ”€â”€ logs/                        # â­ æ–°è¦ä½œæˆï¼ˆãƒ­ã‚°å‡ºåŠ›å…ˆï¼‰
â”‚   â”œâ”€â”€ audit.log
â”‚   â””â”€â”€ .gitignore
â””â”€â”€ users/
    â””â”€â”€ signals.py               # â­ æ—¢å­˜ã®ã‚·ã‚°ãƒŠãƒ«ã«è¿½åŠ 

ğŸ”§ å®Ÿè£…æ‰‹é †
1ï¸âƒ£ settings.py ã«ãƒ­ã‚°è¨­å®šè¿½åŠ 
python# backend/config/settings.py

import os
from pathlib import Path

BASE_DIR = Path(__file__).resolve().parent.parent

# ==================== ãƒ­ã‚°è¨­å®šï¼ˆæ—¢å­˜ã‚’å£Šã•ãªã„ï¼‰ ====================

LOGGING = {
    'version': 1,
    'disable_existing_loggers': False,  # â­ æ—¢å­˜ãƒ­ã‚°ã‚’ç„¡åŠ¹åŒ–ã—ãªã„
    
    'formatters': {
        # é€šå¸¸ãƒ­ã‚°ç”¨ï¼ˆæ—¢å­˜ï¼‰
        'verbose': {
            'format': '{levelname} {asctime} {module} {message}',
            'style': '{',
        },
        # â­ ç›£æŸ»ãƒ­ã‚°ç”¨ï¼ˆJSONå½¢å¼ï¼‰
        'audit_json': {
            'format': '{"timestamp": "%(asctime)s", "level": "%(levelname)s", "user": "%(user)s", "action": "%(action)s", "model": "%(model)s", "object_id": "%(object_id)s", "ip": "%(ip)s", "changes": %(changes)s, "message": "%(message)s"}',
            'datefmt': '%Y-%m-%d %H:%M:%S',
        },
    },
    
    'handlers': {
        # æ—¢å­˜ã®ã‚³ãƒ³ã‚½ãƒ¼ãƒ«å‡ºåŠ›ï¼ˆå¤‰æ›´ãªã—ï¼‰
        'console': {
            'class': 'logging.StreamHandler',
            'formatter': 'verbose',
        },
        # â­ ç›£æŸ»ãƒ­ã‚°å°‚ç”¨ãƒãƒ³ãƒ‰ãƒ©ãƒ¼
        'audit_file': {
            'level': 'INFO',
            'class': 'logging.handlers.RotatingFileHandler',
            'filename': BASE_DIR / 'logs' / 'audit.log',
            'maxBytes': 10 * 1024 * 1024,  # 10MB
            'backupCount': 10,  # éå»10ãƒ•ã‚¡ã‚¤ãƒ«ä¿æŒ
            'formatter': 'audit_json',
        },
    },
    
    'loggers': {
        # Djangoæ¨™æº–ãƒ­ã‚°ï¼ˆæ—¢å­˜ï¼‰
        'django': {
            'handlers': ['console'],
            'level': 'INFO',
        },
        # â­ ç›£æŸ»ãƒ­ã‚°å°‚ç”¨ãƒ­ã‚¬ãƒ¼
        'audit': {
            'handlers': ['audit_file'],
            'level': 'INFO',
            'propagate': False,  # è¦ªãƒ­ã‚¬ãƒ¼ã«ä¼æ’­ã•ã›ãªã„
        },
    },
}

# ==================== ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢è¨­å®š ====================

MIDDLEWARE = [
    'django.middleware.security.SecurityMiddleware',
    'django.contrib.sessions.middleware.SessionMiddleware',
    'corsheaders.middleware.CorsMiddleware',
    'django.middleware.common.CommonMiddleware',
    'django.middleware.csrf.CsrfViewMiddleware',
    'django.contrib.auth.middleware.AuthenticationMiddleware',
    'django.contrib.messages.middleware.MessageMiddleware',
    'django.middleware.clickjacking.XFrameOptionsMiddleware',
    'config.middleware.AuditMiddleware',  # â­ è¿½åŠ 
]

2ï¸âƒ£ ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢ä½œæˆï¼ˆAPIç›£æŸ»ï¼‰
python# backend/config/middleware.py
"""
APIç›£æŸ»ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢

å½¹å‰²:
- ã™ã¹ã¦ã®APIãƒªã‚¯ã‚¨ã‚¹ãƒˆ/ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’ãƒ­ã‚°è¨˜éŒ²
- ãƒ­ã‚°ã‚¤ãƒ³/ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã‚’è¨˜éŒ²
- ã‚¨ãƒ©ãƒ¼ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’è¨˜éŒ²
"""

import logging
import json
from django.utils.deprecation import MiddlewareMixin
from django.contrib.auth import get_user_model

User = get_user_model()
audit_logger = logging.getLogger('audit')


class AuditMiddleware(MiddlewareMixin):
    """APIç›£æŸ»ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢"""
    
    # ç›£æŸ»å¯¾è±¡ã®ãƒ‘ã‚¹ï¼ˆå¿…è¦ã«å¿œã˜ã¦è¿½åŠ ï¼‰
    AUDIT_PATHS = [
        '/api/auth/login/',
        '/api/auth/logout/',
        '/api/users/',
    ]
    
    # é™¤å¤–ãƒ‘ã‚¹ï¼ˆãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯ãªã©ï¼‰
    EXCLUDE_PATHS = [
        '/api/health/',
        '/api/csrf/',
    ]
    
    def process_request(self, request):
        """ãƒªã‚¯ã‚¨ã‚¹ãƒˆå‰å‡¦ç†"""
        # ç›£æŸ»å¯¾è±¡ã‹ãƒã‚§ãƒƒã‚¯
        if not self._should_audit(request):
            return None
        
        # ãƒªã‚¯ã‚¨ã‚¹ãƒˆæƒ…å ±ã‚’ä¿å­˜ï¼ˆãƒ¬ã‚¹ãƒãƒ³ã‚¹æ™‚ã«ä½¿ç”¨ï¼‰
        request._audit_data = {
            'method': request.method,
            'path': request.path,
            'user': self._get_user_info(request),
            'ip': self._get_client_ip(request),
        }
        
        return None
    
    def process_response(self, request, response):
        """ãƒ¬ã‚¹ãƒãƒ³ã‚¹å¾Œå‡¦ç†"""
        # ç›£æŸ»ãƒ‡ãƒ¼ã‚¿ãŒãªã„å ´åˆã¯ã‚¹ã‚­ãƒƒãƒ—
        if not hasattr(request, '_audit_data'):
            return response
        
        # ãƒ­ã‚°è¨˜éŒ²
        audit_data = request._audit_data
        
        # â­ ãƒ­ã‚°ã‚¤ãƒ³æˆåŠŸ
        if request.path == '/api/auth/login/' and response.status_code == 200:
            self._log_audit(
                user=audit_data['user'],
                action='LOGIN',
                model='Auth',
                ip=audit_data['ip'],
                message='ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒãƒ­ã‚°ã‚¤ãƒ³ã—ã¾ã—ãŸ',
            )
        
        # â­ ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ
        elif request.path == '/api/auth/logout/' and response.status_code == 200:
            self._log_audit(
                user=audit_data['user'],
                action='LOGOUT',
                model='Auth',
                ip=audit_data['ip'],
                message='ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒãƒ­ã‚°ã‚¢ã‚¦ãƒˆã—ã¾ã—ãŸ',
            )
        
        # â­ APIæ“ä½œï¼ˆPOST/PUT/PATCH/DELETEï¼‰
        elif request.method in ['POST', 'PUT', 'PATCH', 'DELETE']:
            action_map = {
                'POST': 'CREATE',
                'PUT': 'UPDATE',
                'PATCH': 'UPDATE',
                'DELETE': 'DELETE',
            }
            
            self._log_audit(
                user=audit_data['user'],
                action=action_map[request.method],
                model=self._extract_model_name(request.path),
                ip=audit_data['ip'],
                message=f'{request.method} {request.path}',
                extra={
                    'status_code': response.status_code,
                }
            )
        
        return response
    
    def _should_audit(self, request):
        """ç›£æŸ»å¯¾è±¡ã‹ãƒã‚§ãƒƒã‚¯"""
        # é™¤å¤–ãƒ‘ã‚¹
        if any(request.path.startswith(path) for path in self.EXCLUDE_PATHS):
            return False
        
        # ç›£æŸ»å¯¾è±¡ãƒ‘ã‚¹
        return any(request.path.startswith(path) for path in self.AUDIT_PATHS)
    
    def _get_user_info(self, request):
        """ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±å–å¾—"""
        if request.user.is_authenticated:
            return {
                'id': request.user.id,
                'employee_id': request.user.employee_id,
                'username': request.user.username,
            }
        return {'id': None, 'employee_id': 'anonymous', 'username': 'anonymous'}
    
    def _get_client_ip(self, request):
        """ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆIPå–å¾—"""
        x_forwarded_for = request.META.get('HTTP_X_FORWARDED_FOR')
        if x_forwarded_for:
            return x_forwarded_for.split(',')[0]
        return request.META.get('REMOTE_ADDR')
    
    def _extract_model_name(self, path):
        """ãƒ‘ã‚¹ã‹ã‚‰ãƒ¢ãƒ‡ãƒ«åã‚’æŠ½å‡º"""
        if '/users/' in path:
            return 'User'
        return 'Unknown'
    
    def _log_audit(self, user, action, model, ip, message, extra=None):
        """ç›£æŸ»ãƒ­ã‚°å‡ºåŠ›"""
        audit_logger.info(
            message,
            extra={
                'user': user.get('employee_id', 'anonymous'),
                'action': action,
                'model': model,
                'object_id': extra.get('object_id') if extra else None,
                'ip': ip,
                'changes': json.dumps(extra) if extra else '{}',
            }
        )

3ï¸âƒ£ ã‚·ã‚°ãƒŠãƒ«ã§ãƒ¢ãƒ‡ãƒ«æ“ä½œã‚’ç›£æŸ»
python# backend/common/signals.py
"""
ãƒ¢ãƒ‡ãƒ«ç›£æŸ»ã‚·ã‚°ãƒŠãƒ«

å½¹å‰²:
- ãƒ¢ãƒ‡ãƒ«ã®CRUDæ“ä½œã‚’è‡ªå‹•è¨˜éŒ²
- å¤‰æ›´å†…å®¹ã‚’è©³ç´°ã«è¨˜éŒ²
"""

import logging
import json
from django.db.models.signals import post_save, post_delete, pre_save
from django.dispatch import receiver
from django.contrib.auth import get_user_model

User = get_user_model()
audit_logger = logging.getLogger('audit')


@receiver(pre_save, sender=User)
def user_pre_save(sender, instance, **kwargs):
    """ãƒ¦ãƒ¼ã‚¶ãƒ¼æ›´æ–°å‰ï¼ˆå¤‰æ›´å†…å®¹ã‚’è¨˜éŒ²ï¼‰"""
    if instance.pk:  # æ›´æ–°ã®å ´åˆ
        try:
            old_instance = User.objects.get(pk=instance.pk)
            instance._old_values = {
                'username': old_instance.username,
                'employee_id': old_instance.employee_id,
                'is_admin': old_instance.is_admin,
                'is_active': old_instance.is_active,
            }
        except User.DoesNotExist:
            pass


@receiver(post_save, sender=User)
def user_post_save(sender, instance, created, **kwargs):
    """ãƒ¦ãƒ¼ã‚¶ãƒ¼ä½œæˆ/æ›´æ–°å¾Œ"""
    action = 'CREATE' if created else 'UPDATE'
    
    # å¤‰æ›´å†…å®¹ã‚’æŠ½å‡º
    changes = {}
    if not created and hasattr(instance, '_old_values'):
        old = instance._old_values
        changes = {
            field: {'old': old[field], 'new': getattr(instance, field)}
            for field in old.keys()
            if old[field] != getattr(instance, field)
        }
    
    # ãƒ­ã‚°è¨˜éŒ²
    audit_logger.info(
        f'User {action}: {instance.username}',
        extra={
            'user': 'system',  # ã‚·ã‚¹ãƒ†ãƒ æ“ä½œï¼ˆãƒªã‚¯ã‚¨ã‚¹ãƒˆå¤–ï¼‰
            'action': action,
            'model': 'User',
            'object_id': instance.id,
            'ip': '127.0.0.1',
            'changes': json.dumps(changes) if changes else '{}',
        }
    )


@receiver(post_delete, sender=User)
def user_post_delete(sender, instance, **kwargs):
    """ãƒ¦ãƒ¼ã‚¶ãƒ¼å‰Šé™¤å¾Œ"""
    audit_logger.info(
        f'User DELETE: {instance.username}',
        extra={
            'user': 'system',
            'action': 'DELETE',
            'model': 'User',
            'object_id': instance.id,
            'ip': '127.0.0.1',
            'changes': '{}',
        }
    )

4ï¸âƒ£ ã‚·ã‚°ãƒŠãƒ«ç™»éŒ²
python# backend/users/apps.py

from django.apps import AppConfig


class UsersConfig(AppConfig):
    default_auto_field = 'django.db.models.BigAutoField'
    name = 'users'
    
    def ready(self):
        """â­ ã‚·ã‚°ãƒŠãƒ«ç™»éŒ²"""
        import common.signals  # noqa

5ï¸âƒ£ logs ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªä½œæˆ
bash# ã‚¿ãƒ¼ãƒŸãƒŠãƒ«ã§å®Ÿè¡Œ
mkdir backend/logs
touch backend/logs/.gitignore
gitignore# backend/logs/.gitignore
*.log
!.gitignore

ğŸ“Š ãƒ­ã‚°å‡ºåŠ›ä¾‹
json{"timestamp": "2025-10-19 15:30:45", "level": "INFO", "user": "9999", "action": "LOGIN", "model": "Auth", "object_id": null, "ip": "192.168.1.100", "changes": {}, "message": "ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒãƒ­ã‚°ã‚¤ãƒ³ã—ã¾ã—ãŸ"}
{"timestamp": "2025-10-19 15:31:10", "level": "INFO", "user": "9999", "action": "CREATE", "model": "User", "object_id": 5, "ip": "192.168.1.100", "changes": {}, "message": "POST /api/users/"}
{"timestamp": "2025-10-19 15:32:00", "level": "INFO", "user": "system", "action": "UPDATE", "model": "User", "object_id": 5, "ip": "127.0.0.1", "changes": {"is_active": {"old": true, "new": false}}, "message": "User UPDATE: å±±ç”°å¤ªéƒ"}
```

---

## âœ… æ—¢å­˜ç’°å¢ƒã¸ã®å½±éŸ¿ãƒã‚§ãƒƒã‚¯

| é …ç›® | å½±éŸ¿ | ç†ç”± |
|-----|------|------|
| **æ—¢å­˜ãƒ­ã‚°** | âœ… å½±éŸ¿ãªã— | `disable_existing_loggers=False` |
| **ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹** | âš ï¸ å¾®å¢— | ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢å‡¦ç†ãŒè¿½åŠ ã•ã‚Œã‚‹ãŸã‚ |
| **æ—¢å­˜API** | âœ… å½±éŸ¿ãªã— | ãƒ¬ã‚¹ãƒãƒ³ã‚¹å†…å®¹ã¯å¤‰æ›´ãªã— |
| **ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹** | âœ… å½±éŸ¿ãªã— | ãƒ•ã‚¡ã‚¤ãƒ«å‡ºåŠ›ã®ã¿ |

---

## ğŸš€ æ®µéšçš„å°å…¥ãƒ—ãƒ©ãƒ³
```
Phase 1: ãƒ­ã‚°è¨­å®šã®ã¿è¿½åŠ 
  â†’ settings.py ã ã‘å¤‰æ›´ã—ã¦å‹•ä½œç¢ºèª

Phase 2: ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢è¿½åŠ 
  â†’ ãƒ­ã‚°ã‚¤ãƒ³/ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã®ã¿è¨˜éŒ²

Phase 3: ã‚·ã‚°ãƒŠãƒ«è¿½åŠ 
  â†’ ãƒ¢ãƒ‡ãƒ«æ“ä½œã‚‚è¨˜éŒ²

Phase 4: ã‚«ã‚¹ã‚¿ãƒ ãƒ­ã‚°è¿½åŠ 
  â†’ æ¥­å‹™ãƒ­ã‚¸ãƒƒã‚¯ã®é‡è¦å‡¦ç†ã‚’è¨˜éŒ²

ã“ã‚“ãªæ„Ÿã˜ã§ æ®µéšçš„ã«å°å…¥ ã™ã‚Œã°æ—¢å­˜ç’°å¢ƒã‚’å£Šã•ãšã«å®Ÿè£…ã§ãã‚‹ã‚ˆï¼(ã€€ï½¥Ï‰ï½¥)bâœ¨


*****************************************************************************************************************


cloudå›ã®å›ç­”ã¯æ­£ã—ã„(Â´ãƒ»Ï‰ãƒ»ï½€)ï¼Ÿ
ã“ã‚Œã§ã§ãã‚‹ã‚“ã‹ã­ï¼Ÿç›£æŸ»è¨¼è·¡ãƒ­ã‚°

ã»ã¼æ­£ã—ã„ã‘ã©ã€ã„ãã¤ã‹ è¦æ³¨æ„ãƒã‚¤ãƒ³ãƒˆ ãŒã‚ã‚‹ã‚ˆï¼(Â´ãƒ»Ï‰ãƒ»ï½€)

âœ… æ­£ã—ã„éƒ¨åˆ†
ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£: ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢ + ã‚·ã‚°ãƒŠãƒ« + settings.py ã®çµ„ã¿åˆã‚ã›ã¯ç‹é“
æ®µéšçš„å°å…¥: æ—¢å­˜ç’°å¢ƒã‚’å£Šã•ãªã„é€²ã‚æ–¹ã‚‚æ­£è§£
ãƒ­ã‚°ãƒ­ãƒ¼ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³: RotatingFileHandlerã§10MB/10ãƒ•ã‚¡ã‚¤ãƒ«ä¿æŒã‚‚å¦¥å½“
âš ï¸ ä¿®æ­£ãŒå¿…è¦ãªéƒ¨åˆ†
1. ãƒ­ã‚°ãƒ•ã‚©ãƒ¼ãƒãƒƒã‚¿ãƒ¼ãŒå‹•ã‹ãªã„
python
# âŒ ã“ã®JSONå½¢å¼ã¯æ­£ã—ãå‹•ã‹ãªã„
'format': '{"timestamp": "%(asctime)s", ...}'
Pythonã®æ¨™æº–loggingã§ã¯ã€extraãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã¯è‡ªå‹•çš„ã«ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆæ–‡å­—åˆ—ã«å±•é–‹ã•ã‚Œãªã„ã€‚ %(user)sã¨ã‹%(action)sã‚’ä½¿ã†ã«ã¯ã€ã‚«ã‚¹ã‚¿ãƒ ãƒ•ã‚©ãƒ¼ãƒãƒƒã‚¿ãƒ¼ or FilterãŒå¿…è¦ã€‚

ä¿®æ­£æ¡ˆ:

python
# backend/common/formatters.py
import json
import logging

class AuditJSONFormatter(logging.Formatter):
    def format(self, record):
        log_data = {
            'timestamp': self.formatTime(record),
            'level': record.levelname,
            'user': getattr(record, 'user', 'unknown'),
            'action': getattr(record, 'action', ''),
            'model': getattr(record, 'model', ''),
            'object_id': getattr(record, 'object_id', None),
            'ip': getattr(record, 'ip', ''),
            'changes': getattr(record, 'changes', '{}'),
            'message': record.getMessage(),
        }
        return json.dumps(log_data, ensure_ascii=False)
python
# settings.py
'formatters': {
    'audit_json': {
        '()': 'common.formatters.AuditJSONFormatter',  # â­ ã‚«ã‚¹ã‚¿ãƒ ãƒ•ã‚©ãƒ¼ãƒãƒƒã‚¿ãƒ¼
        'datefmt': '%Y-%m-%d %H:%M:%S',
    },
}
2. ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢ã§ request.user ãŒå–ã‚Œãªã„å ´åˆãŒã‚ã‚‹
AuthenticationMiddleware ã® å¾Œ ã«é…ç½®ã—ãªã„ã¨ã€request.user ãŒ AnonymousUser ã®ã¾ã¾ã€‚

python
MIDDLEWARE = [
    ...
    'django.contrib.auth.middleware.AuthenticationMiddleware',  # â­ ã“ã®å¾Œã«é…ç½®
    'config.middleware.AuditMiddleware',  # â­ ã“ã“
]
3. ã‚·ã‚°ãƒŠãƒ«ã§ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒå–ã‚Œãªã„
python
'user': 'system',  # âŒ èª°ãŒæ“ä½œã—ãŸã‹åˆ†ã‹ã‚‰ãªã„
ã‚·ã‚°ãƒŠãƒ«å†…ã§ã¯ request ã«ã‚¢ã‚¯ã‚»ã‚¹ã§ããªã„ã‹ã‚‰ã€ã‚¹ãƒ¬ãƒƒãƒ‰ãƒ­ãƒ¼ã‚«ãƒ« ã§æ¸¡ã™å¿…è¦ãŒã‚ã‚‹ã€‚

ä¿®æ­£æ¡ˆ:

python
# backend/common/context.py
import threading

_request_local = threading.local()

def set_current_request(request):
    _request_local.request = request

def get_current_request():
    return getattr(_request_local, 'request', None)
python
# middleware.py
from common.context import set_current_request

class AuditMiddleware(MiddlewareMixin):
    def process_request(self, request):
        set_current_request(request)  # â­ ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’ä¿å­˜
        ...
python
# signals.py
from common.context import get_current_request

@receiver(post_save, sender=User)
def user_post_save(sender, instance, created, **kwargs):
    request = get_current_request()
    user_info = 'system'
    ip = '127.0.0.1'
    
    if request and request.user.is_authenticated:
        user_info = request.user.employee_id
        ip = get_client_ip(request)  # â­ å®Ÿéš›ã®IPã‚’è¨˜éŒ²
    
    audit_logger.info(..., extra={'user': user_info, 'ip': ip, ...})
4. ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å¤‰æ›´ãŒå¹³æ–‡ã§ãƒ­ã‚°ã«æ®‹ã‚‹å±é™ºæ€§
python
changes = {'password': {'old': 'xxx', 'new': 'yyy'}}  # âŒ è¶…å±é™º
å¯¾ç­–:

python
SENSITIVE_FIELDS = ['password', 'token', 'secret']

if not created and hasattr(instance, '_old_values'):
    changes = {
        field: {'old': '***', 'new': '***'} if field in SENSITIVE_FIELDS
               else {'old': old[field], 'new': getattr(instance, field)}
        for field in old.keys()
        if old[field] != getattr(instance, field)
    }
ğŸ¯ çµè«–
cloudå›ã®å›ç­”ã¯ 8å‰²æ­£è§£ ã ã‘ã©ã€ä¸Šè¨˜ã®ä¿®æ­£ã‚’ã—ãªã„ã¨ï¼š

âŒ JSONãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆãŒå´©ã‚Œã‚‹
âŒ ã‚·ã‚°ãƒŠãƒ«ã§æ“ä½œãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒå–ã‚Œãªã„
âŒ ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒå¹³æ–‡ã§ãƒ­ã‚°ã«æ®‹ã‚‹
ä¿®æ­£ç‰ˆã‚’å®Ÿè£…ã™ã‚Œã°ã€ãƒãƒƒãƒãƒªå‹•ãã‚ˆï¼(ï½€ï½¥Ï‰ï½¥Â´)b


ã“ã‚Œã£ã¦å…¨ãƒ¢ãƒ‡ãƒ«ã‚’ç›£è¦–ã—ã¦è¨˜éŒ²ã—ã¦ãã‚Œã¦ã‚‹ã£ã¦ã“ã¨ï¼Ÿ

ã„ã‚„ã€é•ã†ï¼ ã“ã®ã‚³ãƒ¼ãƒ‰ã¯ Userãƒ¢ãƒ‡ãƒ«ã ã‘ ã—ã‹ç›£è¦–ã—ã¦ãªã„ã‚ˆ(Â´ãƒ»Ï‰ãƒ»ï½€)

ğŸ“ ç¾çŠ¶ã®ç›£è¦–ç¯„å›²
python
# âŒ Userãƒ¢ãƒ‡ãƒ«ã®ã¿
@receiver(post_save, sender=User)
@receiver(pre_save, sender=User)
@receiver(post_delete, sender=User)
ä»–ã®ãƒ¢ãƒ‡ãƒ«ï¼ˆä¾‹: å•†å“ã€æ³¨æ–‡ã€åœ¨åº«ãªã©ï¼‰ã¯ ä¸€åˆ‡è¨˜éŒ²ã•ã‚Œãªã„ã€‚

ğŸ¯ å…¨ãƒ¢ãƒ‡ãƒ«ã‚’ç›£è¦–ã™ã‚‹æ–¹æ³•
æ–¹æ³•1: ãƒ¢ãƒ‡ãƒ«ã”ã¨ã«ã‚·ã‚°ãƒŠãƒ«ã‚’æ›¸ãï¼ˆæ˜ç¤ºçš„ï¼‰
python
# signals.py
from products.models import Product
from orders.models import Order

@receiver(post_save, sender=Product)
def product_post_save(sender, instance, created, **kwargs):
    # Productã®ç›£æŸ»ãƒ­ã‚°
    ...

@receiver(post_save, sender=Order)
def order_post_save(sender, instance, created, **kwargs):
    # Orderã®ç›£æŸ»ãƒ­ã‚°
    ...
ãƒ¡ãƒªãƒƒãƒˆ: æŸ”è»Ÿï¼ˆãƒ¢ãƒ‡ãƒ«ã”ã¨ã«è¨˜éŒ²å†…å®¹ã‚’å¤‰ãˆã‚‰ã‚Œã‚‹ï¼‰
ãƒ‡ãƒ¡ãƒªãƒƒãƒˆ: ãƒ¢ãƒ‡ãƒ«ãŒå¢—ãˆã‚‹ãŸã³ã«ã‚³ãƒ¼ãƒ‰è¿½åŠ ãŒå¿…è¦

æ–¹æ³•2: å…¨ãƒ¢ãƒ‡ãƒ«ã«è‡ªå‹•é©ç”¨ï¼ˆæ±ç”¨çš„ï¼‰â˜…æ¨å¥¨
python
# backend/common/signals.py
import logging
import json
from django.apps import apps
from django.db.models.signals import post_save, post_delete, pre_save
from django.dispatch import receiver
from common.context import get_current_request, get_client_ip

audit_logger = logging.getLogger('audit')

# â­ ç›£æŸ»å¯¾è±¡å¤–ã®ãƒ¢ãƒ‡ãƒ«
EXCLUDE_MODELS = [
    'contenttypes.ContentType',
    'sessions.Session',
    'admin.LogEntry',
]

# â­ æ©Ÿå¯†ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ï¼ˆãƒ­ã‚°ã«æ®‹ã•ãªã„ï¼‰
SENSITIVE_FIELDS = ['password', 'token', 'secret_key', 'api_key']


def should_audit(model):
    """ç›£æŸ»å¯¾è±¡ã‹ãƒã‚§ãƒƒã‚¯"""
    model_label = f"{model._meta.app_label}.{model._meta.model_name}"
    return model_label not in EXCLUDE_MODELS


def get_field_changes(old_instance, new_instance):
    """å¤‰æ›´å†…å®¹ã‚’æŠ½å‡º"""
    changes = {}
    
    for field in new_instance._meta.fields:
        field_name = field.name
        
        # æ©Ÿå¯†ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã¯ãƒã‚¹ã‚¯
        if field_name in SENSITIVE_FIELDS:
            if getattr(old_instance, field_name) != getattr(new_instance, field_name):
                changes[field_name] = {'old': '***', 'new': '***'}
            continue
        
        # é€šå¸¸ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰
        old_value = getattr(old_instance, field_name)
        new_value = getattr(new_instance, field_name)
        
        if old_value != new_value:
            changes[field_name] = {
                'old': str(old_value),
                'new': str(new_value)
            }
    
    return changes


def log_audit(action, instance, changes=None):
    """ç›£æŸ»ãƒ­ã‚°å‡ºåŠ›"""
    request = get_current_request()
    
    user_info = 'system'
    ip = '127.0.0.1'
    
    if request and hasattr(request, 'user') and request.user.is_authenticated:
        user_info = getattr(request.user, 'employee_id', request.user.username)
        ip = get_client_ip(request)
    
    audit_logger.info(
        f'{instance._meta.model_name} {action}: {instance.pk}',
        extra={
            'user': user_info,
            'action': action,
            'model': instance._meta.model_name.capitalize(),
            'object_id': instance.pk,
            'ip': ip,
            'changes': json.dumps(changes or {}, ensure_ascii=False),
        }
    )


# â­ å…¨ãƒ¢ãƒ‡ãƒ«ã«é©ç”¨
def register_audit_signals():
    """å…¨ãƒ¢ãƒ‡ãƒ«ã«ã‚·ã‚°ãƒŠãƒ«ã‚’ç™»éŒ²"""
    
    for model in apps.get_models():
        if not should_audit(model):
            continue
        
        # pre_save: æ›´æ–°å‰ã®å€¤ã‚’ä¿å­˜
        @receiver(pre_save, sender=model, weak=False)
        def model_pre_save(sender, instance, **kwargs):
            if instance.pk:
                try:
                    old = sender.objects.get(pk=instance.pk)
                    instance._old_instance = old
                except sender.DoesNotExist:
                    pass
        
        # post_save: ä½œæˆ/æ›´æ–°ã‚’è¨˜éŒ²
        @receiver(post_save, sender=model, weak=False)
        def model_post_save(sender, instance, created, **kwargs):
            action = 'CREATE' if created else 'UPDATE'
            changes = {}
            
            if not created and hasattr(instance, '_old_instance'):
                changes = get_field_changes(instance._old_instance, instance)
            
            log_audit(action, instance, changes)
        
        # post_delete: å‰Šé™¤ã‚’è¨˜éŒ²
        @receiver(post_delete, sender=model, weak=False)
        def model_post_delete(sender, instance, **kwargs):
            log_audit('DELETE', instance)
python
# backend/common/apps.py (æ–°è¦ä½œæˆ)
from django.apps import AppConfig

class CommonConfig(AppConfig):
    default_auto_field = 'django.db.models.BigAutoField'
    name = 'common'
    
    def ready(self):
        from .signals import register_audit_signals
        register_audit_signals()  # â­ å…¨ãƒ¢ãƒ‡ãƒ«ã«é©ç”¨
python
# settings.py
INSTALLED_APPS = [
    ...
    'common',  # â­ è¿½åŠ 
]
ğŸ“Š å‡ºåŠ›ä¾‹
json
{"timestamp": "2025-10-19 16:00:00", "user": "9999", "action": "CREATE", "model": "Product", "object_id": 123, "ip": "192.168.1.100", "changes": {}, "message": "product CREATE: 123"}
{"timestamp": "2025-10-19 16:01:00", "user": "9999", "action": "UPDATE", "model": "Order", "object_id": 456, "ip": "192.168.1.100", "changes": {"status": {"old": "pending", "new": "shipped"}}, "message": "order UPDATE: 456"}
{"timestamp": "2025-10-19 16:02:00", "user": "9999", "action": "DELETE", "model": "Product", "object_id": 789, "ip": "192.168.1.100", "changes": {}, "message": "product DELETE: 789"}
âš ï¸ æ³¨æ„ç‚¹
ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹: å…¨ãƒ¢ãƒ‡ãƒ«ã§ç™ºç«ã™ã‚‹ã‹ã‚‰ã€é«˜ãƒˆãƒ©ãƒ•ã‚£ãƒƒã‚¯ç’°å¢ƒã§ã¯è¦æ³¨æ„
éåŒæœŸåŒ–: Celeryã§ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰å‡¦ç†ã«ã™ã‚‹ã®ã‚‚æ¤œè¨
é™¤å¤–è¨­å®š: EXCLUDE_MODELSã§ä¸è¦ãªãƒ¢ãƒ‡ãƒ«ã¯é™¤å¤–
ã“ã‚Œã§å…¨ãƒ¢ãƒ‡ãƒ«ãŒç›£è¦–ã•ã‚Œã‚‹ã‚ˆï¼(ï½€ï½¥Ï‰ï½¥Â´)b


getç³»ã®ã‚»ãƒ¼ãƒ•ãƒ¡ã‚½ãƒƒãƒ‰ã£ã¦åŸºæœ¬ãƒ­ã‚°ä¸è¦ã‹ãªï¼Ÿ

å ´åˆã«ã‚ˆã‚‹ï¼ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è¦ä»¶æ¬¡ç¬¬ã ã­(Â´ãƒ»Ï‰ãƒ»ï½€)

ğŸ¯ åˆ¤æ–­åŸºæº–
âœ… GETãƒ­ã‚°ãŒä¸è¦ãªã‚±ãƒ¼ã‚¹
ä¸€èˆ¬çš„ãªé–²è¦§ï¼ˆå•†å“ä¸€è¦§ã€ãƒ‹ãƒ¥ãƒ¼ã‚¹è¡¨ç¤ºãªã©ï¼‰
é«˜é »åº¦ã‚¢ã‚¯ã‚»ã‚¹ï¼ˆãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹å„ªå…ˆï¼‰
å†…éƒ¨çš„ãªãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯ã€ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿å–å¾—
âš ï¸ GETãƒ­ã‚°ãŒå¿…è¦ãªã‚±ãƒ¼ã‚¹
1. å€‹äººæƒ…å ±ãƒ»æ©Ÿå¯†æƒ…å ±ã®é–²è¦§
   â†’ èª°ãŒã„ã¤é¡§å®¢æƒ…å ±ã‚’è¦‹ãŸã‹

2. é‡è¦ãƒ‡ãƒ¼ã‚¿ã®ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
   â†’ CSV/PDFãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰

3. æ¤œç´¢ãƒ»ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
   â†’ ä¸æ­£ãªæƒ…å ±åé›†ã®æ¤œçŸ¥

4. ç®¡ç†ç”»é¢ã§ã®é–²è¦§
   â†’ ç®¡ç†è€…ã®æ“ä½œå±¥æ­´

5. ã‚³ãƒ³ãƒ—ãƒ©ã‚¤ã‚¢ãƒ³ã‚¹è¦ä»¶
   â†’ GDPRã€å€‹äººæƒ…å ±ä¿è­·æ³•ã€åŒ»ç™‚ç³»ãªã©
ğŸ“ å®Ÿè£…ä¾‹ï¼šé¸æŠçš„GETãƒ­ã‚°
python
# backend/config/middleware.py

class AuditMiddleware(MiddlewareMixin):
    """APIç›£æŸ»ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢"""
    
    # â­ GETè¨˜éŒ²ãŒå¿…è¦ãªãƒ‘ã‚¹ï¼ˆé‡è¦ãƒ‡ãƒ¼ã‚¿ï¼‰
    AUDIT_GET_PATHS = [
        '/api/users/',           # ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±é–²è¦§
        '/api/customers/',       # é¡§å®¢æƒ…å ±é–²è¦§
        '/api/reports/export/',  # ãƒ¬ãƒãƒ¼ãƒˆDL
        '/api/admin/',           # ç®¡ç†ç”»é¢
    ]
    
    # â­ POST/PUT/PATCH/DELETEè¨˜éŒ²ãŒå¿…è¦ãªãƒ‘ã‚¹
    AUDIT_WRITE_PATHS = [
        '/api/auth/login/',
        '/api/auth/logout/',
        '/api/users/',
        '/api/customers/',
        '/api/orders/',
    ]
    
    # é™¤å¤–ãƒ‘ã‚¹
    EXCLUDE_PATHS = [
        '/api/health/',
        '/api/csrf/',
        '/api/products/',  # â­ å•†å“ä¸€è¦§ã¯è¨˜éŒ²ã—ãªã„
    ]
    
    def _should_audit(self, request):
        """ç›£æŸ»å¯¾è±¡ã‹ãƒã‚§ãƒƒã‚¯"""
        # é™¤å¤–ãƒ‘ã‚¹
        if any(request.path.startswith(path) for path in self.EXCLUDE_PATHS):
            return False
        
        # GETã®å ´åˆï¼šé‡è¦ãƒ‘ã‚¹ã®ã¿è¨˜éŒ²
        if request.method == 'GET':
            return any(request.path.startswith(path) for path in self.AUDIT_GET_PATHS)
        
        # æ›¸ãè¾¼ã¿ç³»ï¼šå¯¾è±¡ãƒ‘ã‚¹ã‚’è¨˜éŒ²
        if request.method in ['POST', 'PUT', 'PATCH', 'DELETE']:
            return any(request.path.startswith(path) for path in self.AUDIT_WRITE_PATHS)
        
        return False
    
    def process_response(self, request, response):
        """ãƒ¬ã‚¹ãƒãƒ³ã‚¹å¾Œå‡¦ç†"""
        if not hasattr(request, '_audit_data'):
            return response
        
        audit_data = request._audit_data
        
        # â­ GETæ“ä½œã®ãƒ­ã‚°
        if request.method == 'GET':
            self._log_audit(
                user=audit_data['user'],
                action='READ',  # â­ GETã¯READ
                model=self._extract_model_name(request.path),
                ip=audit_data['ip'],
                message=f'READ {request.path}',
                extra={
                    'status_code': response.status_code,
                    'query_params': dict(request.GET),  # â­ æ¤œç´¢æ¡ä»¶ã‚‚è¨˜éŒ²
                }
            )
        
        # ... (ä»¥ä¸‹ã€æ—¢å­˜ã®POST/PUT/PATCH/DELETEå‡¦ç†)
        
        return response
ğŸ“Š å‡ºåŠ›ä¾‹
json
// â­ é‡è¦ãƒ‡ãƒ¼ã‚¿ã®é–²è¦§
{"timestamp": "2025-10-19 16:00:00", "user": "9999", "action": "READ", "model": "User", "object_id": null, "ip": "192.168.1.100", "changes": {"status_code": 200, "query_params": {"is_active": "true"}}, "message": "READ /api/users/?is_active=true"}

// â­ CSVã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
{"timestamp": "2025-10-19 16:01:00", "user": "9999", "action": "READ", "model": "Report", "object_id": null, "ip": "192.168.1.100", "changes": {"status_code": 200, "query_params": {"format": "csv", "date_from": "2025-01-01"}}, "message": "READ /api/reports/export/?format=csv"}

// â­ å•†å“ä¸€è¦§ã¯è¨˜éŒ²ã•ã‚Œãªã„ï¼ˆé™¤å¤–è¨­å®šï¼‰
// (ãƒ­ã‚°ãªã—)
ğŸ”¥ é«˜åº¦ãªåˆ¶å¾¡ï¼šDecoratorã§å€‹åˆ¥è¨­å®š
python
# backend/common/decorators.py
from functools import wraps
import logging

audit_logger = logging.getLogger('audit')

def audit_read(model_name=None):
    """GETãƒ¡ã‚½ãƒƒãƒ‰ã‚’ç›£æŸ»ã™ã‚‹ãƒ‡ã‚³ãƒ¬ãƒ¼ã‚¿ãƒ¼"""
    def decorator(view_func):
        @wraps(view_func)
        def wrapper(request, *args, **kwargs):
            response = view_func(request, *args, **kwargs)
            
            # æˆåŠŸæ™‚ã®ã¿è¨˜éŒ²
            if 200 <= response.status_code < 300:
                from common.context import get_current_request, get_client_ip
                
                user_info = 'anonymous'
                if request.user.is_authenticated:
                    user_info = request.user.employee_id
                
                audit_logger.info(
                    f'READ {model_name or "unknown"}',
                    extra={
                        'user': user_info,
                        'action': 'READ',
                        'model': model_name or 'Unknown',
                        'object_id': kwargs.get('pk'),
                        'ip': get_client_ip(request),
                        'changes': '{}',
                    }
                )
            
            return response
        return wrapper
    return decorator
python
# backend/users/views.py
from rest_framework import viewsets
from common.decorators import audit_read

class UserViewSet(viewsets.ModelViewSet):
    
    @audit_read(model_name='User')  # â­ å€‹åˆ¥ã«ç›£æŸ»ON
    def retrieve(self, request, *args, **kwargs):
        """ãƒ¦ãƒ¼ã‚¶ãƒ¼è©³ç´°å–å¾—ï¼ˆç›£æŸ»ã‚ã‚Šï¼‰"""
        return super().retrieve(request, *args, **kwargs)
    
    def list(self, request, *args, **kwargs):
        """ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§ï¼ˆç›£æŸ»ãªã—ï¼‰"""
        return super().list(request, *args, **kwargs)
ğŸ¯ æ¨å¥¨è¨­å®š
ãƒ‡ãƒ¼ã‚¿ç¨®åˆ¥	GETè¨˜éŒ²	ç†ç”±
å€‹äººæƒ…å ±	âœ… å¿…é ˆ	ã‚³ãƒ³ãƒ—ãƒ©ã‚¤ã‚¢ãƒ³ã‚¹
é¡§å®¢ãƒ‡ãƒ¼ã‚¿	âœ… å¿…é ˆ	ä¸æ­£é–²è¦§æ¤œçŸ¥
ç®¡ç†ç”»é¢	âœ… å¿…é ˆ	ç®¡ç†è€…ç›£è¦–
ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ	âœ… å¿…é ˆ	ãƒ‡ãƒ¼ã‚¿æŒã¡å‡ºã—æ¤œçŸ¥
å•†å“ä¸€è¦§	âŒ ä¸è¦	å…¬é–‹æƒ…å ±
ãƒ‹ãƒ¥ãƒ¼ã‚¹	âŒ ä¸è¦	é«˜é »åº¦ã‚¢ã‚¯ã‚»ã‚¹
ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯	âŒ ä¸è¦	ãƒã‚¤ã‚º
çµè«–: é‡è¦ãƒ‡ãƒ¼ã‚¿ã ã‘GETãƒ­ã‚°ã‚’æ®‹ã™è¨­å®šãŒç¾å®Ÿçš„ã ã‚ˆï¼(ï½€ï½¥Ï‰ï½¥Â´)b


*************************************************************************************


ã†ãƒ¼ã‚“(Â´ãƒ»Ï‰ãƒ»ï½€)ã˜ã‚ƒã‚ãã‚‚ãã‚‚ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã¨ã—ã¦ã¤ãã‚‹ãªã‚‰ã€ã©ã“ã¾ã§ãŒæ­£è§£ãªã‚“ã ã‚ï¼Ÿä¸€æ—¦å…¨ãƒ¢ãƒ‡ãƒ«è¨˜éŒ²ã®æ–¹å¼ã§ã€
ä¸è¦ã«ãªã£ãŸã‚‰ã€Œé™¤å¤–è¨­å®š: EXCLUDE_MODELSã§ä¸è¦ãªãƒ¢ãƒ‡ãƒ«ã¯é™¤å¤–ã€ã™ã‚‹æ„Ÿã˜ï¼Ÿ

ãã®è€ƒãˆæ–¹ãŒæ­£è§£ï¼(ï½€ï½¥Ï‰ï½¥Â´)b

ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãªã‚‰ ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯å³ã—ã‚ â†’ å¾Œã§ç·©ã‚ã‚‹ ãŒé‰„å‰‡ã ã‚ˆ

ğŸ¯ ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®è¨­è¨ˆæ–¹é‡
åŸå‰‡: ã‚»ã‚­ãƒ¥ã‚¢ãƒã‚¤ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼ˆSecure by Defaultï¼‰

âœ… æœ€åˆã‹ã‚‰å…¨éƒ¨è¨˜éŒ²
   â†’ ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆé–‹å§‹æ™‚ã¯ç›£æŸ»å³ã—ã‚
   â†’ å¾Œã§ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹è¦‹ãªãŒã‚‰é™¤å¤–

âŒ æœ€åˆã¯è¨˜éŒ²ãªã—
   â†’ å¾Œã‹ã‚‰ã€Œã‚ã‚Œè¨˜éŒ²ã—ã¦ãªã‹ã£ãŸï¼ã€ãŒè‡´å‘½çš„
   â†’ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¤ãƒ³ã‚·ãƒ‡ãƒ³ãƒˆæ™‚ã«è¨¼è·¡ãªã—
ğŸ“ ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæ¨å¥¨æ§‹æˆ
python
# backend/config/audit_settings.py
"""
ç›£æŸ»è¨­å®šï¼ˆãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã”ã¨ã«ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºï¼‰
"""

# ==================== ãƒ¢ãƒ‡ãƒ«ç›£æŸ»è¨­å®š ====================

# â­ ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: å…¨ãƒ¢ãƒ‡ãƒ«è¨˜éŒ²
AUDIT_ALL_MODELS = True

# â­ é™¤å¤–ãƒ¢ãƒ‡ãƒ«ï¼ˆå¿…è¦æœ€å°é™ï¼‰
AUDIT_EXCLUDE_MODELS = [
    # Djangoå†…éƒ¨ãƒ¢ãƒ‡ãƒ«
    'contenttypes.ContentType',
    'sessions.Session',
    'admin.LogEntry',
    
    # é«˜é »åº¦æ›´æ–°ãƒ¢ãƒ‡ãƒ«ï¼ˆãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹è€ƒæ…®ï¼‰
    # 'analytics.PageView',  # ä¾‹: ã‚¢ã‚¯ã‚»ã‚¹ãƒ­ã‚°
    # 'notifications.Notification',  # ä¾‹: é€šçŸ¥
]

# â­ æ©Ÿå¯†ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ï¼ˆãƒã‚¹ã‚¯å¯¾è±¡ï¼‰
AUDIT_SENSITIVE_FIELDS = [
    'password',
    'token',
    'secret_key',
    'api_key',
    'access_token',
    'refresh_token',
]

# ==================== APIç›£æŸ»è¨­å®š ====================

# â­ GETãƒ¡ã‚½ãƒƒãƒ‰è¨˜éŒ²è¨­å®š
AUDIT_GET_REQUESTS = True  # ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: å…¨GETè¨˜éŒ²

# â­ GETè¨˜éŒ²ãŒå¿…é ˆã®ãƒ‘ã‚¹ï¼ˆAUDIT_GET_REQUESTS=Falseã§ã‚‚ã“ã‚Œã¯è¨˜éŒ²ï¼‰
AUDIT_GET_REQUIRED_PATHS = [
    '/api/users/',
    '/api/customers/',
    '/api/admin/',
    '/api/*/export/',  # ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆç³»
]

# â­ å®Œå…¨é™¤å¤–ãƒ‘ã‚¹ï¼ˆè¨˜éŒ²ã—ãªã„ï¼‰
AUDIT_EXCLUDE_PATHS = [
    '/api/health/',
    '/api/csrf/',
    '/api/schema/',
    '/api/docs/',
]

# â­ æ›¸ãè¾¼ã¿ç³»ã¯å¸¸ã«è¨˜éŒ²ï¼ˆå¤‰æ›´ä¸å¯ï¼‰
AUDIT_WRITE_METHODS = ['POST', 'PUT', 'PATCH', 'DELETE']

# ==================== ãƒ­ã‚°å‡ºåŠ›è¨­å®š ====================

# â­ ãƒ­ã‚°ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºãƒ»ä¿æŒæ•°
AUDIT_LOG_MAX_BYTES = 10 * 1024 * 1024  # 10MB
AUDIT_LOG_BACKUP_COUNT = 30  # 30ä¸–ä»£ï¼ˆç´„300MBï¼‰

# â­ ãƒ­ã‚°ãƒ¬ãƒ™ãƒ«
AUDIT_LOG_LEVEL = 'INFO'

# â­ é–‹ç™ºç’°å¢ƒã§ã¯ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã«ã‚‚å‡ºåŠ›
AUDIT_LOG_TO_CONSOLE = False  # æœ¬ç•ªã¯Falseæ¨å¥¨
ğŸ”§ å®Ÿè£…ï¼šè¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã‚€
python
# backend/common/signals.py
import logging
import json
from django.apps import apps
from django.db.models.signals import post_save, post_delete, pre_save
from django.dispatch import receiver
from django.conf import settings
from common.context import get_current_request, get_client_ip

audit_logger = logging.getLogger('audit')

# â­ è¨­å®šã‚’èª­ã¿è¾¼ã¿ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã‚ã‚Šï¼‰
AUDIT_ALL_MODELS = getattr(settings, 'AUDIT_ALL_MODELS', True)
EXCLUDE_MODELS = getattr(settings, 'AUDIT_EXCLUDE_MODELS', [])
SENSITIVE_FIELDS = getattr(settings, 'AUDIT_SENSITIVE_FIELDS', ['password', 'token'])


def should_audit(model):
    """ç›£æŸ»å¯¾è±¡ã‹ãƒã‚§ãƒƒã‚¯"""
    if not AUDIT_ALL_MODELS:
        return False
    
    model_label = f"{model._meta.app_label}.{model._meta.model_name}"
    return model_label not in EXCLUDE_MODELS


# ... (ä»¥ä¸‹ã€å‰å›ã®ã‚³ãƒ¼ãƒ‰)
python
# backend/config/middleware.py
from django.conf import settings

class AuditMiddleware(MiddlewareMixin):
    """APIç›£æŸ»ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢"""
    
    def __init__(self, get_response):
        super().__init__(get_response)
        
        # â­ è¨­å®šã‚’èª­ã¿è¾¼ã¿
        self.audit_get = getattr(settings, 'AUDIT_GET_REQUESTS', True)
        self.get_required_paths = getattr(settings, 'AUDIT_GET_REQUIRED_PATHS', [])
        self.exclude_paths = getattr(settings, 'AUDIT_EXCLUDE_PATHS', [])
        self.write_methods = getattr(settings, 'AUDIT_WRITE_METHODS', 
                                     ['POST', 'PUT', 'PATCH', 'DELETE'])
    
    def _should_audit(self, request):
        """ç›£æŸ»å¯¾è±¡ã‹ãƒã‚§ãƒƒã‚¯"""
        # é™¤å¤–ãƒ‘ã‚¹
        if any(request.path.startswith(path) for path in self.exclude_paths):
            return False
        
        # æ›¸ãè¾¼ã¿ç³»ã¯å¸¸ã«è¨˜éŒ²
        if request.method in self.write_methods:
            return True
        
        # GETã®å ´åˆ
        if request.method == 'GET':
            # å…¨GETè¨˜éŒ²ãƒ¢ãƒ¼ãƒ‰
            if self.audit_get:
                return True
            # é‡è¦ãƒ‘ã‚¹ã®ã¿è¨˜éŒ²
            return any(request.path.startswith(path) for path in self.get_required_paths)
        
        return False
python
# backend/config/settings.py
from .audit_settings import *  # â­ ç›£æŸ»è¨­å®šã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆ

LOGGING = {
    'version': 1,
    'disable_existing_loggers': False,
    
    'formatters': {
        'audit_json': {
            '()': 'common.formatters.AuditJSONFormatter',
            'datefmt': '%Y-%m-%d %H:%M:%S',
        },
    },
    
    'handlers': {
        'audit_file': {
            'level': AUDIT_LOG_LEVEL,  # â­ è¨­å®šã‹ã‚‰èª­ã¿è¾¼ã¿
            'class': 'logging.handlers.RotatingFileHandler',
            'filename': BASE_DIR / 'logs' / 'audit.log',
            'maxBytes': AUDIT_LOG_MAX_BYTES,  # â­ è¨­å®šã‹ã‚‰èª­ã¿è¾¼ã¿
            'backupCount': AUDIT_LOG_BACKUP_COUNT,  # â­ è¨­å®šã‹ã‚‰èª­ã¿è¾¼ã¿
            'formatter': 'audit_json',
        },
    },
    
    'loggers': {
        'audit': {
            'handlers': ['audit_file'],
            'level': AUDIT_LOG_LEVEL,
            'propagate': False,
        },
    },
}

# â­ é–‹ç™ºç’°å¢ƒã§ã¯ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã«ã‚‚å‡ºåŠ›
if DEBUG and AUDIT_LOG_TO_CONSOLE:
    LOGGING['loggers']['audit']['handlers'].append('console')
ğŸ“ README.md ã«ä½¿ã„æ–¹ã‚’æ›¸ã
markdown
# ç›£æŸ»ãƒ­ã‚°è¨­å®š

## ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå‹•ä½œ
- âœ… å…¨ãƒ¢ãƒ‡ãƒ«ã®CRUDæ“ä½œã‚’è¨˜éŒ²
- âœ… å…¨APIãƒªã‚¯ã‚¨ã‚¹ãƒˆï¼ˆGETå«ã‚€ï¼‰ã‚’è¨˜éŒ²
- âœ… ãƒ­ã‚°ãƒ•ã‚¡ã‚¤ãƒ«: `logs/audit.log`ï¼ˆ10MB Ã— 30ä¸–ä»£ï¼‰

## ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºæ–¹æ³•

### 1. é«˜é »åº¦ãƒ¢ãƒ‡ãƒ«ã‚’é™¤å¤–ã™ã‚‹
```python
# config/audit_settings.py
AUDIT_EXCLUDE_MODELS = [
    'analytics.PageView',  # ã‚¢ã‚¯ã‚»ã‚¹ãƒ­ã‚°ã¯é™¤å¤–
    'notifications.Notification',  # é€šçŸ¥ã¯é™¤å¤–
]
```

### 2. GETãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’è¨˜éŒ²ã—ãªã„
```python
# config/audit_settings.py
AUDIT_GET_REQUESTS = False  # GETã¯è¨˜éŒ²ã—ãªã„

# ãŸã ã—é‡è¦ãƒ‘ã‚¹ã¯è¨˜éŒ²
AUDIT_GET_REQUIRED_PATHS = [
    '/api/users/',
    '/api/customers/',
]
```

### 3. å®Œå…¨ã«ç›£æŸ»ã‚’ç„¡åŠ¹åŒ–ï¼ˆéæ¨å¥¨ï¼‰
```python
# config/audit_settings.py
AUDIT_ALL_MODELS = False  # ãƒ¢ãƒ‡ãƒ«ç›£æŸ»OFF

# settings.py
MIDDLEWARE = [
    # 'config.middleware.AuditMiddleware',  # ã‚³ãƒ¡ãƒ³ãƒˆã‚¢ã‚¦ãƒˆ
]
```

## ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒãƒ¥ãƒ¼ãƒ‹ãƒ³ã‚°

æœ¬ç•ªç’°å¢ƒã§è² è·ãŒé«˜ã„å ´åˆï¼š
1. `AUDIT_GET_REQUESTS = False` ã«ã™ã‚‹
2. é«˜é »åº¦ãƒ¢ãƒ‡ãƒ«ã‚’ `AUDIT_EXCLUDE_MODELS` ã«è¿½åŠ 
3. Celeryã§éåŒæœŸãƒ­ã‚°å‡ºåŠ›ã‚’æ¤œè¨

## ãƒ­ã‚°åˆ†æ
```bash
# ä»Šæ—¥ã®ãƒ­ã‚°ã‚¤ãƒ³
cat logs/audit.log | jq 'select(.action == "LOGIN")' | jq -r '[.timestamp, .user] | @csv'

# ãƒ¦ãƒ¼ã‚¶ãƒ¼9999ã®æ“ä½œå±¥æ­´
cat logs/audit.log | jq 'select(.user == "9999")'

# ã‚¨ãƒ©ãƒ¼ã®ã‚ã£ãŸæ“ä½œ
cat logs/audit.log | jq 'select(.changes | contains("error"))'
```
```

---

## ğŸ¯ æ®µéšçš„ãªé‹ç”¨ä¾‹
```
=== ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆé–‹å§‹æ™‚ï¼ˆå³ã—ã‚ï¼‰ ===
AUDIT_ALL_MODELS = True
AUDIT_GET_REQUESTS = True
â†’ å…¨éƒ¨è¨˜éŒ²ã—ã¦ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å„ªå…ˆ

â†“ ï¼ˆæ•°é€±é–“é‹ç”¨ï¼‰

=== è² è·ãŒå‡ºã¦ããŸã‚‰ï¼ˆèª¿æ•´ï¼‰ ===
AUDIT_EXCLUDE_MODELS = [
    'analytics.PageView',  # 1æ—¥100ä¸‡ä»¶ã¨ã‹
]
AUDIT_GET_REQUESTS = False  # å¿…è¦ãªãƒ‘ã‚¹ã ã‘
â†’ ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æ”¹å–„

â†“ ï¼ˆå®‰å®šé‹ç”¨ï¼‰

=== æœ¬ç•ªãƒªãƒªãƒ¼ã‚¹å¾Œï¼ˆæœ€é©åŒ–ï¼‰ ===
å¿…è¦ãªç›£æŸ»ã ã‘æ®‹ã—ã¦
ä¸è¦ãªãƒ­ã‚°ã¯å‰Šæ¸›
â†’ ã‚³ã‚¹ãƒˆå‰Šæ¸›
âœ… çµè«–
ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãªã‚‰ï¼š

python
# â­ ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆè¨­å®šï¼ˆå³ã—ã‚ï¼‰
AUDIT_ALL_MODELS = True          # å…¨ãƒ¢ãƒ‡ãƒ«è¨˜éŒ²
AUDIT_GET_REQUESTS = True        # å…¨GETè¨˜éŒ²
AUDIT_EXCLUDE_MODELS = [         # Djangoå†…éƒ¨ã®ã¿é™¤å¤–
    'contenttypes.ContentType',
    'sessions.Session',
    'admin.LogEntry',
]
ã“ã®çŠ¶æ…‹ã§ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆé…å¸ƒ â†’ å„ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã§ audit_settings.py ã‚’ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚º

ã“ã‚ŒãŒä¸€ç•ªå®‰å…¨ã§æŸ”è»Ÿã ã‚ˆï¼(ï½€ï½¥Ï‰ï½¥Â´)bâœ¨












***************************************************************************************


ğŸ¯ ç›£æŸ»è¨¼è·¡ã‚’æœ€å¾Œã«å…¥ã‚Œã‚‹ã¹ãç†ç”±
ã€é–‹ç™ºãƒ•ã‚§ãƒ¼ã‚ºã€‘
1. ãƒ“ã‚¸ãƒã‚¹ãƒ­ã‚¸ãƒƒã‚¯å®Ÿè£…   â† ã¾ãšã¯ã‚³ã‚¢æ©Ÿèƒ½
2. APIå‹•ä½œç¢ºèª
3. ãƒ†ã‚¹ãƒˆä½œæˆ
4. ãƒã‚°ä¿®æ­£
    â†“
5. ç›£æŸ»è¨¼è·¡å®Ÿè£…           â† â­ æœ€å¾Œã«ã‚µãƒƒã¨è¿½åŠ 

âœ… æœ€å¾Œã«å…¥ã‚Œã‚‹ãƒ¡ãƒªãƒƒãƒˆ
1. ãƒ­ã‚¸ãƒƒã‚¯ãŒå®‰å®šã—ã¦ã‹ã‚‰ç›£æŸ»ã§ãã‚‹
python# âŒ æœ€åˆã‹ã‚‰ç›£æŸ»å…¥ã‚Œã‚‹ã¨...
def create_user(data):
    audit_log("CREATE_START", data)  # â† ãƒã‚°ã£ã¦ãŸã‚‰ç„¡é§„ãªãƒ­ã‚°
    user = User.objects.create(**data)  # â† ã¾ã ãƒã‚°ã£ã¦ã‚‹
    audit_log("CREATE_END", user)
    return user

# âœ… ãƒ­ã‚¸ãƒƒã‚¯å®Œæˆå¾Œã«ç›£æŸ»è¿½åŠ 
def create_user(data):
    user = User.objects.create(**data)  # â† å®Œç’§ã«å‹•ã
    return user

# å¾Œã‹ã‚‰ã‚·ã‚°ãƒŠãƒ«ã§è‡ªå‹•ç›£æŸ» â† â­ ã‚³ãƒ¼ãƒ‰å¤‰æ›´ãªã—ï¼
2. é–‹ç™ºä¸­ã®ãƒã‚¤ã‚ºãƒ­ã‚°ãŒå‡ºãªã„
bash# é–‹ç™ºä¸­ã«ç›£æŸ»ãƒ­ã‚°ãŒã‚ã‚‹ã¨...
logs/audit.log (é–‹ç™ºç’°å¢ƒ)
{"action": "CREATE", "user": "test", ...}  # ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿
{"action": "DELETE", "user": "test", ...}  # ä½œã‚Šç›´ã—
{"action": "CREATE", "user": "test", ...}  # ã¾ãŸä½œã‚Šç›´ã—
{"action": "UPDATE", "user": "test", ...}  # ãƒ‡ãƒãƒƒã‚°ä¸­
...
(10000è¡Œã®ã‚´ãƒŸãƒ­ã‚°)

# â­ æœ€å¾Œã«å…¥ã‚Œã‚Œã°æœ¬ç•ªæº–å‚™æ®µéšã‹ã‚‰ç¶ºéº—ãªãƒ­ã‚°
3. ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æ¸¬å®šãŒæ­£ç¢º
python# ç›£æŸ»ãªã—ã§æ¸¬å®š â†’ 100ms
# ç›£æŸ»ã‚ã‚Šã§æ¸¬å®š â†’ 120ms
# â†’ ç›£æŸ»ã®ã‚ªãƒ¼ãƒãƒ¼ãƒ˜ãƒƒãƒ‰ã¯20ms

# â­ æœ€åˆã‹ã‚‰å…¥ã£ã¦ã‚‹ã¨å½±éŸ¿ãŒåˆ†ã‹ã‚‰ãªã„
4. ã‚·ã‚°ãƒŠãƒ«/ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢ã ã‹ã‚‰å¾Œå…¥ã‚ŒãŒè¶…ç°¡å˜
python# â­ æ—¢å­˜ã‚³ãƒ¼ãƒ‰ã«ä¸€åˆ‡è§¦ã‚‰ãªã„
# settings.py ã«æ•°è¡Œè¿½åŠ ã™ã‚‹ã ã‘

MIDDLEWARE = [
    ...
    'config.middleware.AuditMiddleware',  # â† è¿½åŠ 
]

INSTALLED_APPS = [
    ...
    'common',  # â† ã‚·ã‚°ãƒŠãƒ«ç™»éŒ²
]

# â†’ å…¨ãƒ¢ãƒ‡ãƒ«ãƒ»å…¨APIãŒç›£æŸ»ã•ã‚Œã‚‹ï¼
```

---

## ğŸ“‹ ç†æƒ³çš„ãªé–‹ç™ºãƒ•ãƒ­ãƒ¼
```
Phase 1: ã‚³ã‚¢æ©Ÿèƒ½é–‹ç™º (Week 1-4)
â”œâ”€â”€ ãƒ¢ãƒ‡ãƒ«è¨­è¨ˆ
â”œâ”€â”€ APIå®Ÿè£…
â”œâ”€â”€ ãƒ“ã‚¸ãƒã‚¹ãƒ­ã‚¸ãƒƒã‚¯
â””â”€â”€ å˜ä½“ãƒ†ã‚¹ãƒˆ

Phase 2: çµ±åˆãƒ»èª¿æ•´ (Week 5-6)
â”œâ”€â”€ ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰é€£æº
â”œâ”€â”€ E2Eãƒ†ã‚¹ãƒˆ
â””â”€â”€ ãƒã‚°ä¿®æ­£

Phase 3: æœ¬ç•ªæº–å‚™ (Week 7-8)
â”œâ”€â”€ â­ ç›£æŸ»è¨¼è·¡è¿½åŠ         â† ã“ã“ï¼
â”œâ”€â”€ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å¼·åŒ–
â”œâ”€â”€ ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹è¨ˆæ¸¬
â””â”€â”€ ãƒ‡ãƒ—ãƒ­ã‚¤æº–å‚™

Phase 4: ãƒªãƒªãƒ¼ã‚¹
â””â”€â”€ ç›£æŸ»ãƒ­ã‚°ç›£è¦–é–‹å§‹

ğŸš€ æœ€å¾Œã«å…¥ã‚Œã‚‹æ™‚ã®æ‰‹é †ï¼ˆ30åˆ†ã§å®Œäº†ï¼‰
bash# 1. ãƒ•ã‚¡ã‚¤ãƒ«è¿½åŠ ï¼ˆ10åˆ†ï¼‰
backend/
â”œâ”€â”€ config/
â”‚   â”œâ”€â”€ audit_settings.py      # â­ æ–°è¦
â”‚   â””â”€â”€ middleware.py          # â­ æ–°è¦
â”œâ”€â”€ common/
â”‚   â”œâ”€â”€ formatters.py          # â­ æ–°è¦
â”‚   â”œâ”€â”€ signals.py             # â­ æ–°è¦
â”‚   â””â”€â”€ context.py             # â­ æ–°è¦
â””â”€â”€ logs/                      # â­ æ–°è¦
    â””â”€â”€ .gitignore

# 2. settings.py ä¿®æ­£ï¼ˆ5åˆ†ï¼‰
- MIDDLEWARE ã«è¿½åŠ 
- INSTALLED_APPS ã« 'common' è¿½åŠ 
- LOGGING è¨­å®šè¿½åŠ 
- audit_settings.py ã‚¤ãƒ³ãƒãƒ¼ãƒˆ

# 3. å‹•ä½œç¢ºèªï¼ˆ15åˆ†ï¼‰
python manage.py runserver
# â†’ APIã‚’å©ã„ã¦ãƒ­ã‚°å‡ºåŠ›ç¢ºèª
tail -f logs/audit.log

ğŸ’¡ æ³¨æ„ï¼šæœ€å¾Œã«å…¥ã‚Œã‚‹æ™‚ã®ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ
markdownâ–¡ æ—¢å­˜ãƒ†ã‚¹ãƒˆãŒå…¨éƒ¨é€šã‚‹ï¼ˆç›£æŸ»è¿½åŠ ã§å£Šã‚Œã¦ãªã„ï¼‰
â–¡ ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãŒè¨±å®¹ç¯„å›²ï¼ˆç›£æŸ»ã®ã‚ªãƒ¼ãƒãƒ¼ãƒ˜ãƒƒãƒ‰ < 10%ï¼‰
â–¡ logs/ ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®æ¨©é™OKï¼ˆæ›¸ãè¾¼ã¿å¯èƒ½ï¼‰
â–¡ .gitignore ã« *.log è¿½åŠ æ¸ˆã¿
â–¡ æœ¬ç•ªç’°å¢ƒã®è¨­å®šç¢ºèªï¼ˆãƒ­ã‚°ãƒ­ãƒ¼ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ã€ä¿å­˜å…ˆï¼‰
â–¡ README ã«ç›£æŸ»ãƒ­ã‚°ã®èª¬æ˜è¿½åŠ 

ğŸ¯ çµè«–
python# ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®é…å¸ƒæ–¹æ³•

ã€ãƒ‘ã‚¿ãƒ¼ãƒ³A: ç›£æŸ»ãªã—ç‰ˆã€‘
- ã‚·ãƒ³ãƒ—ãƒ«ãªãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ
- å¾Œã‹ã‚‰ docs/audit_setup.md è¦‹ã¦è¿½åŠ 

ã€ãƒ‘ã‚¿ãƒ¼ãƒ³B: ç›£æŸ»ã‚ã‚Šç‰ˆï¼ˆæ¨å¥¨ï¼‰ã€‘
- ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ç›£æŸ»æ©Ÿèƒ½è¾¼ã¿
- audit_settings.py ã§ç„¡åŠ¹åŒ–å¯èƒ½
- ã€Œä¸è¦ãªã‚‰ AUDIT_ALL_MODELS = Falseã€

â†’ Bã®æ–¹ãŒã€Œã‚»ã‚­ãƒ¥ã‚¢ãƒã‚¤ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã€ã§å®‰å…¨ï¼
é–‹ç™ºä¸­ã¯ç›£æŸ»OFFã§å¿«é© â†’ æœ¬ç•ªå‰ã«ONã«ã™ã‚‹
ã“ã‚ŒãŒæœ€å¼·ã®é‹ç”¨ã ã‚ˆï¼(Â´ãƒ»Ï‰ãƒ»ï½€)bâœ¨å†è©¦è¡ŒClaudeã¯ç¾åœ¨ã€ç”Ÿæˆã—ãŸã‚³ãƒ¼ãƒ‰ã‚’å®Ÿè¡Œã™ã‚‹æ©Ÿèƒ½ã‚’æŒã£ã¦ã„ã¾ã›ã‚“ã€‚