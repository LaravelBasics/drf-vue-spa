# Django ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ç›£è¦–ãƒ„ãƒ¼ãƒ«å®Œå…¨ã‚¬ã‚¤ãƒ‰

Djangoã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã‚’ç›£è¦–ã™ã‚‹2ã¤ã®å¿…é ˆãƒ„ãƒ¼ãƒ«ã®ä½¿ã„æ–¹ã‚’ã€å®Ÿéš›ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã§ã®æ¸¬å®šçµæœã‚’äº¤ãˆã¦è§£èª¬ã—ã¾ã™ã€‚

---

## ğŸ“‹ ç›®æ¬¡

1. [ãªãœãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ç›£è¦–ãŒå¿…è¦ï¼Ÿ](#ãªãœãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ç›£è¦–ãŒå¿…è¦)
2. [2ã¤ã®ãƒ„ãƒ¼ãƒ«ã®é•ã„](#2ã¤ã®ãƒ„ãƒ¼ãƒ«ã®é•ã„)
3. [ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«æ–¹æ³•](#ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«æ–¹æ³•)
4. [django-querycountï¼ˆã‚¿ãƒ¼ãƒŸãƒŠãƒ«ç›£è¦–ï¼‰](#django-querycount)
5. [Django Debug Toolbarï¼ˆãƒ–ãƒ©ã‚¦ã‚¶ç›£è¦–ï¼‰](#django-debug-toolbar)
6. [å®Ÿä¾‹ã§å­¦ã¶ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹åˆ†æ](#å®Ÿä¾‹ã§å­¦ã¶ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹åˆ†æ)
7. [ã‚ˆãã‚ã‚‹å•é¡Œã¨è§£æ±ºæ–¹æ³•](#ã‚ˆãã‚ã‚‹å•é¡Œã¨è§£æ±ºæ–¹æ³•)

---

## ãªãœãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ç›£è¦–ãŒå¿…è¦ï¼Ÿ

### é…ã„ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®æœ«è·¯

```
é–‹ç™ºåˆæœŸï¼ˆ100ä»¶ï¼‰
â†’ ã‚µã‚¯ã‚µã‚¯å‹•ã ğŸ˜Š

åŠå¹´å¾Œï¼ˆ10,000ä»¶ï¼‰
â†’ ã¡ã‚‡ã£ã¨é…ã„... ğŸ¤”

1å¹´å¾Œï¼ˆ100,000ä»¶ï¼‰
â†’ ä½¿ã„ç‰©ã«ãªã‚‰ãªã„ ğŸ˜±
```

### å…¸å‹çš„ãªãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹å•é¡Œ

#### âŒ N+1å•é¡Œï¼ˆæœ€ã‚‚å¤šã„ï¼‰
```python
# æ‚ªã„ä¾‹ï¼š101å›ã‚¯ã‚¨ãƒªãŒå®Ÿè¡Œã•ã‚Œã‚‹
users = User.objects.all()  # 1å›
for user in users:
    print(user.profile.name)  # 100å›ï¼

# è‰¯ã„ä¾‹ï¼š2å›ã§æ¸ˆã‚€
users = User.objects.select_related('profile').all()
for user in users:
    print(user.profile.name)
```

#### âŒ ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ãªã—
```python
# employee_idã«ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ãŒãªã„ã¨é…ã„
User.objects.filter(employee_id='12345')
# 100,000ä»¶ã‚’å…¨ä»¶ã‚¹ã‚­ãƒ£ãƒ³ â†’ æ•°ç§’ã‹ã‹ã‚‹
```

#### âŒ ä¸è¦ãªãƒ‡ãƒ¼ã‚¿å–å¾—
```python
# æ‚ªã„ä¾‹ï¼šå…¨ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰å–å¾—
users = User.objects.all()

# è‰¯ã„ä¾‹ï¼šå¿…è¦ãªãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã ã‘
users = User.objects.only('id', 'username')
```

---

## 2ã¤ã®ãƒ„ãƒ¼ãƒ«ã®é•ã„

### ã‚¯ã‚¤ãƒƒã‚¯æ¯”è¼ƒ

| ç‰¹å¾´ | django-querycount | Django Debug Toolbar |
|------|------------------|---------------------|
| **è¡¨ç¤ºå ´æ‰€** | ã‚¿ãƒ¼ãƒŸãƒŠãƒ« | ãƒ–ãƒ©ã‚¦ã‚¶ |
| **è‡ªå‹•è¡¨ç¤º** | âœ… ã¯ã„ | âŒ ã„ã„ãˆï¼ˆã‚¯ãƒªãƒƒã‚¯å¿…è¦ï¼‰ |
| **è©³ç´°åº¦** | ç°¡æ˜“ï¼ˆã‚µãƒãƒªãƒ¼ï¼‰ | è¶…è©³ç´°ï¼ˆSQLå…¨æ–‡ï¼‰ |
| **ç”¨é€”** | æ—¥å¸¸çš„ãªç›£è¦– | è©³ç´°ãªåˆ†æ |
| **é‚ªé­”ã•** | ãªã— | å°‘ã—ã‚ã‚Š |

### ä½¿ã„åˆ†ã‘ã®é‰„å‰‡

```
ğŸ” æ—¥å¸¸é–‹ç™º
â†’ querycount ã‚’è¦‹ãªãŒã‚‰ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°
  ã€ŒTotal queries: 4 in 0.02sã€ â† ã“ã‚Œè¦‹ã‚‹ã ã‘

ğŸ› å•é¡Œç™ºè¦‹æ™‚
â†’ Debug Toolbar ã§è©³ç´°èª¿æŸ»
  ã©ã®ã‚¯ã‚¨ãƒªãŒé‡ã„ã‹ç‰¹å®š
  N+1å•é¡Œã®ç®‡æ‰€ã‚’ç¢ºèª

âœ… ä¿®æ­£å¾Œ
â†’ querycount ã§æ”¹å–„ã‚’ç¢ºèª
  ã€Œ4 queries â†’ 2 queriesã€
```

---

## ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«æ–¹æ³•

### 1. ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«

```bash
pip install django-debug-toolbar django-querycount
```

### 2. settings.py è¨­å®š

```python
# backend/config/settings.py

INSTALLED_APPS = [
    'django.contrib.admin',
    'django.contrib.auth',
    # ... æ—¢å­˜ã®ã‚¢ãƒ—ãƒª ...
    
    # é–‹ç™ºãƒ„ãƒ¼ãƒ«ï¼ˆæœ€å¾Œã«è¿½åŠ ï¼‰
    'debug_toolbar',
]

MIDDLEWARE = [
    'debug_toolbar.middleware.DebugToolbarMiddleware',  # å…ˆé ­ä»˜è¿‘ã«
    'corsheaders.middleware.CorsMiddleware',
    'django.middleware.security.SecurityMiddleware',
    # ... æ—¢å­˜ã®ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢ ...
    'querycount.middleware.QueryCountMiddleware',       # ã©ã“ã§ã‚‚OK
]

# Debug Toolbarè¨­å®š
INTERNAL_IPS = [
    '127.0.0.1',
]

# querycountè¨­å®š
QUERYCOUNT = {
    'THRESHOLDS': {
        'MEDIUM': 50,                   # 50ã‚¯ã‚¨ãƒªã§é»„è‰²è­¦å‘Š
        'HIGH': 200,                    # 200ã‚¯ã‚¨ãƒªã§èµ¤è‰²è­¦å‘Š
        'MIN_TIME_TO_LOG': 0,
        'MIN_QUERY_COUNT_TO_LOG': 0,
    },
    'IGNORE_REQUEST_PATTERNS': [],
    'IGNORE_SQL_PATTERNS': [],
    'DISPLAY_DUPLICATES': 10,
    'RESPONSE_HEADER': 'X-DjangoQueryCount-Count',
}
```

### 3. urls.py è¨­å®šï¼ˆDebug Toolbarã®ã¿ï¼‰

```python
# backend/config/urls.py

from django.urls import path, include
from django.conf import settings

urlpatterns = [
    path('admin/', admin.site.urls),
    path('api/', include('users.urls')),
    # ... æ—¢å­˜ã®URL ...
]

# Debug Toolbarç”¨
if settings.DEBUG:
    import debug_toolbar
    urlpatterns = [
        path('__debug__/', include(debug_toolbar.urls)),
    ] + urlpatterns
```

---

## django-querycount

### åŸºæœ¬çš„ãªè¦‹æ–¹

#### ã‚¿ãƒ¼ãƒŸãƒŠãƒ«å‡ºåŠ›ä¾‹

```bash
$ python manage.py runserver

http://localhost:8000/api/users/?page=1&page_size=10
|------|-----------|----------|----------|----------|------------|
| Type | Database  |   Reads  |  Writes  |  Totals  | Duplicates |
|------|-----------|----------|----------|----------|------------|
| RESP |  default  |    4     |    0     |    4     |     0      |
|------|-----------|----------|----------|----------|------------|
Total queries: 4 in 0.0287s 
```

### å„é …ç›®ã®æ„å‘³

```
Type: RESP
â†’ ãƒ¬ã‚¹ãƒãƒ³ã‚¹ç”Ÿæˆæ™‚ã®ã‚¯ã‚¨ãƒª

Database: default
â†’ ä½¿ç”¨ã—ã¦ã„ã‚‹ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ï¼ˆè¤‡æ•°DBå¯¾å¿œï¼‰

Reads: 4
â†’ SELECTæ–‡ï¼ˆèª­ã¿å–ã‚Šï¼‰ã®å›æ•°

Writes: 0
â†’ INSERT/UPDATE/DELETEï¼ˆæ›¸ãè¾¼ã¿ï¼‰ã®å›æ•°

Totals: 4
â†’ åˆè¨ˆã‚¯ã‚¨ãƒªæ•°

Duplicates: 0
â†’ é‡è¤‡ã‚¯ã‚¨ãƒªã®æ•°ï¼ˆN+1å•é¡Œã®å…†å€™ï¼‰
```

### é€Ÿåº¦ã®ç›®å®‰

```
âœ… 0.01ã€œ0.1ç§’
   â†’ ç¬æ™‚ã€‚å®Œç’§ã€‚

âœ… 0.1ã€œ0.3ç§’
   â†’ é«˜é€Ÿã€‚å•é¡Œãªã—ã€‚

âš ï¸ 0.3ã€œ1ç§’
   â†’ ã¡ã‚‡ã£ã¨é…ã„ã€‚ä½™è£•ãŒã‚ã‚Œã°æ”¹å–„ã€‚

âŒ 1ã€œ3ç§’
   â†’ é…ã„ã€‚æ”¹å–„æ¨å¥¨ã€‚

ğŸ’€ 3ç§’ä»¥ä¸Š
   â†’ è¶…é…ã„ã€‚ä»Šã™ãæ”¹å–„å¿…é ˆã€‚
```

### å®Ÿéš›ã®æ¸¬å®šä¾‹ï¼ˆ89,957ä»¶ã®ãƒ‡ãƒ¼ã‚¿ï¼‰

#### âœ… è‰¯ã„ä¾‹ï¼šãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§

```bash
http://localhost:8000/api/users/?page=8993&page_size=10
Total queries: 4 in 0.0287s

å®Ÿè¡Œã•ã‚ŒãŸã‚¯ã‚¨ãƒª:
1. ã‚»ãƒƒã‚·ãƒ§ãƒ³ç¢ºèª
2. ãƒ¦ãƒ¼ã‚¶ãƒ¼å–å¾—ï¼ˆèªè¨¼ï¼‰
3. ç·ä»¶æ•°ã‚«ã‚¦ãƒ³ãƒˆ
4. 10ä»¶å–å¾—ï¼ˆLIMIT 10 OFFSET 89920ï¼‰

è©•ä¾¡: â­â­â­â­â­
â†’ 9ä¸‡ä»¶ã‚¹ã‚­ãƒƒãƒ—ã—ã¦ã‚‚0.03ç§’ï¼ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ãŒåŠ¹ã„ã¦ã‚‹è¨¼æ‹ 
```

#### âš ï¸ æ³¨æ„ãŒå¿…è¦ãªä¾‹ï¼šç®¡ç†è€…æ•°ã‚«ã‚¦ãƒ³ãƒˆ

```bash
http://localhost:8000/api/users/admin-count/
Total queries: 3 in 0.2062s

å®Ÿè¡Œã•ã‚ŒãŸã‚¯ã‚¨ãƒª:
1. ã‚»ãƒƒã‚·ãƒ§ãƒ³ç¢ºèª
2. ãƒ¦ãƒ¼ã‚¶ãƒ¼å–å¾—
3. ç®¡ç†è€…æ•°ã‚«ã‚¦ãƒ³ãƒˆï¼ˆè¤‡é›‘ãªæ¡ä»¶ï¼‰

è©•ä¾¡: â­â­â­â­
â†’ 0.2ç§’ã¯è¨±å®¹ç¯„å›²ã ãŒã€å¤§è¦æ¨¡ãƒ‡ãƒ¼ã‚¿ãªã‚‰è¦æ”¹å–„
```

#### âœ… è‰¯ã„ä¾‹ï¼šæ¤œç´¢æ©Ÿèƒ½

```bash
http://localhost:8000/api/users/?search=222
Total queries: 4 in 0.0706s

WHERE (employee_id LIKE '222%' OR username LIKE '222%')

è©•ä¾¡: â­â­â­â­â­
â†’ å‰æ–¹ä¸€è‡´ï¼ˆ^ï¼‰ã§ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ãŒåŠ¹ã„ã¦é«˜é€Ÿ
```

### Duplicatesï¼ˆé‡è¤‡ï¼‰ã®è­¦å‘Šã‚µã‚¤ãƒ³

```bash
# å±é™ºãªãƒ‘ã‚¿ãƒ¼ãƒ³
Total queries: 245 in 1.2s
Duplicates: 200  â† ã“ã‚Œï¼

â†’ åŒã˜ã‚¯ã‚¨ãƒªãŒ200å›å®Ÿè¡Œã•ã‚Œã¦ã„ã‚‹
â†’ å…¸å‹çš„ãªN+1å•é¡Œ
```

---

## Django Debug Toolbar

### è¡¨ç¤ºæ–¹æ³•

#### 1. ãƒ–ãƒ©ã‚¦ã‚¶ã§APIã«ã‚¢ã‚¯ã‚»ã‚¹

```
http://localhost:8000/api/users/?page=1&page_size=10
```

#### 2. å³å´ã®ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯

```
ç”»é¢å³ç«¯ã«ã€ŒDjDTã€ãƒœã‚¿ãƒ³ãŒè¡¨ç¤ºã•ã‚Œã‚‹
â€»è¡¨ç¤ºã•ã‚Œãªã„å ´åˆï¼š
  - settings.py ã® INTERNAL_IPS ã‚’ç¢ºèª
  - INTERNAL_IPS = ['127.0.0.1'] ãŒè¨­å®šã•ã‚Œã¦ã„ã‚‹ã‹
```

#### 3. ã‚µã‚¤ãƒ‰ãƒãƒ¼ãŒé–‹ã

```
DjDT
â”œâ”€ Versions       # Djangoãƒãƒ¼ã‚¸ãƒ§ãƒ³
â”œâ”€ Time           # å®Ÿè¡Œæ™‚é–“
â”œâ”€ SQL            # â† ã“ã‚Œã‚’è¦‹ã‚‹ï¼
â”œâ”€ Static files
â”œâ”€ Templates
â””â”€ ...
```

### SQL ãƒ‘ãƒãƒ«ã®è¦‹æ–¹

#### åŸºæœ¬æƒ…å ±

```
SQL queries from 1 connection
4 queries in 20.87ms

Time (ms)  |  SQL
-----------|------------------------------------------
5.2        |  SELECT FROM django_session WHERE...
3.1        |  SELECT FROM users WHERE id = 1...
8.4        |  SELECT COUNT(*) FROM users...
4.1        |  SELECT FROM users ORDER BY id...
```

#### é‡è¤‡ã‚¯ã‚¨ãƒªã®ç¢ºèª

```
Similar queries:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ SELECT FROM users WHERE id = ?  â”‚
â”‚ Executed 3 times                â”‚ â† N+1å•é¡Œã®å¯èƒ½æ€§
â”‚                                 â”‚
â”‚ [1] id = 1                      â”‚
â”‚ [2] id = 2                      â”‚
â”‚ [3] id = 3                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### EXPLAINã§ç¢ºèª

```
å„ã‚¯ã‚¨ãƒªã®æ¨ªã«ã‚ã‚‹ [EXPLAIN] ãƒœã‚¿ãƒ³
â†’ ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹ã¨ã‚¯ã‚¨ãƒªãƒ—ãƒ©ãƒ³ãŒè¦‹ã‚Œã‚‹

ä¾‹:
QUERY PLAN
----------------
Index Scan on users  â† ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ä½¿ç”¨ âœ…
  Index: users_employee_id_idx
  Rows: 1
```

### å®Ÿéš›ã®ä½¿ç”¨ä¾‹

#### ã‚·ãƒŠãƒªã‚ªï¼šãƒ¦ãƒ¼ã‚¶ãƒ¼è©³ç´°ç”»é¢ãŒé…ã„

**Step 1: querycountã§ç•°å¸¸ã‚’æ¤œçŸ¥**
```bash
Total queries: 8 in 0.1299s
Duplicates: 3
```

**Step 2: Debug Toolbarã§è©³ç´°ç¢ºèª**
```
SQL ã‚¿ãƒ–ã‚’é–‹ã

Similar queries: 3 times
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ SELECT * FROM users WHERE id = ? â”‚
â”‚                                  â”‚
â”‚ [1] 0.011s - id = 60             â”‚
â”‚ [2] 0.009s - id = 60  â† åŒã˜IDï¼ â”‚
â”‚ [3] 0.010s - id = 60  â† åŒã˜IDï¼ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

åŸå› : pre_save ã‚·ã‚°ãƒŠãƒ«ã§å†å–å¾—ã—ã¦ã„ã‚‹
```

**Step 3: åˆ¤æ–­**
```
3å›ã®å†…è¨³:
- 1å›ç›®: ViewSet.get_object()
- 2å›ç›®: Serializerå†…éƒ¨
- 3å›ç›®: pre_saveï¼ˆç›£æŸ»ãƒ­ã‚°ç”¨ï¼‰

çµè«–: ç›£æŸ»ãƒ­ã‚°ã®ãŸã‚å¿…è¦ãªå‡¦ç†
      0.13ç§’ãªã‚‰è¨±å®¹ç¯„å›² âœ…
```

---

## å®Ÿä¾‹ã§å­¦ã¶ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹åˆ†æ

### äº‹ä¾‹1ï¼šãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆ89,957ä»¶ï¼‰

#### æ¸¬å®šçµæœ

```bash
# 1ãƒšãƒ¼ã‚¸ç›®
http://localhost:8000/api/users/?page=1&page_size=10
Total queries: 4 in 0.0192s

# 8993ãƒšãƒ¼ã‚¸ç›®ï¼ˆæœ€å¾Œã®æ–¹ï¼‰
http://localhost:8000/api/users/?page=8993&page_size=10
Total queries: 4 in 0.0287s
```

#### å®Ÿè¡Œã•ã‚ŒãŸSQL

```sql
-- 1. ã‚»ãƒƒã‚·ãƒ§ãƒ³ç¢ºèªï¼ˆèªè¨¼ï¼‰
SELECT * FROM django_session WHERE session_key = ?

-- 2. ãƒ­ã‚°ã‚¤ãƒ³ãƒ¦ãƒ¼ã‚¶ãƒ¼å–å¾—
SELECT * FROM users WHERE id = 1

-- 3. ç·ä»¶æ•°ã‚«ã‚¦ãƒ³ãƒˆ
SELECT COUNT(*) FROM users WHERE deleted_at IS NULL

-- 4. ãƒšãƒ¼ã‚¸ãƒ‡ãƒ¼ã‚¿å–å¾—
SELECT * FROM users 
WHERE deleted_at IS NULL 
ORDER BY id ASC 
LIMIT 10 OFFSET 89920
```

#### åˆ†æ

```
âœ… ã‚¯ã‚¨ãƒªæ•°: 4å›ï¼ˆæœ€å°é™ï¼‰
âœ… é€Ÿåº¦: 0.03ç§’ï¼ˆ9ä¸‡ä»¶ã‚¹ã‚­ãƒƒãƒ—ã—ã¦ã‚‚é«˜é€Ÿï¼‰
âœ… N+1å•é¡Œ: ãªã—
âœ… ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹: PRIMARY KEY (id) ãŒåŠ¹ã„ã¦ã„ã‚‹

çµè«–: å®Œç’§ãªå®Ÿè£…
```

### äº‹ä¾‹2ï¼šãƒ¦ãƒ¼ã‚¶ãƒ¼æ›´æ–°ï¼ˆç›£æŸ»ãƒ­ã‚°ã‚ã‚Šï¼‰

#### æ¸¬å®šçµæœ

```bash
http://localhost:8000/api/users/86/
Total queries: 8 in 0.0185s
Duplicates: 3
```

#### å®Ÿè¡Œã•ã‚ŒãŸSQL

```sql
-- ãƒ¦ãƒ¼ã‚¶ãƒ¼å–å¾—ï¼ˆ3å›é‡è¤‡ï¼‰
SELECT * FROM users WHERE id = 86  -- ViewSet
SELECT * FROM users WHERE id = 86  -- Serializer
SELECT * FROM users WHERE id = 86  -- pre_saveï¼ˆç›£æŸ»ãƒ­ã‚°ç”¨ï¼‰

-- é‡è¤‡ãƒã‚§ãƒƒã‚¯
SELECT 1 FROM users 
WHERE employee_id = '31320' 
  AND id != 86

-- ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³
BEGIN
UPDATE users SET username = 'æ©‹æœ¬ç¾ç©‚a' WHERE id = 86
COMMIT
```

#### åˆ†æ

```
âš ï¸ é‡è¤‡: 3å›ï¼ˆç›£æŸ»ãƒ­ã‚°ã®ãŸã‚ï¼‰
âœ… é€Ÿåº¦: 0.02ç§’ï¼ˆè¨±å®¹ç¯„å›²ï¼‰
âœ… ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³: æ­£ã—ãä½¿ç”¨

ç›£æŸ»ãƒ­ã‚°ã®ä¾¡å€¤:
{
  "action": "UPDATE",
  "user": "12345",
  "changes": {
    "username": {
      "old": "æ©‹æœ¬ç¾ç©‚",
      "new": "æ©‹æœ¬ç¾ç©‚a"
    }
  }
}

çµè«–: é‡è¤‡ã‚¯ã‚¨ãƒªã¯å¿…è¦çµŒè²»ã€‚é€Ÿåº¦ã‚‚å•é¡Œãªã—ã€‚
```

### äº‹ä¾‹3ï¼šæ¤œç´¢æ©Ÿèƒ½ï¼ˆå‰æ–¹ä¸€è‡´ï¼‰

#### æ¸¬å®šçµæœ

```bash
http://localhost:8000/api/users/?search=222
Total queries: 4 in 0.0706s
```

#### å®Ÿè¡Œã•ã‚ŒãŸSQL

```sql
-- ã‚«ã‚¦ãƒ³ãƒˆ
SELECT COUNT(*) FROM users 
WHERE deleted_at IS NULL 
  AND (
    employee_id LIKE '222%' 
    OR username LIKE '222%'
  )

-- ãƒ‡ãƒ¼ã‚¿å–å¾—
SELECT * FROM users 
WHERE deleted_at IS NULL 
  AND (
    employee_id LIKE '222%' 
    OR username LIKE '222%'
  )
ORDER BY id ASC 
LIMIT 10
```

#### åˆ†æ

```
âœ… LIKE '222%': å‰æ–¹ä¸€è‡´ï¼ˆã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ä½¿ç”¨ï¼‰
âœ… é€Ÿåº¦: 0.07ç§’
âœ… 9ä¸‡ä»¶ã§ã‚‚é«˜é€Ÿ

ã‚‚ã— LIKE '%222%' ã ã£ãŸã‚‰:
âŒ éƒ¨åˆ†ä¸€è‡´ï¼ˆãƒ•ãƒ«ã‚¹ã‚­ãƒ£ãƒ³ï¼‰
âŒ é€Ÿåº¦: 2ã€œ5ç§’
âŒ ä½¿ã„ç‰©ã«ãªã‚‰ãªã„

çµè«–: å‰æ–¹ä¸€è‡´ï¼ˆ^ï¼‰ã®é¸æŠãŒæ­£è§£
```

---

## ã‚ˆãã‚ã‚‹å•é¡Œã¨è§£æ±ºæ–¹æ³•

### å•é¡Œ1ï¼šN+1å•é¡Œ

#### ç—‡çŠ¶
```bash
Total queries: 245 in 1.2s
Duplicates: 200
```

#### åŸå› 
```python
# æ‚ªã„ä¾‹
users = User.objects.all()
for user in users:
    print(user.profile.name)  # æ¯å›ã‚¯ã‚¨ãƒª
```

#### è§£æ±º
```python
# select_relatedï¼ˆ1å¯¾1, ForeignKeyï¼‰
users = User.objects.select_related('profile').all()

# prefetch_relatedï¼ˆå¤šå¯¾å¤š, é€†å‚ç…§ï¼‰
users = User.objects.prefetch_related('groups').all()
```

### å•é¡Œ2ï¼šé…ã„æ¤œç´¢

#### ç—‡çŠ¶
```bash
http://localhost:8000/api/users/?search=test
Total queries: 4 in 3.5s  â† é…ã„ï¼
```

#### åŸå› 
```python
# settings.py
search_fields = ['employee_id', 'username']  # éƒ¨åˆ†ä¸€è‡´

# å®Ÿè¡Œã•ã‚Œã‚‹SQL
WHERE employee_id LIKE '%test%'  â† ãƒ•ãƒ«ã‚¹ã‚­ãƒ£ãƒ³
```

#### è§£æ±º
```python
# å‰æ–¹ä¸€è‡´ã«å¤‰æ›´
search_fields = ['^employee_id', '^username']

# å®Ÿè¡Œã•ã‚Œã‚‹SQL
WHERE employee_id LIKE 'test%'  â† ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ä½¿ç”¨
```

### å•é¡Œ3ï¼šã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ãŒãªã„

#### ç—‡çŠ¶
```bash
# ç‰¹å®šãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®æ¤œç´¢ãŒé…ã„
User.objects.filter(employee_id='12345')
â†’ 0.5ç§’
```

#### ç¢ºèª
```python
# Debug Toolbar ã® EXPLAIN ã‚’è¦‹ã‚‹
QUERY PLAN
----------------
Seq Scan on users  â† Sequential Scan = ãƒ•ãƒ«ã‚¹ã‚­ãƒ£ãƒ³ï¼ˆé…ã„ï¼‰
```

#### è§£æ±º
```python
# models.py
class User(models.Model):
    employee_id = models.CharField(max_length=50)
    
    class Meta:
        indexes = [
            models.Index(fields=['employee_id']),  # ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹è¿½åŠ 
        ]
```

```bash
python manage.py makemigrations
python manage.py migrate
```

### å•é¡Œ4ï¼šä¸è¦ãªãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰å–å¾—

#### ç—‡çŠ¶
```python
# ä¸€è¦§ã§å…¨ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰å–å¾—
users = User.objects.all()
# SELECT * FROM users  â† é‡ã„
```

#### è§£æ±º
```python
# å¿…è¦ãªãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã ã‘
users = User.objects.only('id', 'username', 'employee_id')
# SELECT id, username, employee_id FROM users

# ã¾ãŸã¯
users = User.objects.defer('password', 'last_login')
# password, last_login ä»¥å¤–ã‚’å–å¾—
```

---

## ã¾ã¨ã‚

### é–‹ç™ºãƒ•ãƒ­ãƒ¼

```
1. ã‚³ãƒ¼ãƒ‰ã‚’æ›¸ã
   â†“
2. querycount ã§ç¢ºèª
   Total queries: 4 in 0.02s â† OK
   â†“
3. ç•°å¸¸ãŒã‚ã‚Œã° Debug Toolbar ã§åˆ†æ
   â†“
4. ä¿®æ­£
   â†“
5. querycount ã§æ”¹å–„ã‚’ç¢ºèª
```

### ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã®é‰„å‰‡

```
âœ… ã‚¯ã‚¨ãƒªæ•°ã¯å°‘ãªãï¼ˆN+1å•é¡Œã‚’é¿ã‘ã‚‹ï¼‰
âœ… ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’æ´»ç”¨
âœ… å‰æ–¹ä¸€è‡´æ¤œç´¢ã‚’å„ªå…ˆ
âœ… å¿…è¦ãªãƒ‡ãƒ¼ã‚¿ã ã‘å–å¾—
âœ… ç›£è¦–ãƒ„ãƒ¼ãƒ«ã§å¸¸ã«ãƒã‚§ãƒƒã‚¯
```

### é€Ÿåº¦ã®åŸºæº–

| é€Ÿåº¦ | è©•ä¾¡ | å¯¾å¿œ |
|------|------|------|
| 0ã€œ0.1ç§’ | â­â­â­â­â­ | å®Œç’§ |
| 0.1ã€œ0.3ç§’ | â­â­â­â­ | è‰¯å¥½ |
| 0.3ã€œ1ç§’ | â­â­â­ | æ”¹å–„æ¨å¥¨ |
| 1ã€œ3ç§’ | â­â­ | è¦æ”¹å–„ |
| 3ç§’ä»¥ä¸Š | â­ | ä»Šã™ãæ”¹å–„ |

---

## å‚è€ƒãƒªãƒ³ã‚¯

- [Django Debug Toolbar å…¬å¼](https://django-debug-toolbar.readthedocs.io/)
- [django-querycount GitHub](https://github.com/bradmontgomery/django-querycount)
- [Django Database Optimization](https://docs.djangoproject.com/en/4.2/topics/db/optimization/)

---

**ä½œæˆæ—¥**: 2025-11-01  
**å¯¾è±¡**: Django 4.2+, Python 3.11+