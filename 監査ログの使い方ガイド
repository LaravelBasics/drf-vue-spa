AIã«ã‚ˆã‚‹è§£èª¬

ãƒ•ã‚©ãƒ«ãƒ€æ§‹æˆ
backend/
â”œâ”€â”€ config/
â”‚   â”œâ”€â”€ settings.py  # â† INSTALLED_APPS ã« 'audit' è¿½åŠ 
â”‚   â””â”€â”€ urls.py
â”œâ”€â”€ audit/           # â† æ–°è¦ä½œæˆã—ãŸã‚¢ãƒ—ãƒª
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ models.py      # AuditLog ãƒ¢ãƒ‡ãƒ«
â”‚   â”œâ”€â”€ middleware.py  # RequestIDMiddleware
â”‚   â”œâ”€â”€ utils.py       # create_audit_log ãªã©
â”‚   â”œâ”€â”€ admin.py       # ç®¡ç†ç”»é¢ç™»éŒ²
â”‚   â””â”€â”€ migrations/
â”œâ”€â”€ users/
â”‚   â”œâ”€â”€ models.py
â”‚   â”œâ”€â”€ views.py       # â† create_audit_log ã‚’å‘¼ã¶
â”‚   â””â”€â”€ services/
â”‚       â””â”€â”€ user_service.py  # â† create_audit_log ã‚’å‘¼ã¶
â””â”€â”€ accounts/
    â””â”€â”€ views.py       # â† create_audit_log ã‚’å‘¼ã¶


ä»•çµ„ã¿ã®æµã‚Œ

# ç›£æŸ»ãƒ­ã‚°ã‚·ã‚¹ãƒ†ãƒ ã®ä½¿ã„æ–¹ã‚¬ã‚¤ãƒ‰

## ğŸ“ ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—æ‰‹é †

### 1. audit ã‚¢ãƒ—ãƒªã‚’ä½œæˆ
```bash
cd backend
python manage.py startapp audit
```

### 2. settings.py ã«è¿½åŠ 
```python
# backend/config/settings.py

INSTALLED_APPS = [
    "django.contrib.admin",
    "django.contrib.auth",
    "django.contrib.contenttypes",
    "django.contrib.sessions",
    "django.contrib.messages",
    "django.contrib.staticfiles",
    
    # ã‚µãƒ¼ãƒ‰ãƒ‘ãƒ¼ãƒ†ã‚£
    "rest_framework",
    "corsheaders",
    "django_filters",
    
    # è‡ªä½œã‚¢ãƒ—ãƒª
    "accounts",
    "users",
    "audit",  # â­ è¿½åŠ 
]

MIDDLEWARE = [
    "corsheaders.middleware.CorsMiddleware",
    "audit.middleware.RequestIDMiddleware",  # â­ è¿½åŠ ï¼ˆæ—©ã‚ã«é…ç½®ï¼‰
    "django.middleware.security.SecurityMiddleware",
    "django.contrib.sessions.middleware.SessionMiddleware",
    "django.middleware.common.CommonMiddleware",
    "django.middleware.csrf.CsrfViewMiddleware",
    "django.contrib.auth.middleware.AuthenticationMiddleware",
    "django.contrib.messages.middleware.MessageMiddleware",
    "django.middleware.clickjacking.XFrameOptionsMiddleware",
]
```

### 3. ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å®Ÿè¡Œ
```bash
python manage.py makemigrations audit
python manage.py migrate audit
```

---

## ğŸ”„ ã‚·ã‚¹ãƒ†ãƒ ã®å‹•ä½œãƒ•ãƒ­ãƒ¼

```
1. ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‹ã‚‰ãƒªã‚¯ã‚¨ã‚¹ãƒˆ
   â†“
2. RequestIDMiddleware ãŒ X-Request-ID ã‚’å–å¾—/ç”Ÿæˆ
   â†“ (ã‚¹ãƒ¬ãƒƒãƒ‰ãƒ­ãƒ¼ã‚«ãƒ«ã«ä¿å­˜)
3. ãƒ“ãƒ¥ãƒ¼ã‚„ã‚µãƒ¼ãƒ“ã‚¹ã§ create_audit_log() ã‚’å‘¼ã¶
   â†“
4. AuditLog ãƒ†ãƒ¼ãƒ–ãƒ«ã«è¨˜éŒ²ã•ã‚Œã‚‹
   â†“
5. ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã« X-Request-ID ãƒ˜ãƒƒãƒ€ãƒ¼ã‚’è¿½åŠ 
```

---

## ğŸ“ åŸºæœ¬çš„ãªä½¿ã„æ–¹

### ãƒ‘ã‚¿ãƒ¼ãƒ³1: ãƒ“ãƒ¥ãƒ¼ã§è¨˜éŒ²ã™ã‚‹

```python
# backend/users/views.py
from audit.utils import create_audit_log

class UserViewSet(viewsets.ModelViewSet):
    
    def destroy(self, request, *args, **kwargs):
        """ãƒ¦ãƒ¼ã‚¶ãƒ¼å‰Šé™¤"""
        instance = self.get_object()
        
        try:
            UserService.delete_user(instance)
            
            # â­ ç›£æŸ»ãƒ­ã‚°ã‚’è¨˜éŒ²
            create_audit_log(
                action='DELETE',
                model_name='User',
                object_id=instance.id,
                request=request  # çœç•¥å¯ï¼ˆè‡ªå‹•å–å¾—ã•ã‚Œã‚‹ï¼‰
            )
            
            return Response(status=status.HTTP_204_NO_CONTENT)
        except ValidationError as e:
            # â­ ã‚¨ãƒ©ãƒ¼ã‚‚è¨˜éŒ²
            create_audit_log(
                action='DELETE',
                model_name='User',
                object_id=instance.id,
                success=False,
                error_message=str(e),
                request=request
            )
            return Response({'detail': str(e)}, status=400)
```

### ãƒ‘ã‚¿ãƒ¼ãƒ³2: ã‚µãƒ¼ãƒ“ã‚¹å±¤ã§è¨˜éŒ²ã™ã‚‹ï¼ˆæ¨å¥¨ï¼‰

```python
# backend/users/services/user_service.py
from audit.utils import create_audit_log, get_model_changes

class UserService:
    
    @staticmethod
    @transaction.atomic
    def update_user(user_instance, validated_data):
        """ãƒ¦ãƒ¼ã‚¶ãƒ¼æ›´æ–°"""
        
        # å¤‰æ›´å†…å®¹ã‚’è¨˜éŒ²
        changes = get_model_changes(user_instance, validated_data)
        
        # ... æ›´æ–°å‡¦ç† ...
        
        # â­ ç›£æŸ»ãƒ­ã‚°ã‚’è¨˜éŒ²ï¼ˆrequest ã¯è‡ªå‹•å–å¾—ï¼‰
        create_audit_log(
            action='UPDATE',
            model_name='User',
            object_id=user_instance.id,
            changes=changes
        )
        
        return user_instance
```

### ãƒ‘ã‚¿ãƒ¼ãƒ³3: ãƒ­ã‚°ã‚¤ãƒ³/ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã§è¨˜éŒ²

```python
# backend/accounts/views.py
from audit.utils import create_audit_log

class LoginAPIView(APIView):
    def post(self, request):
        # ... èªè¨¼å‡¦ç† ...
        
        if user:
            login(request, user)
            
            # â­ ãƒ­ã‚°ã‚¤ãƒ³æˆåŠŸã‚’è¨˜éŒ²
            create_audit_log(
                action='LOGIN',
                model_name='User',
                object_id=user.id
            )
            return Response(...)
        else:
            # â­ ãƒ­ã‚°ã‚¤ãƒ³å¤±æ•—ã‚’è¨˜éŒ²
            create_audit_log(
                action='LOGIN_FAILED',
                model_name='User',
                success=False,
                error_message=f'èªè¨¼å¤±æ•—: {employee_id}'
            )
            return Response(...)
```

---

## ğŸ†• æ–°ã—ã„ãƒ¢ãƒ‡ãƒ«ï¼ˆä¾‹: Productï¼‰ã§ä½¿ã†å ´åˆ

### 1. models.py
```python
# backend/products/models.py
from django.db import models

class Product(models.Model):
    name = models.CharField('å•†å“å', max_length=100)
    price = models.IntegerField('ä¾¡æ ¼')
    stock = models.IntegerField('åœ¨åº«æ•°')
```

### 2. services/product_service.py
```python
# backend/products/services/product_service.py
from audit.utils import create_audit_log, get_model_changes
from django.db import transaction

class ProductService:
    
    @staticmethod
    @transaction.atomic
    def create_product(validated_data):
        """å•†å“ä½œæˆ"""
        product = Product.objects.create(**validated_data)
        
        # â­ ä½œæˆã‚’è¨˜éŒ²
        create_audit_log(
            action='CREATE',
            model_name='Product',
            object_id=product.id,
            changes={'created': validated_data}
        )
        
        return product
    
    @staticmethod
    @transaction.atomic
    def update_product(product_instance, validated_data):
        """å•†å“æ›´æ–°"""
        changes = get_model_changes(product_instance, validated_data)
        
        for attr, value in validated_data.items():
            setattr(product_instance, attr, value)
        product_instance.save()
        
        # â­ æ›´æ–°ã‚’è¨˜éŒ²
        create_audit_log(
            action='UPDATE',
            model_name='Product',
            object_id=product_instance.id,
            changes=changes
        )
        
        return product_instance
    
    @staticmethod
    @transaction.atomic
    def delete_product(product_instance):
        """å•†å“å‰Šé™¤"""
        product_id = product_instance.id
        product_instance.delete()
        
        # â­ å‰Šé™¤ã‚’è¨˜éŒ²
        create_audit_log(
            action='DELETE',
            model_name='Product',
            object_id=product_id
        )
```

### 3. views.py
```python
# backend/products/views.py
from rest_framework import viewsets
from .services.product_service import ProductService

class ProductViewSet(viewsets.ModelViewSet):
    
    def create(self, request, *args, **kwargs):
        serializer = self.get_serializer(data=request.data)
        serializer.is_valid(raise_exception=True)
        
        # ã‚µãƒ¼ãƒ“ã‚¹å±¤ã§ç›£æŸ»ãƒ­ã‚°ã‚‚è¨˜éŒ²ã•ã‚Œã‚‹
        product = ProductService.create_product(serializer.validated_data)
        
        return Response(...)
```

---

## ğŸ“Š è¨˜éŒ²ã•ã‚Œã‚‹æƒ…å ±

### AuditLog ãƒ†ãƒ¼ãƒ–ãƒ«ã®ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰

| ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ | èª¬æ˜ | ä¾‹ |
|-----------|------|-----|
| `request_id` | ãƒªã‚¯ã‚¨ã‚¹ãƒˆè­˜åˆ¥ID | `550e8400-e29b-41d4-a716-446655440000` |
| `user` | å®Ÿè¡Œãƒ¦ãƒ¼ã‚¶ãƒ¼ï¼ˆFKï¼‰ | User ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ |
| `employee_id` | ç¤¾å“¡ç•ªå·ï¼ˆæ–‡å­—åˆ—ï¼‰ | `E001` |
| `username` | ãƒ¦ãƒ¼ã‚¶ãƒ¼å | `å±±ç”°å¤ªéƒ` |
| `action` | ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ | `CREATE`, `UPDATE`, `DELETE`, `LOGIN` |
| `model_name` | ãƒ¢ãƒ‡ãƒ«å | `User`, `Product` |
| `object_id` | ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆID | `123` |
| `changes` | å¤‰æ›´å†…å®¹ï¼ˆJSONï¼‰ | `{"name": {"old": "æ—§", "new": "æ–°"}}` |
| `ip_address` | IPã‚¢ãƒ‰ãƒ¬ã‚¹ | `192.168.1.100` |
| `user_agent` | User Agent | `Mozilla/5.0...` |
| `endpoint` | ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ | `/api/users/1/` |
| `method` | HTTPãƒ¡ã‚½ãƒƒãƒ‰ | `POST`, `PUT`, `DELETE` |
| `success` | æˆåŠŸãƒ•ãƒ©ã‚° | `True` / `False` |
| `error_message` | ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ | `æ¨©é™ãŒã‚ã‚Šã¾ã›ã‚“` |
| `timestamp` | å®Ÿè¡Œæ—¥æ™‚ | `2025-10-10 12:34:56` |

---

## ğŸ” ãƒ­ã‚°ã®ç¢ºèªæ–¹æ³•

### ç®¡ç†ç”»é¢ã§ç¢ºèª
```python
# backend/audit/admin.py
from django.contrib import admin
from .models import AuditLog

@admin.register(AuditLog)
class AuditLogAdmin(admin.ModelAdmin):
    list_display = [
        'timestamp', 'request_id', 'employee_id', 
        'action', 'model_name', 'object_id', 'success'
    ]
    list_filter = ['action', 'model_name', 'success', 'timestamp']
    search_fields = ['request_id', 'employee_id', 'ip_address']
    readonly_fields = ['timestamp']
    date_hierarchy = 'timestamp'
```

### API ã§ç¢ºèªï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
```python
# backend/audit/views.py
from rest_framework import viewsets
from .models import AuditLog
from .serializers import AuditLogSerializer

class AuditLogViewSet(viewsets.ReadOnlyModelViewSet):
    """ç›£æŸ»ãƒ­ã‚°é–²è¦§APIï¼ˆç®¡ç†è€…ã®ã¿ï¼‰"""
    queryset = AuditLog.objects.all()
    serializer_class = AuditLogSerializer
    permission_classes = [IsAuthenticated, IsAdminUser]
    filterset_fields = ['action', 'model_name', 'user', 'success']
    search_fields = ['request_id', 'employee_id', 'endpoint']
    ordering = ['-timestamp']
```

---

## âš¡ ã‚ˆãã‚ã‚‹è³ªå•

### Q1: request ã‚’æ¸¡ã•ãªãã¦ã‚‚å‹•ãã®ï¼Ÿ
**A:** ã¯ã„ï¼`get_current_request()` ãŒã‚¹ãƒ¬ãƒƒãƒ‰ãƒ­ãƒ¼ã‚«ãƒ«ã‹ã‚‰è‡ªå‹•å–å¾—ã—ã¾ã™ã€‚

```python
# ã©ã¡ã‚‰ã§ã‚‚OK
create_audit_log(action='DELETE', model_name='User', object_id=1)
create_audit_log(action='DELETE', model_name='User', object_id=1, request=request)
```

### Q2: X-Request-ID ã¯ã©ã†ã‚„ã£ã¦é€ã‚‹ï¼Ÿ
**A:** ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã§é€ã‚‹ã‹ã€Apache/Nginx ã§è‡ªå‹•ä»˜ä¸ã€‚

```javascript
// Vue axios ã§é€ã‚‹ä¾‹
axios.put('/api/users/1/', data, {
    headers: {
        'X-Request-ID': crypto.randomUUID()
    }
});
```

### Q3: ãƒ­ã‚°ãŒå¤šã™ãã¦é‡ããªã‚‰ãªã„ï¼Ÿ
**A:** ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ãŒå¼µã‚‰ã‚Œã¦ã„ã‚‹ã®ã§é«˜é€Ÿã€‚å¤ã„ãƒ­ã‚°ã¯å®šæœŸå‰Šé™¤æ¨å¥¨ã€‚

```python
# 90æ—¥ä»¥ä¸Šå‰ã®ãƒ­ã‚°ã‚’å‰Šé™¤ï¼ˆç®¡ç†ã‚³ãƒãƒ³ãƒ‰ï¼‰
from django.utils import timezone
from datetime import timedelta

threshold = timezone.now() - timedelta(days=90)
AuditLog.objects.filter(timestamp__lt=threshold).delete()
```

---

## ğŸ¯ ã¾ã¨ã‚

1. **audit ã‚¢ãƒ—ãƒªã‚’ä½œæˆ**ã—ã¦ models.py, middleware.py, utils.py ã‚’é…ç½®
2. **settings.py ã«è¿½åŠ **ï¼ˆINSTALLED_APPS + MIDDLEWAREï¼‰
3. **ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å®Ÿè¡Œ**
4. **ã‚µãƒ¼ãƒ“ã‚¹å±¤ã‚„ãƒ“ãƒ¥ãƒ¼ã§ `create_audit_log()` ã‚’å‘¼ã¶ã ã‘**
5. **ç®¡ç†ç”»é¢ã‚„APIã§ãƒ­ã‚°ã‚’ç¢ºèª**

ã“ã‚Œã§èª°ãŒãƒ»ã„ã¤ãƒ»ä½•ã‚’ãƒ»ã©ã†å¤‰æ›´ã—ãŸã‹ãŒå…¨ã¦è¨˜éŒ²ã•ã‚Œã¾ã™ï¼(Â´ãƒ»Ï‰ãƒ»`)b


--------------------------------------------------------------------------------------
é‡è¦ãƒã‚¤ãƒ³ãƒˆ
1. ã‚¹ãƒ¬ãƒƒãƒ‰ãƒ­ãƒ¼ã‚«ãƒ«ã®ä»•çµ„ã¿

# ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢ã§ä¿å­˜
_thread_locals.request = request
_thread_locals.request_id = request_id

# ã©ã“ã‹ã‚‰ã§ã‚‚å–å¾—å¯èƒ½
def create_audit_log(...):
    request = get_current_request()  # â† è‡ªå‹•ã§å–ã‚Œã‚‹ï¼

2. request å¼•æ•°ã¯çœç•¥å¯èƒ½

# âœ… ã“ã‚Œã§OKï¼ˆæ¨å¥¨ï¼‰
create_audit_log(action='UPDATE', model_name='User', object_id=1)

# âœ… ã“ã‚Œã‚‚OKï¼ˆæ˜ç¤ºçš„ï¼‰
create_audit_log(action='UPDATE', model_name='User', object_id=1, request=request)


3. æ–°ã—ã„ã‚¢ãƒ—ãƒªã§ä½¿ã†ã¨ãã®ãƒ‘ã‚¿ãƒ¼ãƒ³
# products ã‚¢ãƒ—ãƒªã‚’ä½œã£ãŸã‚‰...
from audit.utils import create_audit_log

# ã‚µãƒ¼ãƒ“ã‚¹å±¤ã«è¿½åŠ ã™ã‚‹ã ã‘
ProductService.create_product(...):
    # å‡¦ç†
    create_audit_log(action='CREATE', model_name='Product', object_id=product.id)

